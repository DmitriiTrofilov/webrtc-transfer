<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GhostShare â€” P2P File Transfer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --violet: #7B5CF6;
      --violet-dim: rgba(123,92,246,0.15);
      --cyan: #06B6D4;
      --cyan-dim: rgba(6,182,212,0.15);
      --green: #22c55e;
      --amber: #f59e0b;
      --red: #ef4444;
      --bg: #030610;
      --surface: rgba(255,255,255,0.028);
      --border: rgba(255,255,255,0.07);
      --border-glow: rgba(123,92,246,0.35);
      --text-muted: rgba(255,255,255,0.38);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MINI TAILWIND SHIM (replaces CDN)
       Only the utility classes actually used in the HTML
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .flex          { display: flex; }
    .inline-flex   { display: inline-flex; }
    .items-center  { align-items: center; }
    .items-start   { align-items: flex-start; }
    .justify-center{ justify-content: center; }
    .justify-between{justify-content: space-between; }
    .text-center   { text-align: center; }
    .text-left     { text-align: left; }
    .flex-1        { flex: 1 1 0%; }
    .flex-wrap     { flex-wrap: wrap; }
    .flex-shrink-0 { flex-shrink: 0; }
    .font-bold     { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium   { font-weight: 500; }
    .w-2           { width: 8px; }
    .w-8           { width: 32px; }
    .h-2           { height: 8px; }
    .h-8           { height: 32px; }
    .min-w-0       { min-width: 0; }
    .overflow-hidden { overflow: hidden; }
    .rounded-full  { border-radius: 9999px; }
    .rounded-xl    { border-radius: 12px; }
    .relative      { position: relative; }
    .fixed         { position: fixed; }
    .absolute      { position: absolute; }
    .inset-0       { inset: 0; }
    .z-50          { z-index: 50; }
    .top-0         { top: 0; }
    .left-0        { left: 0; }
    .right-0       { right: 0; }
    .bottom-0      { bottom: 0; }
    .pointer-events-none { pointer-events: none; }
    /* Spacing â€” px-N uses 4px scale */
    .px-4  { padding-left:16px; padding-right:16px; }
    .px-5  { padding-left:20px; padding-right:20px; }
    .py-1\.5 { padding-top:6px; padding-bottom:6px; }
    .py-3  { padding-top:12px; padding-bottom:12px; }
    .mb-6  { margin-bottom:24px; }
    .mb-4  { margin-bottom:16px; }
    .gap-2 { gap:8px; }
    .gap-3 { gap:12px; }
    .gap-4 { gap:16px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *{box-sizing:border-box;margin:0;padding:0;}
    html{scroll-behavior:smooth;}
    body{font-family:'Outfit',sans-serif;background-color:var(--bg);color:#fff;min-height:100vh;overflow-x:hidden;}
    body::before{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        radial-gradient(ellipse 60% 50% at 15% 40%, rgba(123,92,246,0.12) 0%, transparent 70%),
        radial-gradient(ellipse 50% 60% at 85% 20%, rgba(6,182,212,0.08) 0%, transparent 65%),
        radial-gradient(ellipse 40% 40% at 50% 90%, rgba(123,92,246,0.06) 0%, transparent 60%);
    }
    body::after{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),
        linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
      background-size:48px 48px;
      mask-image:radial-gradient(ellipse at center,black 30%,transparent 80%);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLASS & CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .glass{background:var(--surface);border:1px solid var(--border);backdrop-filter:blur(24px);}
    .glass-card{
      background:rgba(255,255,255,0.035);border:1px solid var(--border);
      backdrop-filter:blur(20px);border-radius:16px;transition:border-color 0.3s;
    }
    .glass-card:hover{border-color:var(--border-glow);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn-primary{
      background:linear-gradient(135deg,#6d40f5 0%,#2563eb 100%);
      border:1px solid rgba(109,64,245,0.5);border-radius:12px;
      font-weight:600;cursor:pointer;position:relative;overflow:hidden;color:#fff;
      transition:transform 0.2s,box-shadow 0.3s;
    }
    .btn-primary::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);transition:left 0.45s ease;}
    .btn-primary:hover::before{left:100%;}
    .btn-primary:hover{box-shadow:0 0 28px rgba(109,64,245,0.55),0 4px 20px rgba(0,0,0,0.4);transform:translateY(-1px);}
    .btn-primary:active{transform:translateY(0);}
    .btn-primary:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none;}
    .btn-ghost{background:rgba(255,255,255,0.045);border:1px solid var(--border);border-radius:10px;cursor:pointer;color:#fff;transition:background 0.2s,border-color 0.2s;}
    .btn-ghost:hover{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.14);}
    .btn-pause{background:rgba(234,179,8,0.12);border:1px solid rgba(234,179,8,0.3);border-radius:10px;cursor:pointer;color:#f59e0b;font-weight:600;transition:background 0.2s;}
    .btn-pause:hover{background:rgba(234,179,8,0.2);}
    .btn-resume{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);border-radius:10px;cursor:pointer;color:#22c55e;font-weight:600;transition:background 0.2s;}
    .btn-resume:hover{background:rgba(34,197,94,0.2);}
    .btn-danger{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);border-radius:10px;cursor:pointer;color:#ef4444;font-weight:600;transition:background 0.2s;}
    .btn-danger:hover{background:rgba(239,68,68,0.2);}
    .btn-amber{background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.3);border-radius:10px;cursor:pointer;color:#f59e0b;font-weight:600;transition:background 0.2s;}
    .btn-amber:hover{background:rgba(245,158,11,0.2);}
    .btn-cyan{background:rgba(6,182,212,0.12);border:1px solid rgba(6,182,212,0.3);border-radius:10px;cursor:pointer;color:#06B6D4;font-weight:600;transition:background 0.2s;}
    .btn-cyan:hover{background:rgba(6,182,212,0.2);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TYPOGRAPHY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .mono{font-family:'JetBrains Mono',monospace;}
    .label{font-size:11px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FORMS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    textarea,input[type="text"],input[type="url"],input[type="password"]{
      font-family:'JetBrains Mono',monospace;font-size:11px;
      background:rgba(0,0,0,0.4);border:1px solid var(--border);
      color:rgba(255,255,255,0.8);outline:none;border-radius:10px;
      transition:border-color 0.25s,box-shadow 0.25s;resize:none;
    }
    textarea:focus,input:focus{border-color:rgba(123,92,246,0.5);box-shadow:0 0 0 3px rgba(123,92,246,0.1);}
    textarea::placeholder,input::placeholder{color:rgba(255,255,255,0.2);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOGGLE SWITCH
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toggle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;}
    .toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;}
    .toggle-switch input{opacity:0;width:0;height:0;}
    .toggle-slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:22px;transition:all 0.25s;}
    .toggle-slider:before{content:'';position:absolute;width:16px;height:16px;left:2px;bottom:2px;background:rgba(255,255,255,0.4);border-radius:50%;transition:all 0.25s;}
    input:checked+.toggle-slider{background:rgba(123,92,246,0.35);border-color:rgba(123,92,246,0.5);box-shadow:0 0 10px rgba(123,92,246,0.3);}
    input:checked+.toggle-slider:before{transform:translateX(18px);background:#fff;}
    .toggle-label-text{font-size:13px;font-weight:500;color:rgba(255,255,255,0.8);}
    .toggle-sub{font-size:11px;color:var(--text-muted);margin-top:2px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CODE DISPLAY BOXES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .code-boxes{display:flex;gap:8px;justify-content:center;margin:8px 0;}
    .code-box{
      width:52px;height:64px;display:flex;align-items:center;justify-content:center;
      font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;
      background:rgba(123,92,246,0.1);border:1.5px solid rgba(123,92,246,0.35);
      border-radius:14px;color:#fff;animation:codeGlow 2.5s ease-in-out infinite alternate;
    }
    @keyframes codeGlow{
      from{box-shadow:0 0 8px rgba(123,92,246,0.2);border-color:rgba(123,92,246,0.35);}
      to{box-shadow:0 0 22px rgba(123,92,246,0.55),inset 0 0 8px rgba(123,92,246,0.08);border-color:rgba(123,92,246,0.7);}
    }
    .code-input-field{
      font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;
      letter-spacing:0.35em;text-align:center;text-transform:uppercase;
      padding:18px 24px;background:rgba(0,0,0,0.5);border:1.5px solid var(--border);
      border-radius:16px;width:100%;color:#fff;outline:none;transition:border-color 0.25s,box-shadow 0.25s;
    }
    .code-input-field:focus{border-color:rgba(123,92,246,0.6);box-shadow:0 0 0 4px rgba(123,92,246,0.12),0 0 30px rgba(123,92,246,0.15);}
    .code-input-field::placeholder{color:rgba(255,255,255,0.12);letter-spacing:0.4em;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCREENS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .screen{display:none;position:relative;z-index:1;}
    .screen.active{display:block;animation:fadeUp 0.4s cubic-bezier(0.16,1,0.3,1);}
    @keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes logoPulse{0%,100%{box-shadow:0 0 0 0 rgba(123,92,246,0.5);}50%{box-shadow:0 0 0 10px rgba(123,92,246,0);}}
    .logo-icon{animation:logoPulse 3s ease-in-out infinite;}
    @keyframes connectedPulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.6);}50%{box-shadow:0 0 0 5px rgba(34,197,94,0);}}
    .conn-dot{animation:connectedPulse 2s ease-in-out infinite;}
    @keyframes activePulseRing{0%{transform:scale(0.85);opacity:0.8;}100%{transform:scale(1.5);opacity:0;}}
    @keyframes activePulseDot{0%,100%{transform:scale(1);}50%{transform:scale(1.12);}}
    .pulse-wrap{position:relative;display:flex;align-items:center;justify-content:center;}
    .pulse-ring-el{position:absolute;inset:0;border-radius:50%;animation:activePulseRing 1.8s cubic-bezier(0.215,0.61,0.355,1) infinite;}
    .pulse-core{animation:activePulseDot 2.2s ease-in-out infinite;}
    @keyframes floatY{0%,100%{transform:translateY(0) rotate(-2deg);}50%{transform:translateY(-8px) rotate(2deg);}}
    .float-icon{animation:floatY 4s ease-in-out infinite;}
    @keyframes barPulse{0%,100%{opacity:.8}50%{opacity:1}}
    .speed-bar{animation:barPulse 1.1s ease-in-out infinite;border-radius:3px 3px 0 0;}
    @keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
    .shimmer-text{background:linear-gradient(90deg,#a78bfa,#38bdf8,#a78bfa);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite;}
    @keyframes destructFlash{0%,100%{opacity:1;}50%{opacity:0.3;}}
    .destruct-anim{animation:destructFlash 0.3s ease-in-out 4;}
    @keyframes pairPulse{0%,100%{box-shadow:0 0 0 0 rgba(6,182,212,0.5);}50%{box-shadow:0 0 0 6px rgba(6,182,212,0);}}
    .pair-dot-pulse{animation:pairPulse 2s ease-in-out infinite;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROGRESS RING
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .progress-ring-track{fill:none;stroke:rgba(255,255,255,0.04);stroke-width:7;}
    .progress-ring-fill{fill:none;stroke-width:7;stroke:url(#ringGradient);stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset 0.35s ease;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DROP ZONE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .drop-zone{border:2px dashed rgba(123,92,246,0.3);transition:all 0.3s;cursor:pointer;}
    .drop-zone:hover,.drop-zone.drag-active{border-color:rgba(123,92,246,0.7);background:rgba(123,92,246,0.04);}
    .drop-zone-link{border:2px dashed rgba(6,182,212,0.3);transition:all 0.3s;cursor:pointer;border-radius:16px;}
    .drop-zone-link:hover,.drop-zone-link.drag-active{border-color:rgba(6,182,212,0.7);background:rgba(6,182,212,0.04);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP DOTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .step-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.12);transition:all 0.3s;}
    .step-dot.active{background:var(--violet);box-shadow:0 0 8px rgba(123,92,246,0.7);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIG PANEL (collapsible)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .config-content{overflow:hidden;max-height:0;transition:max-height 0.4s cubic-bezier(0.16,1,0.3,1);}
    .config-content.open{max-height:900px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HASH STATUS BADGES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .hash-ok{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);border-radius:10px;padding:10px 14px;}
    .hash-fail{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:10px;padding:10px 14px;}
    .hash-wait{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);border-radius:10px;padding:10px 14px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODE TOGGLE PILL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .mode-toggle{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:999px;padding:3px;cursor:pointer;user-select:none;}
    .mode-toggle-opt{font-size:11px;font-weight:600;padding:4px 9px;border-radius:999px;transition:all 0.2s;color:var(--text-muted);}
    .mode-toggle-opt.active{background:rgba(123,92,246,0.25);color:#fff;box-shadow:0 0 12px rgba(123,92,246,0.3);}
    .mode-toggle-opt.global.active{background:rgba(6,182,212,0.25);color:#fff;box-shadow:0 0 12px rgba(6,182,212,0.3);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESUME BANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .resume-banner{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:14px;padding:14px 18px;margin-bottom:16px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RECEIVER CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .receiver-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;margin-bottom:8px;transition:border-color 0.3s;}
    .receiver-card.active-xfer{border-color:rgba(123,92,246,0.3);}
    .receiver-card.done-xfer{border-color:rgba(34,197,94,0.3);}
    .mini-bar-track{height:4px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;margin-top:8px;}
    .mini-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#7B5CF6,#2563eb);transition:width 0.35s ease;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LINK PAIR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .link-token-display{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;letter-spacing:0.25em;color:#fff;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECURITY BADGES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .enc-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;
      background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);font-size:10px;font-weight:600;color:#22c55e;}
    .destruct-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;
      background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);font-size:10px;font-weight:600;color:#ef4444;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCROLLBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:rgba(123,92,246,0.4);border-radius:2px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes toastIn{from{opacity:0;transform:translate(-50%,20px);}to{opacity:1;transform:translate(-50%,0);}}
    #toast.visible{animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COLOR BADGES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .badge-violet{background:var(--violet-dim);border:1px solid rgba(123,92,246,0.25);}
    .badge-cyan{background:var(--cyan-dim);border:1px solid rgba(6,182,212,0.25);}
    .badge-green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);}
    .badge-red{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: GLOBAL DRAG OVERLAY
       Full-screen drop target that appears whenever
       any file is dragged over the window.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #global-drop-overlay{
      display:none;position:fixed;inset:0;z-index:9000;
      background:rgba(3,6,16,0.88);backdrop-filter:blur(8px);
      align-items:center;justify-content:center;
      border:3px solid rgba(123,92,246,0.5);
      transition:opacity 0.2s;
    }
    #global-drop-overlay.visible{display:flex;}
    @keyframes dropPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}
    #global-drop-overlay .drop-inner{
      text-align:center;pointer-events:none;
      animation:dropPulse 1.4s ease-in-out infinite;
    }
    #global-drop-overlay .drop-inner .icon{font-size:72px;margin-bottom:16px;}
    #global-drop-overlay .drop-inner .title{font-size:28px;font-weight:900;letter-spacing:-0.03em;}
    #global-drop-overlay .drop-inner .sub{font-size:14px;color:var(--text-muted);margin-top:8px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: CONNECTION GUARD MODAL
       Shown to sender before transfer begins when
       receiver's geolocation is resolved.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #geo-modal{
      display:none;position:fixed;inset:0;z-index:8000;
      background:rgba(3,6,16,0.85);backdrop-filter:blur(12px);
      align-items:center;justify-content:center;padding:24px;
    }
    #geo-modal.visible{display:flex;}
    #geo-modal-card{
      background:rgba(10,14,30,0.95);border:1px solid rgba(123,92,246,0.3);
      border-radius:20px;padding:28px;max-width:420px;width:100%;
      box-shadow:0 0 60px rgba(123,92,246,0.2);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: ON-PAGE LOG PANEL
       Floating bottom-right panel showing real-time
       transfer events. Collapsed by default.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #log-panel{
      position:fixed;bottom:80px;right:16px;z-index:7000;
      width:320px;max-height:320px;
      background:rgba(8,10,24,0.95);border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;backdrop-filter:blur(20px);
      display:flex;flex-direction:column;
      transform:translateY(20px);opacity:0;pointer-events:none;
      transition:transform 0.3s cubic-bezier(0.16,1,0.3,1),opacity 0.3s;
    }
    #log-panel.open{transform:translateY(0);opacity:1;pointer-events:auto;}
    #log-panel-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;
    }
    #log-entries{flex:1;overflow-y:auto;padding:8px 0;min-height:0;}
    .log-entry{display:flex;align-items:flex-start;gap:8px;padding:4px 12px;}
    .log-entry .ts{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-muted);flex-shrink:0;margin-top:2px;}
    .log-entry .msg{font-size:11px;line-height:1.4;color:rgba(255,255,255,0.65);}
    .log-entry.info  .msg{color:rgba(255,255,255,0.65);}
    .log-entry.ok    .msg{color:#22c55e;}
    .log-entry.warn  .msg{color:#f59e0b;}
    .log-entry.error .msg{color:#ef4444;}
    .log-entry.cyan  .msg{color:#06B6D4;}

    /* Log toggle button (fixed bottom right) */
    #log-toggle-btn{
      position:fixed;bottom:24px;right:16px;z-index:7001;
      background:rgba(8,10,24,0.9);border:1px solid rgba(255,255,255,0.1);
      border-radius:999px;padding:8px 14px;cursor:pointer;
      display:flex;align-items:center;gap:7px;
      font-size:11px;font-weight:600;color:rgba(255,255,255,0.6);
      transition:background 0.2s,border-color 0.2s;backdrop-filter:blur(12px);
    }
    #log-toggle-btn:hover{background:rgba(20,24,50,0.95);border-color:rgba(123,92,246,0.4);color:#fff;}
    #log-badge{background:var(--violet);color:#fff;border-radius:999px;padding:1px 6px;font-size:9px;font-weight:700;display:none;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: SEND MODE TABS (Files | Text | Folder)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .send-tab-bar{display:flex;gap:4px;margin-bottom:14px;background:rgba(255,255,255,0.03);
      border:1px solid var(--border);border-radius:12px;padding:4px;}
    .send-tab{flex:1;padding:8px;border:none;background:transparent;cursor:pointer;
      font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;
      color:var(--text-muted);border-radius:8px;transition:all 0.2s;}
    .send-tab.active{background:rgba(123,92,246,0.2);color:#fff;box-shadow:0 0 12px rgba(123,92,246,0.2);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: SECURE TEXT AREA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #text-input-area{
      width:100%;min-height:140px;padding:14px;
      font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;
      background:rgba(0,0,0,0.45);border:1.5px solid rgba(123,92,246,0.25);
      border-radius:14px;color:#fff;resize:vertical;outline:none;
      transition:border-color 0.25s,box-shadow 0.25s;
    }
    #text-input-area:focus{border-color:rgba(123,92,246,0.55);box-shadow:0 0 0 3px rgba(123,92,246,0.1);}
    #text-input-area::placeholder{color:rgba(255,255,255,0.15);}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: RECEIVED TEXT DISPLAY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #recv-text-display{
      background:rgba(6,182,212,0.04);border:1.5px solid rgba(6,182,212,0.2);
      border-radius:14px;padding:16px;
      font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;
      color:rgba(255,255,255,0.82);word-break:break-all;white-space:pre-wrap;
      max-height:300px;overflow-y:auto;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â–¶ NEW: TRANSFER HISTORY PANEL (in landing)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .history-item{
      display:flex;align-items:center;gap:10px;padding:9px 14px;
      border-bottom:1px solid rgba(255,255,255,0.04);font-size:12px;
    }
    .history-item:last-child{border-bottom:none;}
    .history-icon{font-size:16px;flex-shrink:0;}
    .history-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.7);}
    .history-meta{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);flex-shrink:0;}
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–¶ NEW: GLOBAL DRAG-AND-DROP OVERLAY
     Appears any time a file is dragged over the window.
     Handles drops globally and routes to the send flow.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="global-drop-overlay">
  <div class="drop-inner">
    <div class="icon">ğŸ‘»</div>
    <div class="title shimmer-text">Drop to GhostShare!</div>
    <div class="sub">Release to start sending</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–¶ NEW: CONNECTION GUARD MODAL
     Shown to sender when a receiver's country is known.
     Sender can approve or reject the connection.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="geo-modal">
  <div id="geo-modal-card">
    <div style="font-size:22px;font-weight:800;margin-bottom:6px;">ğŸ”’ Connection Request</div>
    <div style="font-size:13px;color:var(--text-muted);margin-bottom:20px;">A receiver wants to download your files</div>
    <div id="geo-modal-body" style="background:rgba(123,92,246,0.06);border:1px solid rgba(123,92,246,0.2);border-radius:12px;padding:16px;margin-bottom:20px;"></div>
    <div style="display:flex;gap:10px;">
      <button id="geo-deny-btn" class="btn-danger" style="flex:1;padding:12px;font-size:13px;">âœ• Deny</button>
      <button id="geo-allow-btn" class="btn-primary" style="flex:1;padding:12px;font-size:13px;">âœ“ Allow Transfer</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–¶ NEW: ON-PAGE LOG PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="log-panel">
  <div id="log-panel-header">
    <span style="font-size:12px;font-weight:600;">ğŸ“‹ Transfer Log</span>
    <div style="display:flex;gap:6px;">
      <button onclick="LOGGER.clear()" style="background:none;border:none;cursor:pointer;font-size:10px;color:var(--text-muted);padding:2px 6px;">Clear</button>
      <button onclick="toggleLogPanel()" style="background:none;border:none;cursor:pointer;font-size:14px;color:var(--text-muted);">âœ•</button>
    </div>
  </div>
  <div id="log-entries"></div>
</div>

<!-- Log toggle button (always visible bottom-right) -->
<button id="log-toggle-btn" onclick="toggleLogPanel()">
  <span>ğŸ“‹ Log</span>
  <span id="log-badge">0</span>
</button>

<!-- â•â• HEADER â•â• -->
<header class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-5 py-3"
  style="background:rgba(3,6,16,0.75);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);">
  <div class="flex items-center gap-3">
    <div class="logo-icon w-8 h-8 rounded-xl flex items-center justify-center"
      style="background:linear-gradient(135deg,#7B5CF6,#2563eb);font-size:16px;">ğŸ‘»</div>
    <span style="font-weight:800;font-size:15px;letter-spacing:-0.02em;">Ghost<span style="color:var(--violet);">Share</span></span>
    <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.2);">v6.0</span>
  </div>

  <div style="display:flex;align-items:center;gap:8px;">
    <!-- Local / Global mode toggle -->
    <div class="mode-toggle" onclick="toggleMode()" title="Local = STUN only Â· Global = adds free TURN relay">
      <div class="mode-toggle-opt active" id="mode-local">ğŸ“¶ Local</div>
      <div class="mode-toggle-opt global" id="mode-global">ğŸŒ Global</div>
    </div>

    <!-- Link pair badge â€” shown when partner is online -->
    <div id="link-badge" style="display:none;align-items:center;gap:6px;padding:5px 11px;border-radius:999px;
      background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);cursor:pointer;" onclick="goHome()">
      <div class="pair-dot-pulse" style="width:7px;height:7px;border-radius:50%;background:#06B6D4;flex-shrink:0;"></div>
      <span style="font-size:11px;font-weight:700;color:#06B6D4;">Paired</span>
    </div>

    <!-- Transfer connected badge -->
    <div id="conn-badge" style="display:none;align-items:center;gap:6px;padding:5px 11px;border-radius:999px;
      background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);">
      <div class="conn-dot w-2 h-2 rounded-full" style="background:#22c55e;"></div>
      <span style="font-size:11px;font-weight:600;color:#22c55e;" id="conn-label">Connected</span>
    </div>
  </div>
</header>

<!-- â•â• MAIN â•â• -->
<main style="padding-top:80px;padding-bottom:64px;padding-left:16px;padding-right:16px;max-width:640px;margin:0 auto;">

  <!-- â•â•â•â• LANDING â•â•â•â• -->
  <div id="screen-landing" class="screen active">
    <div class="text-center" style="padding:36px 0 24px;">
      <div class="inline-flex items-center gap-2 px-4 py-1\.5 rounded-full mb-6"
        style="background:rgba(255,255,255,0.04);border:1px solid var(--border);">
        <span style="width:6px;height:6px;border-radius:50%;background:var(--violet);display:inline-block;box-shadow:0 0 8px var(--violet);"></span>
        <span style="font-size:12px;color:var(--text-muted);">6-char code Â· Zero server Â· Pure P2P</span>
      </div>
      <h1 style="font-size:52px;font-weight:900;letter-spacing:-0.04em;line-height:1.05;margin-bottom:14px;">
        Ghost<span class="shimmer-text">Share</span>
      </h1>
      <p style="color:var(--text-muted);font-size:16px;line-height:1.6;max-width:360px;margin:0 auto 10px;">
        Share a 6-character code. No accounts, no uploads, no limits.
      </p>
      <p style="font-family:'JetBrains Mono';font-size:13px;color:var(--violet);margin-bottom:32px;opacity:0.8;">
        A1B2C3 â†’ instant encrypted transfer
      </p>

      <!-- Send / Receive / Text buttons -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:24px;">
        <button onclick="initSend('files')" class="glass-card text-left" style="padding:18px;cursor:pointer;">
          <div style="width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;
            margin-bottom:12px;background:rgba(123,92,246,0.15);border:1px solid rgba(123,92,246,0.2);font-size:18px;">ğŸ“¤</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:3px;">Send Files</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.4;">Get a code, share it, done</div>
        </button>
        <button onclick="initReceive()" class="glass-card text-left" style="padding:18px;cursor:pointer;">
          <div style="width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;
            margin-bottom:12px;background:rgba(6,182,212,0.12);border:1px solid rgba(6,182,212,0.2);font-size:18px;">ğŸ“¥</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:3px;">Receive</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.4;">Enter a 6-char code</div>
        </button>
        <!-- â–¶ NEW: Text snippet button -->
        <button onclick="initSend('text')" class="glass-card text-left" style="padding:18px;cursor:pointer;">
          <div style="width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;
            margin-bottom:12px;background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.2);font-size:18px;">ğŸ“</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:3px;">Send Text</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.4;">API keys, links, snippets</div>
        </button>
      </div>

      <!-- â–¶ Drag-anywhere hint -->
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:20px;opacity:0.6;">
        ğŸ’¡ Drag files anywhere on this page to start sending
      </div>

      <!-- Permanent Link section -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:20px;text-align:left;">
        <button onclick="toggleConf('link')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;">
            ğŸ”— Permanent Link
            <span id="link-header-badge" style="display:none;" class="badge-cyan" style="padding:2px 8px;border-radius:999px;font-size:10px;font-weight:600;color:#06B6D4;">Active</span>
          </span>
          <span id="chev-link" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">â–¼</span>
        </button>
        <div class="config-content" id="conf-link">
          <div style="padding:0 16px 16px;">
            <div id="link-pair-section"></div>
          </div>
        </div>
      </div>

      <!-- â–¶ NEW: Transfer History -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:20px;text-align:left;">
        <button onclick="toggleConf('history')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;">ğŸ“œ Transfer History</span>
          <span id="chev-history" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">â–¼</span>
        </button>
        <div class="config-content" id="conf-history">
          <div id="history-list" style="padding:0 0 8px;"></div>
        </div>
      </div>

      <!-- Feature badges -->
      <div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center;">
        <span class="badge-violet" style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">ğŸ”’ AES-256-GCM</span>
        <span class="badge-violet" style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">âˆ Unlimited Size</span>
        <span class="badge-cyan"   style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">ğŸ“¡ Firewall Bypass</span>
        <span class="badge-cyan"   style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">ğŸ‘¥ Multi-Receiver</span>
        <span class="badge-green"  style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">ğŸ’¥ Auto-Destruct</span>
        <span class="badge-green"  style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">â¸ Resume on Drop</span>
        <span class="badge-green"  style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">ğŸ“ Secure Text</span>
        <span class="badge-violet" style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">ğŸ“ Folder Upload</span>
      </div>
    </div>
  </div><!-- /screen-landing -->

  <!-- â•â•â•â• SEND â•â•â•â• -->
  <div id="screen-send" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">â† Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;" id="send-screen-title">Send Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Share a 6-char code Â· Multi-receiver</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="sdot-1"></div>
        <div class="step-dot" id="sdot-2"></div>
        <div class="step-dot" id="sdot-3"></div>
      </div>
    </div>

    <!-- SEND STEP 1 -->
    <div id="s-step-1">

      <!-- â–¶ NEW: Send mode tabs -->
      <div class="send-tab-bar">
        <button class="send-tab active" id="tab-files" onclick="setSendMode('files')">ğŸ“¤ Files</button>
        <button class="send-tab" id="tab-folder" onclick="setSendMode('folder')">ğŸ“ Folder</button>
        <button class="send-tab" id="tab-text"   onclick="setSendMode('text')">ğŸ“ Text</button>
      </div>

      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('s')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            ğŸ“¡ Network Config <span style="font-size:11px;color:var(--text-muted);">STUN / TURN</span>
          </span>
          <span id="chev-s" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">â–¼</span>
        </button>
        <div class="config-content" id="conf-s">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Built-in STUN Servers</div>
            <div class="mono glass" style="font-size:10px;line-height:1.8;color:rgba(123,92,246,0.8);padding:10px 12px;border-radius:10px;margin-bottom:14px;">
              stun.l.google.com:19302 Â· stun1.l.google.com:19302<br/>
              stun.cloudflare.com:3478 Â· stun.mozilla.com
            </div>
            <div style="background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.18);border-radius:10px;padding:11px;margin-bottom:12px;">
              <div class="label" style="color:rgba(6,182,212,0.7);margin-bottom:5px;">ğŸŒ Global Mode â€” Free TURN Relays</div>
              <div class="mono" style="font-size:10px;color:rgba(255,255,255,0.4);">openrelay.metered.ca :80 :443 â€” auto-enabled in Global mode</div>
            </div>
            <div class="label" style="margin-bottom:8px;">Custom TURN Relay (optional)</div>
            <input type="url" id="turn-url-s" placeholder="turn:your-server.com:3478" style="width:100%;padding:9px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-s" placeholder="username" style="flex:1;padding:9px 12px;"/>
              <input type="text" id="turn-pass-s" placeholder="password" style="flex:1;padding:9px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Panel -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('sec-s')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            ğŸ” Security
            <span id="sec-s-badges" style="display:flex;gap:4px;"></span>
          </span>
          <span id="chev-sec-s" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">â–¼</span>
        </button>
        <div class="config-content" id="conf-sec-s">
          <div style="padding:0 16px 16px;">
            <!-- AES-GCM Password -->
            <div style="background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.15);border-radius:12px;padding:14px;margin-bottom:12px;">
              <div class="toggle-row">
                <div>
                  <div class="toggle-label-text">ğŸ”‘ Password Protect</div>
                  <div class="toggle-sub">AES-256-GCM Â· encrypted per-chunk</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="enc-toggle" onchange="onEncToggle()"/>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div id="enc-password-wrap" style="display:none;margin-top:10px;">
                <input type="password" id="enc-password" placeholder="Enter passphrase"
                  style="width:100%;padding:10px 12px;"
                  oninput="validateEncPassword()"
                  autocomplete="new-password"/>
                <div id="enc-strength" style="margin-top:6px;font-size:11px;color:var(--text-muted);"></div>
              </div>
            </div>
            <!-- Auto-Destruct -->
            <div style="background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.12);border-radius:12px;padding:14px;margin-bottom:12px;">
              <div class="toggle-row">
                <div>
                  <div class="toggle-label-text">ğŸ’¥ Auto-Destruct</div>
                  <div class="toggle-sub">Destroy session after verified transfer</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="autodestruct-toggle" onchange="onAutoDestructToggle()"/>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p id="autodestruct-hint" style="display:none;font-size:11px;color:rgba(239,68,68,0.7);margin-top:6px;line-height:1.5;">
                Peer ID and connection are permanently revoked the moment the receiver confirms integrity via SHA-256.
              </p>
            </div>
            <!-- â–¶ NEW: Connection Guard Toggle -->
            <div style="background:rgba(6,182,212,0.05);border:1px solid rgba(6,182,212,0.15);border-radius:12px;padding:14px;">
              <div class="toggle-row">
                <div>
                  <div class="toggle-label-text">ğŸŒ Connection Guard</div>
                  <div class="toggle-sub">Approve receivers by country before transfer</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="geo-guard-toggle" onchange="onGeoGuardToggle()"/>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â–¶ FILES mode: Drop Zone -->
      <div id="mode-files">
        <div id="drop-zone" class="drop-zone glass-card"
          style="padding:36px;text-align:center;border-radius:20px;margin-bottom:12px;"
          onclick="pickFiles()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
          <div class="float-icon" style="display:inline-block;margin-bottom:14px;font-size:38px;">ğŸ“„</div>
          <div style="font-size:15px;font-weight:600;margin-bottom:5px;">Drop files or click to browse</div>
          <div style="font-size:12px;color:var(--text-muted);">Any type Â· Any size Â· Multi-file auto-zipped</div>
          <input type="file" id="file-fallback" multiple style="display:none;" onchange="onFileInput(this.files)"/>
        </div>
      </div>

      <!-- â–¶ NEW: FOLDER mode -->
      <div id="mode-folder" style="display:none;">
        <div class="drop-zone glass-card"
          style="padding:36px;text-align:center;border-radius:20px;margin-bottom:12px;cursor:pointer;"
          onclick="pickFolder()">
          <div class="float-icon" style="display:inline-block;margin-bottom:14px;font-size:38px;">ğŸ“</div>
          <div style="font-size:15px;font-weight:600;margin-bottom:5px;">Click to select a folder</div>
          <div style="font-size:12px;color:var(--text-muted);">Directory structure preserved via ZIP</div>
          <input type="file" id="folder-fallback" webkitdirectory multiple style="display:none;" onchange="onFolderInput(this.files)"/>
        </div>
      </div>

      <!-- â–¶ NEW: TEXT mode -->
      <div id="mode-text" style="display:none;">
        <div class="glass-card" style="padding:16px;margin-bottom:12px;">
          <div class="label" style="margin-bottom:10px;">ğŸ“ Text / Code / Secret to share</div>
          <textarea id="text-input-area" placeholder="Paste your API key, URL, code snippet, or any text here...
It will be sent encrypted over WebRTC to the receiver."></textarea>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;">
            <span id="text-char-count" style="font-size:11px;color:var(--text-muted);">0 chars</span>
            <button onclick="pasteFromClipboard()" class="btn-ghost" style="padding:5px 10px;font-size:11px;">ğŸ“‹ Paste</button>
          </div>
        </div>
      </div>

      <!-- File list (shown after selection) -->
      <div id="files-panel" style="display:none;" class="glass-card">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px 0;">
          <div style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;">
            ğŸ“¦ <span id="files-count-lbl">0 files</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="mono" id="files-size-lbl" style="font-size:11px;color:var(--text-muted);"></span>
            <button onclick="clearFiles()" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-muted);padding:2px 6px;">âœ• Clear</button>
          </div>
        </div>
        <div id="files-list" style="padding:10px 16px 14px;max-height:130px;overflow-y:auto;"></div>
      </div>

      <div style="margin-top:14px;">
        <button id="btn-start" onclick="startSenderSession()" disabled class="btn-primary"
          style="width:100%;padding:15px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
          ğŸš€ Generate Code &amp; Start Session
        </button>
      </div>
    </div><!-- /s-step-1 -->

    <!-- SEND STEP 2: show code, wait for receivers -->
    <div id="s-step-2" style="display:none;">
      <div class="glass-card" style="padding:26px;text-align:center;margin-bottom:14px;">
        <div class="label" style="margin-bottom:14px;">ğŸ“¶ Share this code with receivers</div>
        <div class="code-boxes" id="code-display"></div>
        <div id="active-sec-badges" style="display:flex;justify-content:center;gap:6px;margin-top:12px;flex-wrap:wrap;"></div>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:14px;">
          <button onclick="copyCode()" class="btn-ghost" style="padding:7px 14px;font-size:12px;">ğŸ“‹ Copy</button>
          <span class="mono" style="font-size:11px;color:var(--text-muted);">Multiple peers can connect</span>
        </div>
      </div>

      <div class="glass-card" style="padding:18px;margin-bottom:14px;text-align:center;">
        <div class="label" style="margin-bottom:10px;">ğŸ”² QR Code</div>
        <div id="qr-sender" style="display:flex;justify-content:center;"></div>
      </div>

      <div class="glass-card" style="padding:22px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div style="font-size:14px;font-weight:600;">Receivers</div>
          <div id="receiver-count-badge" style="font-size:11px;font-weight:600;color:var(--text-muted);
            background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:999px;padding:3px 10px;">
            0 connected
          </div>
        </div>
        <div id="waiting-indicator" style="text-align:center;padding:16px 0;">
          <div class="pulse-wrap" style="width:44px;height:44px;margin:0 auto 10px;position:relative;">
            <div class="pulse-ring-el" style="background:rgba(123,92,246,0.15);inset:0;position:absolute;border-radius:50%;"></div>
            <div class="pulse-core" style="width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;
              background:rgba(123,92,246,0.2);border:1px solid rgba(123,92,246,0.3);position:relative;z-index:1;font-size:13px;">ğŸ“¶</div>
          </div>
          <div style="font-size:13px;color:var(--text-muted);">Waiting for receivers...</div>
        </div>
        <div id="receivers-list" style="display:none;"></div>
      </div>
    </div><!-- /s-step-2 -->

    <!-- SEND STEP 3: active transfer -->
    <div id="s-step-3" style="display:none;">
      <div id="sender-progress-area"></div>
    </div>
  </div><!-- /screen-send -->

  <!-- â•â•â•â• RECEIVE â•â•â•â• -->
  <div id="screen-receive" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">â† Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Receive Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Enter the sender's 6-char code</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="rdot-1"></div>
        <div class="step-dot" id="rdot-2"></div>
      </div>
    </div>

    <div id="r-step-1">
      <!-- Resume banner -->
      <div id="resume-banner" class="resume-banner" style="display:none;">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:20px;">â¸</span>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:#f59e0b;margin-bottom:2px;">Interrupted Transfer Detected</div>
            <div id="resume-info" style="font-size:12px;color:var(--text-muted);"></div>
          </div>
          <button onclick="clearResume()" class="btn-danger" style="padding:6px 12px;font-size:11px;">Clear</button>
        </div>
      </div>

      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('r')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            ğŸ“¡ Network Config
          </span>
          <span id="chev-r" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">â–¼</span>
        </button>
        <div class="config-content" id="conf-r">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Custom TURN Relay (optional)</div>
            <input type="url" id="turn-url-r" placeholder="turn:openrelay.metered.ca:80" style="width:100%;padding:9px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-r" placeholder="username" style="flex:1;padding:9px 12px;"/>
              <input type="text" id="turn-pass-r" placeholder="password" style="flex:1;padding:9px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <!-- Decryption Password -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('sec-r')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            ğŸ” Decryption Password
            <span style="font-size:11px;color:var(--text-muted);">if sender encrypted</span>
          </span>
          <span id="chev-sec-r" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">â–¼</span>
        </button>
        <div class="config-content" id="conf-sec-r">
          <div style="padding:0 16px 16px;">
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">
              If the sender enabled password protection, enter the same passphrase here before connecting.
            </p>
            <input type="password" id="recv-password" placeholder="Enter passphrase"
              style="width:100%;padding:10px 12px;" autocomplete="current-password"/>
          </div>
        </div>
      </div>

      <!-- Code input -->
      <div class="glass-card" style="padding:22px;margin-bottom:14px;">
        <div class="label" style="margin-bottom:14px;text-align:center;">Enter the sender's code</div>
        <input type="text" id="code-input" class="code-input-field" maxlength="6"
          placeholder="â— â— â— â— â— â—"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');checkCodeReady()"
          onkeydown="if(event.key==='Enter')connectToSender()"/>
        <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:10px;">6 letters and numbers</p>
      </div>

      <button id="btn-connect" onclick="connectToSender()" disabled class="btn-primary"
        style="width:100%;padding:15px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
        ğŸ”— Connect &amp; Receive
      </button>
    </div><!-- /r-step-1 -->

    <!-- RECEIVE STEP 2 -->
    <div id="r-step-2" style="display:none;">
      <div id="recv-progress-area"></div>
    </div>
  </div><!-- /screen-receive -->

</main>

<!-- TOAST -->
<div id="toast" style="display:none;position:fixed;z-index:9999;bottom:70px;left:50%;transform:translateX(-50%);
  background:rgba(10,12,28,0.9);border:1px solid rgba(255,255,255,0.1);
  backdrop-filter:blur(20px);padding:11px 16px;border-radius:14px;
  align-items:center;gap:10px;min-width:200px;max-width:400px;white-space:nowrap;">
  <span id="toast-icon-el" style="font-size:16px;"></span>
  <span id="toast-msg" style="font-size:13px;font-weight:500;"></span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPTS â€” External Libraries
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js" crossorigin="anonymous"></script>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEBUG LOGGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _t0 = performance.now();
function dbg(sec,msg,d){const ts=((performance.now()-_t0)/1e3).toFixed(3);d!==undefined?console.log(`[GS:${sec}] +${ts}s`,msg,d):console.log(`[GS:${sec}] +${ts}s`,msg);}
function dbgWarn(sec,msg,d){const ts=((performance.now()-_t0)/1e3).toFixed(3);console.warn(`[GS:${sec}] âš  +${ts}s`,msg,d||'');}
function dbgErr(sec,msg,e){const ts=((performance.now()-_t0)/1e3).toFixed(3);console.error(`[GS:${sec}] âœ– +${ts}s`,msg,e||'');}
dbg('BOOT','â•â•â•â•â•â•â•â•â•â• GhostShare v6 init â•â•â•â•â•â•â•â•â•â•');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHUNK_SIZE  = 64 * 1024;          // 64 KB per chunk
const HIGH_WATER  = 8  * 1024 * 1024;   // 8 MB backpressure ceiling
const LOW_WATER   = 1  * 1024 * 1024;   // 1 MB backpressure floor
const PEER_RECONNECT_DELAYS = [3000, 6000, 12000, 24000, 30000]; // exponential back-off
const MAX_PEER_RETRIES = 5;

const FREE_TURN_SERVERS = [
  { urls:'turn:openrelay.metered.ca:80' },
  { urls:'turn:openrelay.metered.ca:443' },
  { urls:'turns:openrelay.metered.ca:443' },
  { urls:'turn:openrelay.metered.ca:80?transport=tcp' },
];

const STUN_SERVERS = [
  { urls:'stun:stun.l.google.com:19302'   },
  { urls:'stun:stun1.l.google.com:19302'  },
  { urls:'stun:stun.cloudflare.com:3478'  },
  { urls:'stun:stun.mozilla.com'          },
  { urls:'stun:stun.stunprotocol.org:3478'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â–¶ MODULE: AUDIO CUES
//  Uses Web Audio API to generate simple, non-intrusive tones.
//  No external files needed. Sounds:
//    - "pop"   : played when a receiver connects
//    - "chime" : played when a transfer completes
//    - "error" : played on connection failure
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUDIO = (() => {
  let ctx = null;
  let enabled = true; // user can disable

  function _ctx() {
    if (!ctx) {
      try { ctx = new (window.AudioContext || window.webkitAudioContext)(); }
      catch(e) { return null; }
    }
    // Resume suspended context (browsers suspend on load)
    if (ctx.state === 'suspended') ctx.resume().catch(()=>{});
    return ctx;
  }

  /**
   * Plays a short synthesized tone.
   * @param {number[]} freqs - array of frequencies to play in sequence
   * @param {number} dur     - duration per frequency (seconds)
   * @param {'sine'|'triangle'|'square'} type - oscillator wave type
   * @param {number} gain    - volume 0â€“1
   */
  function _play(freqs, dur=0.08, type='sine', gain=0.12) {
    if (!enabled) return;
    const c = _ctx(); if (!c) return;
    freqs.forEach((freq, i) => {
      const osc  = c.createOscillator();
      const gainN = c.createGain();
      osc.connect(gainN); gainN.connect(c.destination);
      osc.type      = type;
      osc.frequency.setValueAtTime(freq, c.currentTime + i * dur);
      gainN.gain.setValueAtTime(0, c.currentTime + i * dur);
      gainN.gain.linearRampToValueAtTime(gain, c.currentTime + i * dur + 0.01);
      gainN.gain.exponentialRampToValueAtTime(0.001, c.currentTime + i * dur + dur);
      osc.start(c.currentTime + i * dur);
      osc.stop(c.currentTime + i * dur + dur + 0.02);
    });
  }

  /** Subtle pop â€” played when a peer connects */
  function pop()   { _play([880, 1100], 0.06, 'sine', 0.10); }

  /** Two-tone chime â€” played when transfer completes successfully */
  function chime() { _play([523, 659, 784, 1047], 0.1, 'triangle', 0.13); }

  /** Low error buzz */
  function error() { _play([220, 180], 0.12, 'square', 0.08); }

  /** Dismiss / leave tone */
  function bye()   { _play([660, 440], 0.08, 'sine', 0.08); }

  function toggle(val) { enabled = val !== undefined ? val : !enabled; }

  return { pop, chime, error, bye, toggle, get enabled(){ return enabled; } };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â–¶ MODULE: LOGGER
//  Writes to the on-page log panel AND persists events in
//  IndexedDB so the history panel on the landing screen
//  can show past transfers even after a page reload.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOGGER = (() => {
  const MAX_VISIBLE = 120; // max entries shown in the panel
  let   _db     = null;    // set by boot after IDB.init()
  let   _newCount = 0;     // count of unread entries

  function _ts() {
    const d = new Date();
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  }

  /**
   * Write a log entry to the on-page panel.
   * @param {string} msg    - Message text
   * @param {'info'|'ok'|'warn'|'error'|'cyan'} level - styling
   */
  function log(msg, level='info') {
    const entries = document.getElementById('log-entries');
    if (!entries) return;

    const div = document.createElement('div');
    div.className = `log-entry ${level}`;
    div.innerHTML = `<span class="ts">${_ts()}</span><span class="msg">${escHtml(msg)}</span>`;
    entries.appendChild(div);

    // Trim to MAX_VISIBLE
    while (entries.children.length > MAX_VISIBLE) entries.removeChild(entries.firstChild);

    // Auto-scroll to bottom
    entries.scrollTop = entries.scrollHeight;

    // Badge counter (only when panel is closed)
    const panel = document.getElementById('log-panel');
    if (panel && !panel.classList.contains('open')) {
      _newCount++;
      const badge = document.getElementById('log-badge');
      if (badge) { badge.textContent = _newCount > 9 ? '9+' : _newCount; badge.style.display = 'inline'; }
    }

    // Also mirror to console at a lower level
    console.log(`[LOG:${level.toUpperCase()}]`, msg);
  }

  function clear() {
    const entries = document.getElementById('log-entries');
    if (entries) entries.innerHTML = '';
    _newCount = 0;
    const badge = document.getElementById('log-badge');
    if (badge) badge.style.display = 'none';
  }

  function resetBadge() {
    _newCount = 0;
    const badge = document.getElementById('log-badge');
    if (badge) badge.style.display = 'none';
  }

  /**
   * Persist a completed transfer record to IDB for history display.
   * Called by the send/receive completion handlers.
   */
  function saveHistory(record) {
    if (!_db) return;
    try {
      const tx = _db.transaction('history', 'readwrite');
      tx.objectStore('history').put({ ...record, id: Date.now() + Math.random() });
    } catch(e) { dbgWarn('LOGGER','saveHistory failed:',e); }
  }

  /**
   * Load history records and render into #history-list.
   */
  async function renderHistory() {
    const el = document.getElementById('history-list');
    if (!el || !_db) { if(el) el.innerHTML = '<div style="padding:14px;font-size:12px;color:var(--text-muted);text-align:center;">No history yet</div>'; return; }
    const tx  = _db.transaction('history','readonly');
    const req = tx.objectStore('history').getAll();
    req.onsuccess = () => {
      const items = (req.result || []).reverse().slice(0, 50);
      if (!items.length) { el.innerHTML = '<div style="padding:14px;font-size:12px;color:var(--text-muted);text-align:center;">No transfers yet</div>'; return; }
      el.innerHTML = items.map(r => `
        <div class="history-item">
          <span class="history-icon">${r.direction==='send'?'ğŸ“¤':'ğŸ“¥'}</span>
          <span class="history-name" title="${escHtml(r.name)}">${escHtml(r.name)}</span>
          <span class="history-meta">${fmtBytes(r.size)} Â· ${new Date(r.id).toLocaleDateString()}</span>
          <span style="font-size:10px;color:${r.ok?'#22c55e':'#ef4444'};">${r.ok?'âœ“':'âœ—'}</span>
        </div>`).join('');
    };
  }

  function setDb(db) { _db = db; }

  return { log, clear, resetBadge, saveHistory, renderHistory, setDb };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â–¶ MODULE: GEO
//  Fetches the current device's approximate country code
//  from a free, no-auth IP geolocation API.
//  Used by receivers to attach location info to their
//  'hello' handshake so the sender can review it.
//
//  API: https://ipapi.co/json/ (no key required, 1k/day free)
//  Falls back gracefully if the fetch fails.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEO = (() => {
  let _country     = null; // 'US', 'DE', etc. â€” null means unknown
  let _countryName = null; // 'United States'
  let _fetched     = false;

  async function fetch() {
    if (_fetched) return { country:_country, name:_countryName };
    _fetched = true;
    try {
      const r = await Promise.race([
        window.fetch('https://ipapi.co/json/'),
        new Promise((_,rej) => setTimeout(()=>rej(new Error('timeout')), 4000)),
      ]);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      _country     = data.country      || null;
      _countryName = data.country_name || data.country || 'Unknown';
      dbg('GEO', `Location: ${_countryName} (${_country})`);
    } catch(e) {
      dbgWarn('GEO', 'Could not determine location:', e.message);
      _country = null; _countryName = 'Unknown';
    }
    return { country: _country, name: _countryName };
  }

  function get() { return { country: _country, name: _countryName }; }

  return { fetch, get };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODULE: AES_CRYPTO
//  AES-256-GCM per-chunk encryption via Web Crypto API.
//  Key derivation: PBKDF2(password, 16-byte salt, 210k iter, SHA-256).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AES_CRYPTO = (() => {
  const ALG = 'AES-GCM';
  const IV_LEN = 12;
  const KDF_ITER = 210_000;

  async function deriveKey(password, saltBytes) {
    const enc = new TextEncoder();
    const raw = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
    return crypto.subtle.deriveKey(
      { name:'PBKDF2', salt:saltBytes, iterations:KDF_ITER, hash:'SHA-256' },
      raw,
      { name:ALG, length:256 },
      false,
      ['encrypt','decrypt']
    );
  }

  async function encryptChunk(key, buffer) {
    const iv = crypto.getRandomValues(new Uint8Array(IV_LEN));
    const ciphertext = await crypto.subtle.encrypt({ name:ALG, iv }, key, buffer);
    const out = new Uint8Array(IV_LEN + ciphertext.byteLength);
    out.set(iv, 0);
    out.set(new Uint8Array(ciphertext), IV_LEN);
    return out.buffer;
  }

  async function decryptChunk(key, buffer) {
    const iv = new Uint8Array(buffer, 0, IV_LEN);
    const ciphertext = buffer.slice(IV_LEN);
    return crypto.subtle.decrypt({ name:ALG, iv }, key, ciphertext);
  }

  function genSalt() {
    const b = new Uint8Array(16);
    crypto.getRandomValues(b);
    return bufToHex(b);
  }

  return { deriveKey, encryptChunk, decryptChunk, genSalt };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODULE: LINK_PAIR
//  Persistent device pairing via 8-char token + PeerJS.
//  Host/guest roles are negotiated automatically.
//  Reconnect on drop uses PEER_RECONNECT_DELAYS for back-off.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LINK_PAIR = (() => {
  const LS_KEY      = 'gs_link_v6';
  const PEER_PREFIX = 'GSLNK';
  let _token  = null;
  let _peer   = null;
  let _conn   = null;
  let _retryT = null;
  let _retryN = 0;  // current retry index for back-off

  function init() {
    _token = localStorage.getItem(LS_KEY);
    _renderUI();
    if (_token) _start();
  }

  function generate() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const b = new Uint8Array(8);
    crypto.getRandomValues(b);
    _token = Array.from(b).map(x => chars[x % chars.length]).join('');
    localStorage.setItem(LS_KEY, _token);
    _renderUI();
    _start();
    showToast('Link token created â€” share it with your partner!','ğŸ”—','cyan');
    LOGGER.log(`Link token created: ${_token}`, 'cyan');
  }

  function saveToken(raw) {
    const t = (raw||'').trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (t.length !== 8) { showToast('Token must be 8 characters','âš ï¸','red'); return; }
    _token = t;
    localStorage.setItem(LS_KEY, _token);
    if (_peer) { try{_peer.destroy();}catch(e){} _peer=null; }
    _retryN = 0;
    _renderUI();
    _start();
    showToast('Token saved â€” searching for partner...','ğŸ”—','cyan');
  }

  function clear() {
    _cleanup();
    _token = null;
    localStorage.removeItem(LS_KEY);
    _renderUI();
    _updateBadge(false);
    showToast('Link token removed','ğŸ—‘ï¸','violet');
  }

  function isOnline() { return !!(_conn && _conn.open); }

  function broadcast(code) {
    if (!isOnline()) return;
    try {
      _conn.send(JSON.stringify({ type:'auto-connect', code }));
      dbg('LINK',`Broadcast auto-connect code="${code}"`);
      showToast('Sending to paired device automatically âš¡','ğŸ”—','cyan');
      LOGGER.log(`Auto-broadcast code ${code} to paired device`, 'cyan');
    } catch(e) { dbgErr('LINK','broadcast failed:',e); }
  }

  // â”€â”€ Private â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _peerId() { return `${PEER_PREFIX}${_token}`; }

  function _start() {
    if (!_token) return;
    clearTimeout(_retryT);
    _peer = new Peer(_peerId(), { debug:0 });
    _peer.on('open', () => {
      dbg('LINK',`Host registered: ${_peerId()}`);
      _retryN = 0; // success â€” reset back-off
      _peer.on('connection', c => { c.on('open', () => _onPartnerConn(c)); });
    });
    _peer.on('error', e => {
      if (e.type === 'unavailable-id') {
        dbg('LINK','ID taken â†’ becoming guest');
        try{_peer.destroy();}catch(er){} _peer=null;
        _becomeGuest();
      } else {
        // Exponential back-off reconnect
        const delay = PEER_RECONNECT_DELAYS[Math.min(_retryN++, PEER_RECONNECT_DELAYS.length-1)];
        dbgWarn('LINK',`Peer error (${e.type}) â€” retry in ${delay}ms`);
        _retryT = setTimeout(()=>{ _cleanup(); _start(); }, delay);
      }
    });
  }

  function _becomeGuest() {
    if (!_token) return;
    _peer = new Peer({ debug:0 });
    _peer.on('open', () => {
      const c = _peer.connect(_peerId(), { reliable:true });
      c.on('open',  () => _onPartnerConn(c));
      c.on('error', () => {
        const delay = PEER_RECONNECT_DELAYS[Math.min(_retryN++, PEER_RECONNECT_DELAYS.length-1)];
        _retryT = setTimeout(()=>{ _cleanup(); _start(); }, delay);
      });
    });
    _peer.on('error', () => {
      const delay = PEER_RECONNECT_DELAYS[Math.min(_retryN++, PEER_RECONNECT_DELAYS.length-1)];
      _retryT = setTimeout(()=>{ _cleanup(); _start(); }, delay);
    });
  }

  function _onPartnerConn(c) {
    _conn = c;
    dbg('LINK','Partner connected!');
    _retryN = 0;
    _updateBadge(true);
    showToast('Paired device is online!','ğŸ”—','cyan');
    LOGGER.log('Paired device connected', 'ok');
    AUDIO.pop();
    _renderUI();

    c.on('data', raw => {
      if (typeof raw !== 'string') return;
      let msg;
      try { msg = JSON.parse(raw); } catch(e) { return; }
      if (msg.type === 'auto-connect') {
        dbg('LINK',`Auto-connect received, code="${msg.code}"`);
        showToast('Partner is sending â€” auto-connecting... âš¡','âš¡','cyan');
        LOGGER.log(`Auto-connect triggered (code: ${msg.code})`, 'cyan');
        setTimeout(() => {
          initReceive();
          const inp = $('code-input');
          if (inp) { inp.value = msg.code; checkCodeReady(); }
          setTimeout(() => connectToSender(), 400);
        }, 100);
      }
    });

    c.on('close', () => {
      dbg('LINK','Partner disconnected');
      LOGGER.log('Paired device disconnected', 'warn');
      AUDIO.bye();
      _conn = null;
      _updateBadge(false);
      _renderUI();
      const delay = PEER_RECONNECT_DELAYS[0];
      _retryT = setTimeout(()=>{ _cleanup(); _start(); }, delay);
    });
  }

  function _cleanup() {
    clearTimeout(_retryT);
    if (_conn) { try{_conn.close();}catch(e){} _conn=null; }
    if (_peer) { try{_peer.destroy();}catch(e){} _peer=null; }
  }

  function _updateBadge(online) {
    const badge = $('link-badge');
    if (badge) badge.style.display = online ? 'flex' : 'none';
    const hb = $('link-header-badge');
    if (hb) hb.style.display = _token ? 'inline-flex' : 'none';
    const dot = $('link-status-dot'), lbl = $('link-status-lbl');
    if (dot) dot.style.background = online ? '#22c55e' : '#f59e0b';
    if (lbl) { lbl.textContent = online ? 'Partner online' : 'Searching...'; lbl.style.color = online ? '#22c55e' : 'var(--text-muted)'; }
    const qdz = $('link-quick-send');
    if (qdz) { qdz.style.opacity = online ? '1' : '0.4'; qdz.style.pointerEvents = online ? 'auto' : 'none'; }
  }

  function _renderUI() {
    const el = $('link-pair-section');
    if (!el) return;
    if (!_token) {
      el.innerHTML = `
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px;line-height:1.6;">
          Pair two devices once with a shared 8-char token. Transfers auto-initiate â€” no code sharing ever again.
        </p>
        <button onclick="LINK_PAIR.generate()" class="btn-primary" style="width:100%;padding:10px;font-size:13px;margin-bottom:12px;">
          âœ¨ Create Link Token
        </button>
        <div class="label" style="margin-bottom:6px;">Or enter a partner's token:</div>
        <div style="display:flex;gap:8px;">
          <input type="text" id="link-token-input" placeholder="ABCD1234"
            style="flex:1;padding:8px 12px;text-transform:uppercase;letter-spacing:0.12em;font-size:14px;"
            maxlength="8" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"/>
          <button onclick="LINK_PAIR.saveToken($('link-token-input').value)" class="btn-ghost" style="padding:8px 14px;font-size:12px;">Save</button>
        </div>`;
    } else {
      const online = isOnline();
      el.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div id="link-status-dot" style="width:9px;height:9px;border-radius:50%;background:${online?'#22c55e':'#f59e0b'};flex-shrink:0;transition:background 0.3s;"></div>
            <span id="link-status-lbl" style="font-size:12px;font-weight:600;color:${online?'#22c55e':'var(--text-muted)'};">${online?'Partner online':'Searching...'}</span>
          </div>
          <button onclick="LINK_PAIR.clear()" class="btn-danger" style="padding:5px 10px;font-size:11px;">Unlink</button>
        </div>
        <div style="display:flex;align-items:center;gap:12px;background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.18);border-radius:12px;padding:13px;margin-bottom:12px;">
          <div class="link-token-display">${_token}</div>
          <button onclick="navigator.clipboard?.writeText('${_token}').then(()=>showToast('Token copied!','âœ…','green'))" class="btn-ghost" style="padding:5px 9px;font-size:11px;">ğŸ“‹</button>
          <div style="flex:1;"></div>
          <div id="link-qr" style="width:60px;height:60px;overflow:hidden;border-radius:8px;"></div>
        </div>
        <div id="link-quick-send"
          style="opacity:${online?1:0.4};pointer-events:${online?'auto':'none'};"
          class="drop-zone-link" style="padding:18px;text-align:center;padding:18px;"
          onclick="linkQuickSend()" ondragover="onDragOver(event,true)" ondragleave="onDragLeave(event,true)" ondrop="onDrop(event,true)">
          <div style="font-size:24px;margin-bottom:6px;">âš¡</div>
          <div style="font-size:13px;font-weight:600;margin-bottom:4px;">Quick Send to Partner</div>
          <div style="font-size:11px;color:var(--text-muted);">Drop file or click â€” zero-click on their end</div>
        </div>`;
      setTimeout(()=>{
        const qrEl=$('link-qr');
        if(qrEl&&typeof QRCode!=='undefined'){
          try{new QRCode(qrEl,{text:_token,width:60,height:60,colorDark:'#06B6D4',colorLight:'#030610',correctLevel:QRCode.CorrectLevel.L});}catch(e){}
        }
      },80);
    }
  }

  return { init, generate, saveToken, clear, isOnline, broadcast, _renderUI, _updateBadge };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODULE: IDB
//  IndexedDB wrapper. Schema v2 adds 'history' store for
//  the LOGGER transfer history feature.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IDB = (() => {
  let db = null;
  const DB_NAME = 'ghostshare-v6';

  async function init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 2); // version 2 adds 'history'
      req.onupgradeneeded = e => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains('transfers'))
          d.createObjectStore('transfers', { keyPath:'transferId' });
        if (!d.objectStoreNames.contains('chunks'))
          d.createObjectStore('chunks');
        // â–¶ NEW: history store
        if (!d.objectStoreNames.contains('history'))
          d.createObjectStore('history', { keyPath:'id' });
      };
      req.onsuccess  = e => { db = e.target.result; resolve(db); };
      req.onerror    = () => reject(req.error);
    });
  }

  function saveChunk(transferId, idx, buffer) {
    if (!db) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('chunks','readwrite');
      tx.objectStore('chunks').put(buffer, `${transferId}:${idx}`);
      tx.oncomplete = resolve;
      tx.onerror    = () => reject(tx.error);
    });
  }

  function saveMeta(meta) {
    if (!db) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('transfers','readwrite');
      tx.objectStore('transfers').put({ ...meta, timestamp:Date.now() });
      tx.oncomplete = resolve;
      tx.onerror    = () => reject(tx.error);
    });
  }

  async function getLatestMeta() {
    if (!db) return null;
    return new Promise(resolve => {
      const tx  = db.transaction('transfers','readonly');
      const req = tx.objectStore('transfers').openCursor(null,'prev');
      req.onsuccess = e => resolve(e.target.result?.value || null);
      req.onerror   = () => resolve(null);
    });
  }

  async function loadChunks(transferId, totalChunks) {
    if (!db) return [];
    const chunks = new Array(totalChunks).fill(null);
    return new Promise(resolve => {
      const tx    = db.transaction('chunks','readonly');
      const range = IDBKeyRange.bound(`${transferId}:0`,`${transferId}:\uffff`);
      const req   = tx.objectStore('chunks').openCursor(range);
      req.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          const idx = parseInt(cursor.key.split(':')[1], 10);
          if (!isNaN(idx) && idx < totalChunks) chunks[idx] = cursor.value;
          cursor.continue();
        } else { resolve(chunks); }
      };
      req.onerror = () => resolve([]);
    });
  }

  function clearTransfer(transferId) {
    if (!db) return;
    const tx1 = db.transaction('transfers','readwrite');
    tx1.objectStore('transfers').delete(transferId);
    const tx2  = db.transaction('chunks','readwrite');
    const store = tx2.objectStore('chunks');
    const range = IDBKeyRange.bound(`${transferId}:0`,`${transferId}:\uffff`);
    const req   = store.openCursor(range);
    req.onsuccess = e => { const c=e.target.result; if(c){c.delete();c.continue();} };
  }

  function getDb() { return db; }

  return { init, saveChunk, saveMeta, getLatestMeta, loadChunks, clearTransfer, getDb };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNECTION GUARD STATE
//  geoGuardEnabled: user toggled the feature
//  pendingConnObj:  the connection being gated â€” stored while
//                   we show the geo modal to the sender
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let geoGuardEnabled = false;
let pendingConnObj  = null;

function onGeoGuardToggle() {
  geoGuardEnabled = !!$('geo-guard-toggle')?.checked;
  _updateSecBadges();
  LOGGER.log(`Connection Guard ${geoGuardEnabled?'enabled':'disabled'}`, 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let isGlobal        = false;
let peer            = null;
let isSender        = false;
let sendMode        = 'files'; // 'files' | 'folder' | 'text'

// Sender state
let connections     = [];
let selectedFiles   = [];
let transferBlob    = null;
let textPayload     = null;   // for text mode: { text, name }
let totalBytes      = 0;
let xferStart       = 0;
let globalIsPaused  = false;
let pauseResolve    = null;
let senderChunkHashes = [];
let transferComplete  = false;

// Receiver state
let recvConn        = null;
let inMeta          = null;
let inChunks        = [];
let recvChunkHashes = [];
let recvBytes       = 0;
let recvFromChunk   = 0;
let recvIsPaused    = false;

const recvQueue     = [];
let   recvProcessing = false;

// Speed tracking
let speedWindow     = [];
let speedHistory    = [];
let lastPerfTime    = 0;
let lastPerfBytes   = 0;
let elapsedTimer    = null;
let myCode          = null;

// Security state
let encEnabled      = false;
let encPassword     = '';
let senderAesKey    = null;
let senderSaltHex   = '';
let recvAesKey      = null;
let autoDestruct    = false;

// Peer reconnect
let peerRetryCount  = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const b = new Uint8Array(6);
  crypto.getRandomValues(b);
  return Array.from(b).map(x => chars[x % chars.length]).join('');
}

function bufToHex(buf) {
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function hexToBytes(hex) {
  const arr = new Uint8Array(hex.length / 2);
  for (let i=0; i<hex.length; i+=2) arr[i/2]=parseInt(hex.slice(i,i+2),16);
  return arr;
}

async function computeMerkleHash(hashes) {
  if (!hashes.length) return 'empty';
  const combined = new Uint8Array(hashes.length * 32);
  hashes.forEach((h,i) => combined.set(h, i*32));
  return bufToHex(await crypto.subtle.digest('SHA-256', combined));
}

function makeTransferId(name, size) {
  return `${name.replace(/[^a-zA-Z0-9]/g,'_')}-${size}`;
}

function fmtBytes(b) {
  if (!b) return '0 B';
  const u=['B','KB','MB','GB','TB'];
  const i=Math.floor(Math.log(b)/Math.log(1024));
  return `${(b/Math.pow(1024,i)).toFixed(i>0?1:0)} ${u[i]}`;
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function fileEmoji(name) {
  const ext=(name.split('.').pop()||'').toLowerCase();
  return ({pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',txt:'ğŸ“',md:'ğŸ“',
           jpg:'ğŸ–¼',jpeg:'ğŸ–¼',png:'ğŸ–¼',gif:'ğŸ–¼',webp:'ğŸ–¼',
           mp4:'ğŸ¬',mov:'ğŸ¬',mkv:'ğŸ¬',avi:'ğŸ¬',webm:'ğŸ¬',
           mp3:'ğŸµ',wav:'ğŸµ',flac:'ğŸµ',aac:'ğŸµ',
           zip:'ğŸ“¦',tar:'ğŸ“¦',gz:'ğŸ“¦',rar:'ğŸ“¦','7z':'ğŸ“¦',
           js:'ğŸ’»',ts:'ğŸ’»',py:'ğŸ’»',html:'ğŸ’»',json:'ğŸ’»',
           xlsx:'ğŸ“Š',csv:'ğŸ“Š',exe:'âš™',dmg:'âš™'}[ext]||'ğŸ“„');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function $(id)        { return document.getElementById(id); }
function show(id)     { const e=$(id); if(e) e.style.display=''; }
function hide(id)     { const e=$(id); if(e) e.style.display='none'; }
function showFlex(id) { const e=$(id); if(e) e.style.display='flex'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const t=$(id); if(t) t.classList.add('active');
}

function goHome() {
  cleanup();
  showScreen('screen-landing');
  hide('conn-badge');
  LINK_PAIR._renderUI();
  LINK_PAIR._updateBadge(LINK_PAIR.isOnline());
  LOGGER.renderHistory();
}

function initSend(mode='files') {
  isSender = true;
  sendMode = mode;
  showScreen('screen-send');
  resetSendUI();
  setSendMode(mode);
}

function initReceive() {
  isSender = false;
  showScreen('screen-receive');
  resetReceiveUI();
  checkForResume();
  // Pre-fetch geo so it's ready when we connect
  GEO.fetch().catch(()=>{});
}

function resetSendUI() {
  show('s-step-1'); hide('s-step-2'); hide('s-step-3');
  setStepDots(['sdot-1','sdot-2','sdot-3'],0);
  const btn=$('btn-start'); if(btn) btn.disabled=true;
  hide('files-panel');
  const fl=$('files-list'); if(fl) fl.innerHTML='';
  selectedFiles=[]; connections=[]; transferComplete=false; textPayload=null;
  const ta=$('text-input-area'); if(ta) ta.value='';
  const cc=$('text-char-count'); if(cc) cc.textContent='0 chars';
  const sp=$('sender-progress-area'); if(sp){ sp.innerHTML=''; delete sp.dataset.rendered; }
}

function resetReceiveUI() {
  show('r-step-1'); hide('r-step-2');
  setStepDots(['rdot-1','rdot-2'],0);
  const inp=$('code-input'); if(inp){inp.value='';checkCodeReady();}
  recvQueue.length=0; recvProcessing=false; transferComplete=false;
}

function setStepDots(ids, activeIdx) {
  ids.forEach((id,i)=>{ const e=$(id); if(e) e.classList.toggle('active',i===activeIdx); });
}
function showSendStep(n) {
  hide('s-step-1'); hide('s-step-2'); hide('s-step-3');
  show(`s-step-${n}`);
  setStepDots(['sdot-1','sdot-2','sdot-3'],n-1);
}
function showReceiveStep(n) {
  hide('r-step-1'); hide('r-step-2');
  show(`r-step-${n}`);
  setStepDots(['rdot-1','rdot-2'],n-1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â–¶ SEND MODE TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSendMode(mode) {
  sendMode = mode;
  // Update tabs
  ['files','folder','text'].forEach(m => {
    const t=$(`tab-${m}`); if(t) t.classList.toggle('active', m===mode);
    const d=$(`mode-${m}`); if(d) d.style.display = m===mode ? 'block' : 'none';
  });

  // Update screen title
  const title=$('send-screen-title');
  if(title) title.textContent = {files:'Send Files', folder:'Send Folder', text:'Send Secure Text'}[mode];

  // Update start button enabled state
  _checkStartButton();
}

function _checkStartButton() {
  const btn=$('btn-start'); if(!btn) return;
  if (sendMode==='text') {
    const ta=$('text-input-area');
    btn.disabled = !ta || ta.value.trim().length===0;
  } else {
    btn.disabled = selectedFiles.length===0;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE TOGGLE (Local / Global)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMode() {
  isGlobal = !isGlobal;
  $('mode-local').classList.toggle('active',!isGlobal);
  $('mode-global').classList.toggle('active', isGlobal);
  showToast(isGlobal?'ğŸŒ Global mode â€” TURN relay enabled':'ğŸ“¶ Local mode â€” STUN only',
            isGlobal?'ğŸŒ':'ğŸ“¶','violet');
  LOGGER.log(`Network mode: ${isGlobal?'Global (TURN)':'Local (STUN)'}`, 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOG PANEL TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleLogPanel() {
  const panel=$('log-panel');
  if(!panel) return;
  panel.classList.toggle('open');
  if(panel.classList.contains('open')) LOGGER.resetBadge();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SECURITY UI HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onEncToggle() {
  encEnabled = !!$('enc-toggle')?.checked;
  const wrap=$('enc-password-wrap');
  if(wrap) wrap.style.display=encEnabled?'block':'none';
  if(!encEnabled){ encPassword=''; senderAesKey=null; }
  _updateSecBadges();
}

function onAutoDestructToggle() {
  autoDestruct = !!$('autodestruct-toggle')?.checked;
  const hint=$('autodestruct-hint');
  if(hint) hint.style.display=autoDestruct?'block':'none';
  _updateSecBadges();
}

function validateEncPassword() {
  const pwd=$('enc-password')?.value||'';
  encPassword=pwd;
  const el=$('enc-strength'); if(!el) return;
  const len=pwd.length;
  let txt='',color='';
  if(len===0){txt='';color='';}
  else if(len<8){txt='âš  Weak â€” too short';color='#ef4444';}
  else if(len<12){txt='â—‘ Fair';color='#f59e0b';}
  else if(len<20){txt='â—• Good';color='#22c55e';}
  else{txt='â— Strong';color='#a78bfa';}
  el.textContent=txt; el.style.color=color;
}

function _updateSecBadges() {
  const el=$('sec-s-badges'); if(!el) return;
  let html='';
  if(encEnabled)    html+=`<span class="enc-badge">ğŸ”‘ AES-256</span>`;
  if(autoDestruct)  html+=`<span class="destruct-badge">ğŸ’¥ Destruct</span>`;
  if(geoGuardEnabled) html+=`<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);font-size:10px;font-weight:600;color:#06B6D4;">ğŸŒ Guard</span>`;
  el.innerHTML=html;
  const ab=$('active-sec-badges'); if(!ab) return;
  let abHtml='';
  if(encEnabled)      abHtml+=`<span class="enc-badge">ğŸ”‘ AES-256-GCM Encrypted</span>`;
  if(autoDestruct)    abHtml+=`<span class="destruct-badge">ğŸ’¥ Auto-Destruct Armed</span>`;
  if(geoGuardEnabled) abHtml+=`<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);font-size:10px;font-weight:600;color:#06B6D4;">ğŸŒ Guard Active</span>`;
  ab.innerHTML=abHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETWORK CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleConf(side) {
  const panel=$(`conf-${side}`), chev=$(`chev-${side}`);
  if(!panel) return;
  const open=panel.classList.toggle('open');
  if(chev) chev.style.transform=open?'rotate(180deg)':'';
  // Render history when that section opens
  if(side==='history' && open) LOGGER.renderHistory();
}

function buildIceConfig(side) {
  const iceServers=[...STUN_SERVERS];
  if(isGlobal) iceServers.push(...FREE_TURN_SERVERS);
  const url  = ($(`turn-url-${side}`)?.value  || '').trim();
  const user = ($(`turn-user-${side}`)?.value || '').trim();
  const pass = ($(`turn-pass-${side}`)?.value || '').trim();
  if(url) iceServers.push({ urls:url, username:user||undefined, credential:pass||undefined });
  return { iceServers, iceCandidatePoolSize:10, iceTransportPolicy:'all' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pickFiles() {
  if ('showOpenFilePicker' in window) {
    try {
      const h = await window.showOpenFilePicker({ multiple:true });
      selectedFiles = await Promise.all(h.map(x=>x.getFile()));
      renderFileList(selectedFiles);
    } catch(e) { if(e.name!=='AbortError') $('file-fallback').click(); }
  } else {
    $('file-fallback').click();
  }
}

// â–¶ NEW: Folder picker â€” uses webkitdirectory
function pickFolder() {
  $('folder-fallback').click();
}

function onFileInput(fl) {
  selectedFiles=Array.from(fl);
  renderFileList(selectedFiles);
}

// â–¶ NEW: Handle folder selection â€” preserves directory structure
async function onFolderInput(fl) {
  selectedFiles = Array.from(fl);
  if (!selectedFiles.length) return;
  renderFileList(selectedFiles, true);
  LOGGER.log(`Folder selected: ${selectedFiles.length} files`, 'info');
}

function onDragOver(e, isLink=false) {
  e.preventDefault();
  $(isLink?'link-quick-send':'drop-zone')?.classList.add('drag-active');
}
function onDragLeave(e, isLink=false) {
  $(isLink?'link-quick-send':'drop-zone')?.classList.remove('drag-active');
}
function onDrop(e, isLink=false) {
  e.preventDefault();
  $(isLink?'link-quick-send':'drop-zone')?.classList.remove('drag-active');
  selectedFiles=Array.from(e.dataTransfer.files);
  if(isLink){ linkQuickSend(); return; }
  if(selectedFiles.length) renderFileList(selectedFiles);
}

function renderFileList(files, isFolder=false) {
  if(!files.length) return;
  const total=files.reduce((s,f)=>s+f.size,0);
  const cl=$('files-count-lbl'), sl=$('files-size-lbl'), ll=$('files-list'), pl=$('files-panel'), btn=$('btn-start');
  const label = isFolder
    ? `${files.length} files in folder`
    : `${files.length} file${files.length>1?'s':''}`;
  if(cl) cl.textContent=label;
  if(sl) sl.textContent=fmtBytes(total);
  if(ll) ll.innerHTML=files.slice(0,40).map(f=>`
    <div style="display:flex;align-items:center;gap:8px;font-size:12px;padding:3px 0;">
      <span>${fileEmoji(f.name)}</span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.65);">${escHtml(f.webkitRelativePath||f.name)}</span>
      <span class="mono" style="color:var(--text-muted);">${fmtBytes(f.size)}</span>
    </div>`).join('') + (files.length>40?`<div style="font-size:11px;color:var(--text-muted);padding-top:4px;">...and ${files.length-40} more</div>`:'');
  if(pl) pl.style.display='block';
  if(btn) btn.disabled=false;
}

function clearFiles() {
  selectedFiles=[]; hide('files-panel');
  const fl=$('files-list'); if(fl) fl.innerHTML='';
  const btn=$('btn-start'); if(btn) btn.disabled=true;
}

// â–¶ NEW: Clipboard paste for text mode
async function pasteFromClipboard() {
  try {
    const t = await navigator.clipboard.readText();
    const ta=$('text-input-area');
    if(ta){ ta.value=t; onTextInput(); }
    showToast('Pasted from clipboard','ğŸ“‹','cyan');
  } catch(e) { showToast('Cannot read clipboard â€” paste manually','âš ï¸','amber'); }
}

function onTextInput() {
  const ta=$('text-input-area'), cc=$('text-char-count');
  if(cc) cc.textContent=`${(ta?.value||'').length} chars`;
  _checkStartButton();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD BLOB (files or folder â†’ ZIP)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buildBlob(files) {
  if (files.length===1 && !files[0].webkitRelativePath) {
    return { blob:files[0], name:files[0].name };
  }
  if (typeof JSZip==='undefined') throw new Error('JSZip not loaded');
  const zip=new JSZip();
  for (const f of files) {
    // Use webkitRelativePath to preserve folder structure, fallback to name
    const path = f.webkitRelativePath || f.name;
    zip.file(path, f, { binary:true });
  }
  LOGGER.log(`Zipping ${files.length} files...`, 'info');
  const blob=await zip.generateAsync(
    { type:'blob', compression:'DEFLATE', compressionOptions:{ level:3 } },
    m=>{ if(m.percent%25<2) dbg('ZIP',`${m.percent.toFixed(0)}%`); }
  );
  // Determine a sensible zip name
  const folderName = files[0]?.webkitRelativePath?.split('/')[0] || null;
  const name = folderName ? `${folderName}.zip` : `ghost-share-${Date.now()}.zip`;
  LOGGER.log(`ZIP ready: ${fmtBytes(blob.size)}`, 'ok');
  return { blob, name };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE DISPLAY + QR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function displayCode(code) {
  myCode=code;
  const el=$('code-display'); if(!el) return;
  el.innerHTML=code.split('').map(ch=>`<div class="code-box">${ch}</div>`).join('');
  genQR('qr-sender', code, '#7B5CF6');
  _updateSecBadges();
}
function copyCode() {
  if(!myCode) return;
  navigator.clipboard?.writeText(myCode).then(()=>showToast('Code copied!','âœ…','green'))
    .catch(()=>showToast('Code: '+myCode,'ğŸ“‹','violet'));
}
function genQR(cid, text, color) {
  const el=$(cid); if(!el||typeof QRCode==='undefined') return;
  el.innerHTML='';
  try { new QRCode(el,{text,width:160,height:160,colorDark:color||'#7B5CF6',colorLight:'#030610',correctLevel:QRCode.CorrectLevel.M}); }
  catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESUME DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkForResume() {
  try {
    const meta=await IDB.getLatestMeta();
    if(!meta) return;
    if((Date.now()-meta.timestamp)/60000>60){ IDB.clearTransfer(meta.transferId); return; }
    const pct=Math.round((meta.receivedCount/meta.totalChunks)*100);
    const banner=$('resume-banner'), info=$('resume-info');
    if(!banner||!info) return;
    info.innerHTML=`<b style="color:rgba(255,255,255,0.7);">${escHtml(meta.name)}</b> â€” ${fmtBytes(meta.size)} â€” ${pct}% received`;
    banner.style.display='block';
    banner._resumeMeta=meta;
  } catch(e){ dbgWarn('RESUME','checkForResume:',e); }
}

function clearResume() {
  const b=$('resume-banner');
  if(b?._resumeMeta) IDB.clearTransfer(b._resumeMeta.transferId);
  hide('resume-banner');
  showToast('Resume data cleared','ğŸ—‘ï¸','violet');
}
function checkCodeReady() {
  const v=($('code-input')?.value||'').trim();
  const btn=$('btn-connect'); if(btn) btn.disabled=v.length!==6;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â–¶ CONNECTION GUARD MODAL
//  Shows sender a review screen with receiver's country before
//  allowing the data transfer to proceed.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _showGeoModal(connObj, geoInfo) {
  return new Promise((resolve) => {
    const modal  = $('geo-modal');
    const body   = $('geo-modal-body');
    const allow  = $('geo-allow-btn');
    const deny   = $('geo-deny-btn');
    if (!modal || !body) { resolve(true); return; } // fail open

    const flag   = geoInfo.country ? `https://flagcdn.com/24x18/${geoInfo.country.toLowerCase()}.png` : null;
    const flagImg = flag ? `<img src="${flag}" onerror="this.style.display='none'" style="height:18px;vertical-align:middle;margin-right:6px;border-radius:2px;">` : 'ğŸŒ ';

    body.innerHTML = `
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Receiver ID</div>
      <div class="mono" style="font-size:15px;font-weight:700;margin-bottom:14px;">Receiver ${connObj.id}</div>
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;">Location</div>
      <div style="font-size:16px;font-weight:700;">${flagImg}${escHtml(geoInfo.name || 'Unknown')}</div>`;

    modal.classList.add('visible');
    LOGGER.log(`Connection Guard: receiver from ${geoInfo.name||'Unknown'} â€” awaiting approval`, 'warn');

    const onAllow = () => {
      modal.classList.remove('visible');
      allow.removeEventListener('click', onAllow);
      deny.removeEventListener('click', onDeny);
      LOGGER.log(`Connection Guard: ALLOWED`, 'ok');
      resolve(true);
    };
    const onDeny = () => {
      modal.classList.remove('visible');
      allow.removeEventListener('click', onAllow);
      deny.removeEventListener('click', onDeny);
      try { connObj.conn.close(); } catch(e) {}
      LOGGER.log(`Connection Guard: DENIED`, 'warn');
      showToast(`Connection from ${geoInfo.name||'?'} denied`,'ğŸš«','red');
      resolve(false);
    };

    allow.addEventListener('click', onAllow);
    deny.addEventListener('click', onDeny);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PEERJS â€” SENDER
//  Multi-receiver, with Connection Guard + text mode support.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startSenderSession() {
  // Text mode validation
  if (sendMode==='text') {
    const ta=$('text-input-area');
    const txt=(ta?.value||'').trim();
    if(!txt){ showToast('Enter some text to send','âš ï¸','red'); return; }
    textPayload = { text:txt, name:'ghostshare-text.txt' };
    // Convert text to blob so the existing chunked pipeline handles it
    const blob = new Blob([new TextEncoder().encode(txt)], { type:'text/plain' });
    transferBlob = { blob, name:textPayload.name, isText:true };
  } else {
    // File / Folder mode
    if(!selectedFiles.length){ showToast('Select files first','âš ï¸','red'); return; }
    if(encEnabled){ encPassword=$('enc-password')?.value||''; if(!encPassword){ showToast('Enter a passphrase to enable encryption','âš ï¸','red'); return; } }
    const btn=$('btn-start'); if(btn){btn.disabled=true;btn.textContent='Preparing...';}
    showToast('Preparing files...','ğŸ“¦','violet');
    try { transferBlob=await buildBlob(selectedFiles); }
    catch(e){ dbgErr('BLOB','buildBlob failed:',e); showToast('Failed to prepare files','âŒ','red'); const b=$('btn-start'); if(b){b.disabled=false;b.innerHTML='ğŸš€ Generate Code &amp; Start Session';} return; }
  }

  const btn=$('btn-start');
  if(btn){btn.disabled=true;btn.textContent='Starting...';}
  totalBytes=transferBlob.blob.size;

  // â”€â”€ Derive AES key if encryption on â”€â”€
  if(encEnabled && encPassword){
    senderSaltHex=AES_CRYPTO.genSalt();
    showToast('Deriving encryption key (PBKDF2)...','ğŸ”‘','violet');
    LOGGER.log('Deriving AES-256-GCM key (PBKDF2 210k rounds)...', 'info');
    try {
      senderAesKey=await AES_CRYPTO.deriveKey(encPassword, hexToBytes(senderSaltHex));
      LOGGER.log('Encryption key ready', 'ok');
    } catch(e){ dbgErr('SEC','Key derivation failed:',e); showToast('Key derivation failed','âŒ','red'); if(btn){btn.disabled=false;btn.innerHTML='ğŸš€ Generate Code &amp; Start Session';} return; }
  } else { senderAesKey=null; senderSaltHex=''; }

  // Pre-compute Merkle hashes in background
  senderChunkHashes=[];
  computeSenderHashes(transferBlob.blob);

  const code=genCode();
  const iceCfg=buildIceConfig('s');
  dbg('PEER',`Creating sender peer id="${code}"`);
  LOGGER.log(`Starting session (code: ${code}, mode: ${sendMode})`, 'info');

  peer = new Peer(code, { config:iceCfg, debug:0 });

  peer.on('open', id=>{
    dbg('PEER',`Sender open id="${id}"`);
    LOGGER.log(`Peer open â€” code: ${id}`, 'ok');
    peerRetryCount=0;
    displayCode(id);
    showSendStep(2);
    showToast(`Code: ${id} â€” share it!`,'ğŸ“¡','violet');
    LINK_PAIR.broadcast(id);
  });

  peer.on('connection', async c=>{
    const shortId=(c.peer||'').slice(-4).toUpperCase()||`R${connections.length+1}`;
    dbg('PEER',`New receiver: ${shortId}`);
    LOGGER.log(`Receiver ${shortId} connecting...`, 'info');
    AUDIO.pop();

    const connObj={ id:shortId, conn:c, fromChunk:0, sentBytes:0, status:'waiting', cardEl:null, _resolveHello:null };
    c.serialization='raw';

    c.on('open', async ()=>{
      dbg('PEER',`Receiver ${shortId} open`);
      showFlex('conn-badge');
      updateReceiverCount();
      addReceiverCard(connObj);

      // â”€â”€ CONNECTION GUARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if(geoGuardEnabled){
        // Wait for geo info from hello message (set in c.on('data'))
        connObj.status='guard-pending';
        updateReceiverCard(connObj);
        // We'll proceed inside handleSenderCtrlMsg once hello arrives
        connections.push(connObj);
      } else {
        connections.push(connObj);
        startConnectionLoop(connObj);
      }
    });

    c.on('data', raw=>{ if(typeof raw==='string'){try{handleSenderCtrlMsg(connObj,JSON.parse(raw));}catch(e){}} });
    c.on('error', e=>{ dbgErr('CONN',`${shortId} error:`,e); connObj.status='error'; updateReceiverCard(connObj); LOGGER.log(`Receiver ${shortId} error: ${e.type||e}`, 'error'); AUDIO.error(); });
    c.on('close', ()=>{ dbgWarn('CONN',`${shortId} closed`); connObj.status='error'; updateReceiverCard(connObj); updateReceiverCount(); LOGGER.log(`Receiver ${shortId} disconnected`, 'warn'); });
  });

  peer.on('disconnected', ()=>{
    dbgWarn('PEER','Sender disconnected from server â€” attempting reconnect...');
    LOGGER.log('Disconnected from PeerJS server â€” reconnecting...', 'warn');
    _tryPeerReconnect();
  });

  peer.on('error', e=>{
    dbgErr('PEER','Sender error:',e);
    LOGGER.log(`Peer error: ${e.type}`, 'error');
    if(e.type==='unavailable-id'){
      // Code collision â€” regenerate silently
      dbg('PEER','Code collision â€” regenerating...');
      peer.destroy(); peer=null;
      startSenderSession();
    } else if(e.type==='server-error'||e.type==='network'){
      showToast('Server error â€” retrying...','âš ï¸','amber');
      _tryPeerReconnect();
    } else {
      showToast(`Peer error: ${e.type}`,'âŒ','red');
      const b=$('btn-start'); if(b){b.disabled=false;b.innerHTML='ğŸš€ Generate Code &amp; Start Session';}
    }
  });
}

/**
 * Attempt to reconnect a disconnected peer with exponential back-off.
 * After MAX_PEER_RETRIES the UI shows an error and gives up.
 */
function _tryPeerReconnect() {
  if(peerRetryCount>=MAX_PEER_RETRIES){ showToast('Could not reconnect â€” please restart','âŒ','red'); return; }
  const delay=PEER_RECONNECT_DELAYS[Math.min(peerRetryCount,PEER_RECONNECT_DELAYS.length-1)];
  peerRetryCount++;
  LOGGER.log(`Reconnect attempt ${peerRetryCount}/${MAX_PEER_RETRIES} in ${delay/1000}s`, 'warn');
  setTimeout(()=>{
    if(peer && !peer.destroyed){
      try{ peer.reconnect(); }catch(e){ dbgWarn('PEER','peer.reconnect() threw:',e); }
    }
  }, delay);
}

async function computeSenderHashes(blob) {
  const n=Math.ceil(blob.size/CHUNK_SIZE);
  senderChunkHashes=new Array(n);
  for(let i=0;i<n;i++){
    const start=i*CHUNK_SIZE;
    const buf=await blob.slice(start,Math.min(start+CHUNK_SIZE,blob.size)).arrayBuffer();
    senderChunkHashes[i]=new Uint8Array(await crypto.subtle.digest('SHA-256',buf));
  }
  dbg('HASH',`All ${n} chunk hashes computed`);
  LOGGER.log(`SHA-256 pre-hash complete (${n} chunks)`, 'ok');
}

async function handleSenderCtrlMsg(connObj, msg) {
  dbg('CTRL',`Sender got msg type="${msg.type}" from ${connObj.id}`);

  if(msg.type==='hello'){
    connObj.fromChunk=msg.resumeFrom||0;
    // Attach geo info sent by receiver
    if(msg.geo) connObj.geo=msg.geo;

    // If connection guard is active, show approval modal
    if(geoGuardEnabled && connObj.status==='guard-pending'){
      const geoInfo = msg.geo || { name:'Unknown', country:null };
      const allowed = await _showGeoModal(connObj, geoInfo);
      if(!allowed){ connObj.status='error'; updateReceiverCard(connObj); return; }
      connObj.status='waiting';
    }

    if(connObj._resolveHello){ connObj._resolveHello(); connObj._resolveHello=null; }
  }

  if(msg.type==='verify'){
    const ok=msg.ok;
    connObj.status=ok?'done':'error';
    updateReceiverCard(connObj);
    showToast(ok?`âœ“ ${connObj.id} verified`:`âš  ${connObj.id} hash mismatch`,ok?'âœ…':'âš ï¸',ok?'green':'red');
    LOGGER.log(`Receiver ${connObj.id} verify: ${ok?'PASS':'FAIL'}`, ok?'ok':'error');
    if(ok) AUDIO.chime(); else AUDIO.error();

    const vs=$('verify-status');
    if(vs) vs.innerHTML=ok
      ?`<div class="hash-ok" style="text-align:center;font-size:13px;font-weight:600;color:#22c55e;">âœ… Receiver confirmed every byte is intact</div>`
      :`<div class="hash-fail" style="text-align:center;font-size:13px;font-weight:600;color:#ef4444;">âš  Integrity check failed â€” ask receiver to retry</div>`;

    const allDone=connections.every(c=>c.status==='done'||c.status==='error');
    if(allDone){
      transferComplete=true;
      finishUI(false);
      LOGGER.saveHistory({ direction:'send', name:transferBlob?.name||'unknown', size:totalBytes, ok, id:Date.now() });

      if(autoDestruct&&ok){
        dbg('DESTRUCT','Auto-destruct triggered!');
        showToast('ğŸ’¥ Auto-destruct â€” session destroyed','ğŸ’¥','red');
        LOGGER.log('Auto-destruct: session destroyed', 'warn');
        const ring=$('ring-wrap');
        if(ring) ring.classList.add('destruct-anim');
        setTimeout(()=>{
          connections.forEach(c=>{ try{c.conn.close();}catch(e){} });
          if(peer){try{peer.destroy();}catch(e){}peer=null;}
          hide('conn-badge');
          const st=$('xfer-status'); if(st){st.textContent='ğŸ’¥ Session destroyed';st.style.color='#ef4444';}
        },600);
      }
    }
  }

  if(msg.type==='pause') { globalIsPaused=true;  renderGlobalPauseState(true); showToast(`${connObj.id} paused`,'â¸','amber'); }
  if(msg.type==='resume'){ doGlobalResume(); }
}

// â”€â”€ Per-receiver send loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startConnectionLoop(connObj) {
  connObj.status='waiting';
  updateReceiverCard(connObj);

  // Wait for hello handshake (or timeout after 5s)
  await Promise.race([
    new Promise(r=>{ connObj._resolveHello=r; }),
    new Promise(r=>setTimeout(r,5000)),
  ]);

  if(connObj.status==='error') return; // guard denied

  const { blob, name, isText } = transferBlob;
  const totalChunks = Math.ceil(totalBytes/CHUNK_SIZE);
  const startChunk  = connObj.fromChunk||0;

  // Send META
  connObj.conn.send(JSON.stringify({
    type:'meta', name, size:totalBytes,
    mime: isText ? 'text/plain' : (blob.type||'application/octet-stream'),
    chunks:totalChunks, fromChunk:startChunk,
    transferId:makeTransferId(name,totalBytes),
    encrypted:!!senderAesKey, salt:senderSaltHex,
    isText:!!isText,
  }));
  LOGGER.log(`â†’ META: ${name} (${fmtBytes(totalBytes)}) to Receiver ${connObj.id}`, 'info');

  connObj.status='active';
  connObj.sentBytes=startChunk*CHUNK_SIZE;
  updateReceiverCard(connObj);
  showSendStep(3);
  renderSenderProgressUI(name);
  xferStart=performance.now();

  const rawDC=connObj.conn._dc||connObj.conn.dataChannel;
  if(rawDC) rawDC.bufferedAmountLowThreshold=LOW_WATER;

  for(let i=startChunk;i<totalChunks;i++){
    // Pause gate
    if(globalIsPaused) await new Promise(r=>{ pauseResolve=r; });

    // Connection check
    if(!connObj.conn.open){ dbgWarn('XFER',`${connObj.id} conn closed mid-transfer`); connObj.status='error'; updateReceiverCard(connObj); return; }

    // Backpressure gate
    const dc=connObj.conn._dc||connObj.conn.dataChannel;
    if(dc&&dc.bufferedAmount>HIGH_WATER){
      await new Promise(r=>{
        if(!dc) return r();
        const h=()=>{ dc.removeEventListener('bufferedamountlow',h); r(); };
        dc.addEventListener('bufferedamountlow',h);
        setTimeout(()=>{ dc.removeEventListener('bufferedamountlow',h); r(); },10000);
      });
    }

    // Read chunk
    const start=i*CHUNK_SIZE, end=Math.min(start+CHUNK_SIZE,totalBytes);
    let buffer=await blob.slice(start,end).arrayBuffer();

    // Encrypt if enabled
    if(senderAesKey){
      try{ buffer=await AES_CRYPTO.encryptChunk(senderAesKey,buffer); }
      catch(e){ dbgErr('ENC',`Encrypt chunk ${i} failed:`,e); connObj.status='error'; updateReceiverCard(connObj); AUDIO.error(); return; }
    }

    try{ connObj.conn.send(buffer); }
    catch(e){ dbgErr('XFER',`${connObj.id} send error chunk ${i}:`,e); connObj.status='error'; updateReceiverCard(connObj); AUDIO.error(); return; }

    connObj.sentBytes=end;
    updateReceiverCard(connObj);
    const aggBytes=connections.reduce((s,c)=>s+c.sentBytes,0)/connections.length;
    tickSpeed(aggBytes);
    if(i%64===0||i===totalChunks-1) dbg('XFER',`${connObj.id} ${i+1}/${totalChunks}`);
  }

  // DONE â€” wait for hashes + send
  const hashes=await waitForHashes(totalChunks);
  const fileHash=await computeMerkleHash(hashes);
  connObj.conn.send(JSON.stringify({ type:'done', hash:fileHash }));
  connObj.status='waiting-verify';
  updateReceiverCard(connObj);
  LOGGER.log(`â†’ DONE sent to ${connObj.id}, hash=${fileHash.slice(0,16)}...`, 'ok');
}

async function waitForHashes(n) {
  const dl=Date.now()+30000;
  while(senderChunkHashes.filter(Boolean).length<n&&Date.now()<dl)
    await new Promise(r=>setTimeout(r,100));
  return senderChunkHashes.slice(0,n);
}

// â”€â”€ Pause/Resume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pauseAll() {
  globalIsPaused=true; renderGlobalPauseState(true);
  connections.forEach(c=>{ try{c.conn.send(JSON.stringify({type:'pause'}));}catch(e){} });
  LOGGER.log('All transfers paused', 'warn');
}
function resumeAll() {
  doGlobalResume();
  connections.forEach(c=>{ try{c.conn.send(JSON.stringify({type:'resume'}));}catch(e){} });
  LOGGER.log('All transfers resumed', 'info');
}
function doGlobalResume() {
  globalIsPaused=false;
  if(pauseResolve){pauseResolve();pauseResolve=null;}
  renderGlobalPauseState(false);
}
function renderGlobalPauseState(paused) {
  const btn=$('global-pause-btn'); if(!btn) return;
  btn.className=paused?'btn-resume':'btn-pause';
  btn.textContent=paused?'â–¶ Resume All':'â¸ Pause All';
  btn.onclick=paused?resumeAll:pauseAll;
}

// â”€â”€ Receiver cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateReceiverCount() {
  const badge=$('receiver-count-badge'), n=connections.length;
  if(badge) badge.textContent=`${n} connected`;
  const wi=$('waiting-indicator'), rl=$('receivers-list');
  if(wi) wi.style.display=n>0?'none':'block';
  if(rl) rl.style.display=n>0?'block':'none';
}
function addReceiverCard(co) {
  const rl=$('receivers-list'); if(!rl) return;
  const div=document.createElement('div');
  div.id=`rcard-${co.id}`; div.className='receiver-card';
  rl.appendChild(div); co.cardEl=div; updateReceiverCard(co);
}
function updateReceiverCard(co) {
  const card=co.cardEl; if(!card) return;
  const pct=totalBytes>0?Math.round((co.sentBytes/totalBytes)*100):0;
  const statusColor={waiting:'var(--text-muted)',active:'#7B5CF6',paused:'#f59e0b',done:'#22c55e',error:'#ef4444','waiting-verify':'#06B6D4','guard-pending':'#f59e0b'}[co.status]||'#fff';
  const statusLabel={waiting:'Waiting',active:`${pct}%`,paused:'Paused',done:'âœ“ Done',error:'âœ— Error','waiting-verify':'Verifying...','guard-pending':'ğŸ›¡ Guard...'}[co.status]||co.status;
  const geoTag=co.geo?.name?`<span style="font-size:10px;color:var(--text-muted);margin-left:6px;">ğŸŒ ${escHtml(co.geo.name)}</span>`:'';
  card.className=`receiver-card ${co.status==='active'?'active-xfer':co.status==='done'?'done-xfer':''}`;
  card.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:8px;height:8px;border-radius:50%;background:${statusColor};flex-shrink:0;"></div>
      <span class="mono" style="font-size:12px;font-weight:600;">Receiver ${co.id}</span>${geoTag}
      <div style="flex:1;"></div>
      <span style="font-size:12px;font-weight:700;color:${statusColor};">${statusLabel}</span>
      <span class="mono" style="font-size:10px;color:var(--text-muted);">${fmtBytes(co.sentBytes)} / ${fmtBytes(totalBytes)}</span>
    </div>
    <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${pct}%;${co.status==='done'?'background:linear-gradient(90deg,#22c55e,#16a34a)':''}"></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PEERJS â€” RECEIVER
//  Sends geo info in the hello handshake for Connection Guard.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function connectToSender() {
  const code=($('code-input')?.value||'').trim().toUpperCase();
  if(code.length!==6){ showToast('Enter a 6-character code','âš ï¸','red'); return; }

  const btn=$('btn-connect'); if(btn){btn.disabled=true;btn.textContent='Connecting...';}
  LOGGER.log(`Connecting to sender (code: ${code})...`, 'info');

  // Fetch geo in background so we can include it in hello
  const geoInfo = await GEO.fetch().catch(()=>({ name:'Unknown', country:null }));

  peer=new Peer({ config:buildIceConfig('r'), debug:0 });
  peer.on('open', ()=>{
    recvConn=peer.connect(code, { reliable:true, serialization:'raw' });
    recvConn.on('open', async ()=>{
      dbg('PEER','Connected to sender');
      LOGGER.log(`Connected to sender (${code})`, 'ok');
      AUDIO.pop();
      showFlex('conn-badge');
      const lbl=$('conn-label'); if(lbl){lbl.textContent='Connected';lbl.style.color='#06B6D4';}
      showReceiveStep(2);
      renderReceiveWaiting();
      recvConn.on('data', raw=>{ recvQueue.push(raw); if(!recvProcessing) _drainRecvQueue(); });

      // Announce + resume offset + geo info
      const banner=$('resume-banner');
      const rm=banner?._resumeMeta;
      recvFromChunk=rm?rm.receivedCount:0;
      recvConn._resumeMeta=rm||null;
      recvConn.send(JSON.stringify({
        type:'hello',
        resumeFrom:recvFromChunk,
        geo: { name:geoInfo.name, country:geoInfo.country },
      }));
      LOGGER.log(`Hello sent (resume=${recvFromChunk}, geo=${geoInfo.name})`, 'info');
    });

    recvConn.on('error', e=>{
      dbgErr('CONN','recv error:',e);
      LOGGER.log(`Connection error: ${e.type||e}`, 'error');
      AUDIO.error();
      showToast(e.type==='peer-unavailable'?'Code not found â€” check and retry':'Connection failed','âŒ','red');
      if(btn){btn.disabled=false;btn.textContent='ğŸ”— Connect & Receive';}
    });

    recvConn.on('close', ()=>{
      if(inMeta&&recvBytes<totalBytes&&!transferComplete){
        IDB.saveMeta({ transferId:inMeta.transferId, name:inMeta.name, size:inMeta.size,
          mime:inMeta.mime, totalChunks:inMeta.chunks, receivedCount:inChunks.filter(Boolean).length });
        LOGGER.log('Connection dropped â€” transfer state saved for resume', 'warn');
        showToast('Connection dropped â€” re-enter code to resume','ğŸ“¡','amber');
      } else if(!transferComplete) { onDisconnect(); }
    });
  });

  peer.on('error', e=>{
    dbgErr('PEER','recv peer error:',e);
    LOGGER.log(`Peer error: ${e.type}`, 'error');
    AUDIO.error();
    const msg = e.type==='peer-unavailable'
      ? 'Code not found â€” check it and retry'
      : e.type==='server-error' ? 'PeerJS server unreachable â€” try Global mode'
      : `Error: ${e.type}`;
    showToast(msg,'âŒ','red');
    if(btn){btn.disabled=false;btn.textContent='ğŸ”— Connect & Receive';}
  });
}

function renderReceiveWaiting() {
  const el=$('recv-progress-area'); if(!el) return;
  el.innerHTML=`
    <div class="glass-card" style="padding:28px;text-align:center;">
      <div class="pulse-wrap" style="width:56px;height:56px;margin:0 auto 16px;position:relative;">
        <div class="pulse-ring-el" style="background:rgba(6,182,212,0.15);inset:0;position:absolute;border-radius:50%;"></div>
        <div class="pulse-core" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
          background:rgba(6,182,212,0.2);border:1px solid rgba(6,182,212,0.3);position:relative;z-index:1;font-size:16px;">ğŸ“¡</div>
      </div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px;">Connected â€” waiting for file...</div>
      <div style="font-size:12px;color:var(--text-muted);">Sender will start the transfer momentarily</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECEIVE DATA QUEUE
//  Sequential async processor â€” ensures AES-GCM decryption
//  doesn't reorder chunks.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function _drainRecvQueue() {
  recvProcessing=true;
  while(recvQueue.length>0){
    const item=recvQueue.shift();
    await _processOneRecvItem(item);
  }
  recvProcessing=false;
}

async function _processOneRecvItem(data) {
  // â”€â”€ Control messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(typeof data==='string'){
    let msg;
    try{ msg=JSON.parse(data); } catch(e){ return; }

    if(msg.type==='meta'){
      dbg('RECV','â•â•â• META â•â•â•',msg);
      LOGGER.log(`â† META: ${msg.name} (${fmtBytes(msg.size)}, enc=${msg.encrypted})`, 'info');
      inMeta={ ...msg, transferId:msg.transferId||makeTransferId(msg.name,msg.size) };
      totalBytes=msg.size; recvBytes=0; recvChunkHashes=[];
      speedWindow=[]; speedHistory=[]; lastPerfTime=xferStart=performance.now(); lastPerfBytes=0;

      // Derive decryption key
      if(msg.encrypted&&msg.salt){
        const pwd=$('recv-password')?.value||'';
        if(!pwd){
          showToast('âš  File is encrypted â€” enter the passphrase!','ğŸ”‘','red');
          const p=$('conf-sec-r'); if(p&&!p.classList.contains('open')) toggleConf('sec-r');
        }
        try{
          recvAesKey=await AES_CRYPTO.deriveKey(pwd, hexToBytes(msg.salt));
          LOGGER.log('Decryption key derived', 'ok');
        } catch(e){ dbgErr('SEC','Receiver key derivation failed:',e); recvAesKey=null; }
      } else { recvAesKey=null; }

      inChunks=new Array(msg.chunks).fill(null);

      // Restore persisted chunks if resuming
      const rm=recvConn?._resumeMeta;
      if(rm&&msg.fromChunk>0){
        dbg('RESUME',`Loading ${msg.fromChunk} chunks from IDB...`);
        showToast(`Resuming from ${Math.round(msg.fromChunk/msg.chunks*100)}%...`,'â©','cyan');
        LOGGER.log(`Resuming: loading ${msg.fromChunk} chunks from IDB`, 'info');
        const stored=await IDB.loadChunks(inMeta.transferId,msg.chunks);
        for(let i=0;i<msg.fromChunk;i++){
          if(stored[i]){ inChunks[i]=stored[i]; recvBytes+=stored[i].byteLength; }
        }
      }

      await IDB.saveMeta({ transferId:inMeta.transferId, name:msg.name, size:msg.size,
        mime:msg.mime, totalChunks:msg.chunks, receivedCount:msg.fromChunk||0 });

      renderReceiverProgressUI('recv-progress-area', msg.name);
      updateRing(recvBytes/totalBytes);
    }

    if(msg.type==='done'){
      dbg('RECV','â•â•â• DONE â•â•â•');
      LOGGER.log('â† DONE received â€” assembling...', 'ok');
      assembleAndDownload(msg.hash);
    }

    if(msg.type==='pause'){ const st=$('xfer-status'); if(st){st.textContent='â¸ Sender paused';st.style.color='#f59e0b';} LOGGER.log('Sender paused', 'warn'); }
    if(msg.type==='resume'){ const st=$('xfer-status'); if(st){st.textContent='Receiving...';st.style.color='var(--text-muted)';} }
    return;
  }

  // â”€â”€ Binary chunk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(data instanceof ArrayBuffer||data instanceof Uint8Array){
    let buf=data instanceof Uint8Array?data.buffer:data;

    if(recvAesKey){
      try{ buf=await AES_CRYPTO.decryptChunk(recvAesKey,buf); }
      catch(e){ dbgErr('RECV','Decrypt failed â€” wrong password?',e); showToast('Decryption failed â€” wrong passphrase?','âŒ','red'); AUDIO.error(); return; }
    }

    const idx=inChunks.findIndex(c=>c===null);
    if(idx===-1){ dbgWarn('RECV','Extra chunk ignored'); return; }

    inChunks[idx]=buf;
    recvBytes+=buf.byteLength;

    const ci=idx;
    crypto.subtle.digest('SHA-256',buf).then(h=>{ recvChunkHashes[ci]=new Uint8Array(h); });

    if(inMeta){
      IDB.saveChunk(inMeta.transferId,idx,buf).catch(()=>{});
      if(idx%64===0)
        IDB.saveMeta({ ...inMeta, receivedCount:idx+1, totalChunks:inMeta.chunks }).catch(()=>{});
    }

    if(idx%64===0) dbg('RECV',`Chunk #${idx} | ${fmtBytes(recvBytes)}/${fmtBytes(totalBytes)}`);
    tickSpeed(recvBytes);
    updateRing(recvBytes/totalBytes);
  }
}

async function assembleAndDownload(expectedHash) {
  dbg('RECV',`assembleAndDownload expectedHash=${expectedHash?.substring(0,16)}`);

  const totalChunks=inChunks.length;
  const deadline=Date.now()+6000;
  while(recvChunkHashes.filter(Boolean).length<totalChunks&&Date.now()<deadline)
    await new Promise(r=>setTimeout(r,50));

  const hashEl=$('hash-status');
  if(hashEl){ hashEl.style.display='block'; hashEl.className='hash-wait'; hashEl.innerHTML='<span style="color:#f59e0b;font-weight:600;">ğŸ” Verifying SHA-256 integrity...</span>'; }

  let hashOk=false, actualHash='';
  try{
    const valid=recvChunkHashes.slice(0,totalChunks).filter(Boolean);
    actualHash=await computeMerkleHash(valid);
    hashOk=(actualHash===expectedHash&&valid.length===totalChunks);
  } catch(e){ dbgErr('RECV','Hash error:',e); }

  LOGGER.log(`Integrity: ${hashOk?'âœ“ PASS':'âœ— FAIL'} (${actualHash.slice(0,16)}...)`, hashOk?'ok':'error');

  // â”€â”€ If text mode, show inline instead of downloading â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(inMeta?.isText){
    const text = new TextDecoder().decode(new Uint8Array(inChunks.filter(Boolean).flatMap(b=>Array.from(new Uint8Array(b)))));
    _showReceivedText(text, hashOk);
  } else {
    const blob=new Blob(inChunks.filter(Boolean),{ type:inMeta?.mime||'application/octet-stream' });
    const url=URL.createObjectURL(blob);
    const a=Object.assign(document.createElement('a'),{href:url,download:inMeta?.name||'download'});
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url),5000);
    showToast(hashOk?`âœ“ ${inMeta?.name} downloaded`:'âš  Download done â€” hash mismatch',
              hashOk?'âœ…':'âš ï¸',hashOk?'green':'red');
  }

  if(hashEl){
    hashEl.className=hashOk?'hash-ok':'hash-fail';
    hashEl.innerHTML=hashOk
      ?`<span style="color:#22c55e;font-weight:600;">âœ“ SHA-256 verified â€” file intact</span><br/>
        <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.3);">${actualHash.substring(0,32)}...</span>`
      :`<span style="color:#ef4444;font-weight:600;">âœ— Hash mismatch â€” data may be corrupt</span>`;
  }

  if(recvConn) recvConn.send(JSON.stringify({ type:'verify', ok:hashOk, hash:actualHash }));
  if(hashOk&&inMeta) IDB.clearTransfer(inMeta.transferId);

  if(hashOk) AUDIO.chime(); else AUDIO.error();

  LOGGER.saveHistory({ direction:'receive', name:inMeta?.name||'unknown', size:totalBytes, ok:hashOk, id:Date.now() });
  transferComplete=true;
  finishUI(hashOk);
  inChunks=[]; recvChunkHashes=[];
}

// â–¶ NEW: Render received text inline
function _showReceivedText(text, verified) {
  const pa=$('recv-progress-area'); if(!pa) return;
  // Append text display below progress
  const existing=document.getElementById('recv-text-wrap');
  if(!existing){
    const wrap=document.createElement('div');
    wrap.id='recv-text-wrap';
    wrap.innerHTML=`
      <div class="glass-card" style="padding:18px;margin-top:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="font-size:14px;font-weight:700;">ğŸ“ Received Text ${verified?'<span class="enc-badge" style="margin-left:8px;">âœ“ Verified</span>':''}</div>
          <button onclick="_copyReceivedText()" class="btn-ghost" style="padding:6px 12px;font-size:11px;">ğŸ“‹ Copy</button>
        </div>
        <div id="recv-text-display" class="recv-text-display">${escHtml(text)}</div>
      </div>`;
    pa.appendChild(wrap);
    showToast('Text received â€” scroll down to view','ğŸ“','cyan');
  }
}
window._copyReceivedText=()=>{
  const el=$('recv-text-display');
  if(el) navigator.clipboard?.writeText(el.textContent||'').then(()=>showToast('Text copied!','âœ…','green'));
};

// Receiver pause/resume
function recvPause(){
  recvIsPaused=true;
  if(recvConn) recvConn.send(JSON.stringify({type:'pause'}));
  const btn=$('pause-btn'); if(btn){btn.className='btn-resume';btn.textContent='â–¶ Resume';btn.onclick=recvResume;}
  const st=$('xfer-status'); if(st){st.textContent='â¸ Paused';st.style.color='#f59e0b';}
  LOGGER.log('Transfer paused', 'warn');
}
function recvResume(){
  recvIsPaused=false;
  if(recvConn) recvConn.send(JSON.stringify({type:'resume'}));
  const btn=$('pause-btn'); if(btn){btn.className='btn-pause';btn.textContent='â¸ Pause';btn.onclick=recvPause;}
  const st=$('xfer-status'); if(st){st.textContent='Receiving...';st.style.color='var(--text-muted)';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS UI â€” SENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSenderProgressUI(filename) {
  const el=$('sender-progress-area'); if(!el||el.dataset.rendered) return;
  el.dataset.rendered='1';
  const circ=(2*Math.PI*44).toFixed(2);
  el.innerHTML=`
    <div class="glass-card" style="padding:18px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:100px;height:100px;">
          <svg width="100" height="100" viewBox="0 0 104 104">
            <defs><linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#7B5CF6"/><stop offset="100%" stop-color="#2563eb"/>
            </linearGradient></defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:19px;font-weight:800;">0%</span>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.7);margin-bottom:5px;">${escHtml(filename)}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
            <div class="conn-dot" style="width:7px;height:7px;border-radius:50%;background:#22c55e;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">Sending...</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:5px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:26px;font-weight:700;color:var(--violet);line-height:1;">0.00</span>
            <span style="font-size:12px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:3px;">0 B / ${fmtBytes(totalBytes)}</div>
        </div>
      </div>
      <div class="label" style="margin-bottom:7px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:38px;"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>
      <div style="margin-top:14px;text-align:center;">
        <button id="global-pause-btn" class="btn-pause" style="padding:9px 24px;font-size:12px;" onclick="pauseAll()">â¸ Pause All</button>
      </div>
    </div>
    <div class="glass-card" style="padding:14px;margin-bottom:14px;">
      <div class="label" style="margin-bottom:10px;">Receivers</div>
      <div id="sender-receivers-list"></div>
    </div>
    <div id="verify-status" style="margin-bottom:12px;"></div>`;

  setTimeout(()=>{
    const srl=$('sender-receivers-list'); if(!srl) return;
    connections.forEach(c=>{
      const d=document.createElement('div'); d.id=`rcard-${c.id}`; d.className='receiver-card';
      srl.appendChild(d); c.cardEl=d; updateReceiverCard(c);
    });
  },50);
  startElapsedTimer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS UI â€” RECEIVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReceiverProgressUI(containerId, filename) {
  const el=$(containerId); if(!el) return;
  const circ=(2*Math.PI*44).toFixed(2);
  const encHint=inMeta?.encrypted?`<span class="enc-badge" style="margin-left:8px;">ğŸ”‘ AES-256-GCM</span>`:'';

  el.innerHTML=`
    <div class="glass-card" style="padding:18px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:100px;height:100px;">
          <svg width="100" height="100" viewBox="0 0 104 104">
            <defs><linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#06B6D4"/><stop offset="100%" stop-color="#7B5CF6"/>
            </linearGradient></defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:19px;font-weight:800;">0%</span>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.7);margin-bottom:5px;">${escHtml(filename)}${encHint}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
            <div class="conn-dot" style="width:7px;height:7px;border-radius:50%;background:#06B6D4;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">Receiving...</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:5px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:26px;font-weight:700;color:var(--cyan);line-height:1;">0.00</span>
            <span style="font-size:12px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:3px;">0 B / ${fmtBytes(totalBytes)}</div>
        </div>
      </div>
      <div class="label" style="margin-bottom:7px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:38px;"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>
      <div style="margin-top:14px;text-align:center;">
        <button id="pause-btn" class="btn-pause" style="padding:9px 24px;font-size:12px;" onclick="recvPause()">â¸ Pause</button>
      </div>
    </div>
    <div id="hash-status" class="hash-wait" style="display:none;margin-bottom:12px;">
      <span style="color:#f59e0b;font-weight:600;">ğŸ” Awaiting hash...</span>
    </div>`;

  startElapsedTimer();
  if(recvBytes>0&&totalBytes>0) updateRing(recvBytes/totalBytes);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPEED & PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickSpeed(bytes) {
  const now=performance.now(), dt=(now-lastPerfTime)/1000;
  if(dt<0.15) return;
  const rate=(bytes-lastPerfBytes)/dt; if(rate<0) return;
  speedWindow.push(rate); if(speedWindow.length>10) speedWindow.shift();
  speedHistory.push(rate); if(speedHistory.length>28) speedHistory.shift();
  lastPerfTime=now; lastPerfBytes=bytes;
  paintSpeed(bytes);
}

function paintSpeed(bytes) {
  const avg=speedWindow.reduce((a,b)=>a+b,0)/(speedWindow.length||1);
  const mbps=avg/(1024*1024);
  const sv=$('speed-val'); if(sv) sv.textContent=mbps.toFixed(2);
  const bl=$('bytes-lbl'); if(bl) bl.textContent=`${fmtBytes(bytes)} / ${fmtBytes(totalBytes)}`;
  const eta=$('eta-lbl');
  if(eta&&avg>0){ const rem=totalBytes-bytes, s=rem/avg; eta.textContent=s<60?`~${s.toFixed(0)}s remaining`:`~${(s/60).toFixed(1)}m remaining`; }
  const barsEl=$('speed-bars'); if(!barsEl) return;
  const arr=speedHistory, maxSpd=Math.max(...arr,1), pad=28-arr.length;
  barsEl.innerHTML=[...Array(pad).fill(0),...arr].map(s=>{
    const f=s/maxSpd,h=Math.max(3,f*36),r=Math.round(73+f*95),g=Math.round(40+f*20),op=(0.3+f*0.7).toFixed(2);
    return `<div class="speed-bar" style="flex:1;height:${h.toFixed(1)}px;background:rgb(${r},${g},246);opacity:${op};"></div>`;
  }).join('');
}

function updateRing(pct) {
  const ring=$('ring-fill'),pctEl=$('ring-pct'); if(!ring) return;
  const circ=2*Math.PI*44;
  ring.style.strokeDashoffset=(circ*(1-pct)).toFixed(2);
  const avg=speedWindow.length?speedWindow.reduce((a,b)=>a+b,0)/speedWindow.length:0;
  const glow=Math.min(3+(avg/(1024*1024))*1.2,30);
  const wrap=$('ring-wrap'); if(wrap) wrap.style.filter=`drop-shadow(0 0 ${glow.toFixed(1)}px rgba(123,92,246,${Math.min(0.4+(avg/(1024*1024))*0.04,0.95).toFixed(2)}))`;
  if(pctEl) pctEl.textContent=`${Math.round(pct*100)}%`;
}

function finishUI(hashOk) {
  clearInterval(elapsedTimer); updateRing(1);
  const s=$('xfer-status'); if(s){s.textContent=isSender?'âœ“ Sent':'âœ“ Downloaded';s.style.color='#22c55e';}
  const hashEl=$('hash-status'); if(hashEl&&!isSender) hashEl.style.display='block';
  [$('pause-btn'),$('global-pause-btn')].forEach(b=>{if(b){b.disabled=true;b.style.opacity='0.4';}});
}

function startElapsedTimer() {
  clearInterval(elapsedTimer);
  elapsedTimer=setInterval(()=>{ const el=$('elapsed-lbl'); if(el) el.textContent=`${((performance.now()-xferStart)/1000).toFixed(1)}s elapsed`; },500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLEANUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cleanup() {
  clearInterval(elapsedTimer);
  globalIsPaused=false; recvIsPaused=false;
  if(pauseResolve){pauseResolve();pauseResolve=null;}
  recvQueue.length=0; recvProcessing=false;
  connections.forEach(c=>{try{c.conn.close();}catch(e){}});
  connections=[];
  if(recvConn){try{recvConn.close();}catch(e){}recvConn=null;}
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  selectedFiles=[]; inChunks=[]; recvChunkHashes=[]; senderChunkHashes=[];
  speedWindow=[]; speedHistory=[];
  totalBytes=recvBytes=0; inMeta=null; transferBlob=null; textPayload=null; myCode=null;
  senderAesKey=null; recvAesKey=null; transferComplete=false; peerRetryCount=0;
}

function onDisconnect() {
  clearInterval(elapsedTimer); hide('conn-badge');
  LOGGER.log('Connection dropped unexpectedly', 'error');
  AUDIO.error();
  showToast('Connection dropped','ğŸ“¡','red');
  const s=$('xfer-status'); if(s){s.textContent='âš  Disconnected';s.style.color='#ef4444';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LINK PAIR â€” quick send
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function linkQuickSend() {
  if(!LINK_PAIR.isOnline()){ showToast('Partner offline','âš ï¸','red'); return; }
  if(!selectedFiles.length){ pickFiles(); return; }
  initSend('files');
  await new Promise(r=>setTimeout(r,50));
  renderFileList(selectedFiles);
  startSenderSession();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â–¶ GLOBAL DRAG-AND-DROP OVERLAY
//  Listens on the window for any dragenter event and shows a
//  full-screen "Drop to Share!" overlay. On drop it routes
//  the files to the send flow automatically.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initGlobalDrop(){
  const overlay = document.getElementById('global-drop-overlay');
  if(!overlay) return;

  let _enterCount = 0; // tracks nested dragenter/dragleave pairs

  window.addEventListener('dragenter', e=>{
    e.preventDefault();
    _enterCount++;
    overlay.classList.add('visible');
  });

  window.addEventListener('dragleave', e=>{
    _enterCount = Math.max(0, _enterCount-1);
    if(_enterCount===0) overlay.classList.remove('visible');
  });

  window.addEventListener('dragover', e=>{ e.preventDefault(); });

  window.addEventListener('drop', e=>{
    e.preventDefault();
    _enterCount=0;
    overlay.classList.remove('visible');

    const files = Array.from(e.dataTransfer?.files||[]);
    if(!files.length) return;

    // If we're on the landing screen, auto-navigate to send
    const landingActive = document.getElementById('screen-landing')?.classList.contains('active');
    if(landingActive){
      selectedFiles=files;
      initSend('files');
      // Small delay for the screen transition
      setTimeout(()=>{ renderFileList(files); }, 80);
      LOGGER.log(`Global drop: ${files.length} file(s) dropped`, 'info');
    } else if(document.getElementById('screen-send')?.classList.contains('active')){
      // Already on send screen â€” update file list
      selectedFiles=files;
      renderFileList(files);
    }
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastTimer=null;
function showToast(msg,icon,color) {
  const toast=$('toast'),ie=$('toast-icon-el'),me=$('toast-msg'); if(!toast) return;
  if(ie) ie.textContent=icon||'â„¹'; if(me) me.textContent=msg;
  toast.style.display='flex';
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>{ toast.style.display='none'; },4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function boot() {
  dbg('BOOT','boot()');
  LOGGER.log('GhostShare v6 initializing...', 'info');

  // Init IndexedDB
  try {
    const db = await IDB.init();
    LOGGER.setDb(db);
    LOGGER.log('IndexedDB ready', 'ok');
    dbg('IDB','Ready');
  } catch(e) { dbgWarn('IDB','Unavailable:',e.message); }

  // Init Permanent Link
  LINK_PAIR.init();

  // Dependency check
  const deps={
    WebRTC:  typeof RTCPeerConnection!=='undefined',
    PeerJS:  typeof Peer!=='undefined',
    JSZip:   typeof JSZip!=='undefined',
    QRCode:  typeof QRCode!=='undefined',
    Crypto:  typeof crypto?.subtle!=='undefined',
    IDB:     typeof indexedDB!=='undefined',
    Audio:   typeof AudioContext!=='undefined'||typeof webkitAudioContext!=='undefined',
  };
  for(const [n,ok] of Object.entries(deps)){
    dbg('DEPS',`${ok?'âœ”':'âœ˜'} ${n}`);
    LOGGER.log(`${ok?'âœ”':'âœ˜'} ${n}`, ok?'ok':'warn');
  }

  if(!deps.WebRTC) showToast('WebRTC not supported in this browser','âŒ','red');
  if(!deps.PeerJS)  showToast('PeerJS failed to load â€” check internet connection','âŒ','red');
  if(!deps.Crypto)  showToast('Web Crypto API unavailable','âš ï¸','red');

  // Wire up text input listener
  const ta=$('text-input-area');
  if(ta) ta.addEventListener('input', onTextInput);

  // Pre-fetch geo silently in the background
  GEO.fetch().catch(()=>{});

  showToast('GhostShare v6 ready ğŸ‘»','ğŸ‘»','violet');
  LOGGER.log('Ready ğŸ‘»', 'ok');
  dbg('BOOT','âœ… Ready');
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',boot);
} else { boot(); }
</script>
</body>
</html>
