<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GhostShare ‚Äî P2P File Transfer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --violet: #7B5CF6;
      --violet-dim: rgba(123,92,246,0.15);
      --cyan: #06B6D4;
      --cyan-dim: rgba(6,182,212,0.15);
      --green: #22c55e;
      --amber: #f59e0b;
      --red: #ef4444;
      --bg: #030610;
      --surface: rgba(255,255,255,0.028);
      --border: rgba(255,255,255,0.07);
      --border-glow: rgba(123,92,246,0.35);
      --text-muted: rgba(255,255,255,0.38);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html{scroll-behavior:smooth;}
    body{font-family:'Outfit',sans-serif;background-color:var(--bg);color:#fff;min-height:100vh;overflow-x:hidden;}
    body::before{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        radial-gradient(ellipse 60% 50% at 15% 40%, rgba(123,92,246,0.12) 0%, transparent 70%),
        radial-gradient(ellipse 50% 60% at 85% 20%, rgba(6,182,212,0.08) 0%, transparent 65%),
        radial-gradient(ellipse 40% 40% at 50% 90%, rgba(123,92,246,0.06) 0%, transparent 60%);
    }
    body::after{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),
        linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
      background-size:48px 48px;
      mask-image:radial-gradient(ellipse at center,black 30%,transparent 80%);
    }

    /* ‚îÄ‚îÄ GLASS ‚îÄ‚îÄ */
    .glass{background:var(--surface);border:1px solid var(--border);backdrop-filter:blur(24px);}
    .glass-card{
      background:rgba(255,255,255,0.035);border:1px solid var(--border);
      backdrop-filter:blur(20px);border-radius:16px;transition:border-color 0.3s;
    }
    .glass-card:hover{border-color:var(--border-glow);}

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-primary{
      background:linear-gradient(135deg,#6d40f5 0%,#2563eb 100%);
      border:1px solid rgba(109,64,245,0.5);border-radius:12px;
      font-weight:600;cursor:pointer;position:relative;overflow:hidden;color:#fff;
      transition:transform 0.2s,box-shadow 0.3s;
    }
    .btn-primary::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);transition:left 0.45s ease;}
    .btn-primary:hover::before{left:100%;}
    .btn-primary:hover{box-shadow:0 0 28px rgba(109,64,245,0.55),0 4px 20px rgba(0,0,0,0.4);transform:translateY(-1px);}
    .btn-primary:active{transform:translateY(0);}
    .btn-primary:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none;}
    .btn-ghost{background:rgba(255,255,255,0.045);border:1px solid var(--border);border-radius:10px;cursor:pointer;color:#fff;transition:background 0.2s,border-color 0.2s;}
    .btn-ghost:hover{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.14);}
    .btn-pause{background:rgba(234,179,8,0.12);border:1px solid rgba(234,179,8,0.3);border-radius:10px;cursor:pointer;color:#f59e0b;font-weight:600;transition:background 0.2s;}
    .btn-pause:hover{background:rgba(234,179,8,0.2);}
    .btn-resume{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);border-radius:10px;cursor:pointer;color:#22c55e;font-weight:600;transition:background 0.2s;}
    .btn-resume:hover{background:rgba(34,197,94,0.2);}
    .btn-danger{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);border-radius:10px;cursor:pointer;color:#ef4444;font-weight:600;transition:background 0.2s;}
    .btn-danger:hover{background:rgba(239,68,68,0.2);}

    /* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
    .mono{font-family:'JetBrains Mono',monospace;}
    .label{font-size:11px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);}

    /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
    textarea,input[type="text"],input[type="url"]{
      font-family:'JetBrains Mono',monospace;font-size:11px;
      background:rgba(0,0,0,0.4);border:1px solid var(--border);
      color:rgba(255,255,255,0.8);outline:none;border-radius:10px;
      transition:border-color 0.25s,box-shadow 0.25s;resize:none;
    }
    textarea:focus,input:focus{border-color:rgba(123,92,246,0.5);box-shadow:0 0 0 3px rgba(123,92,246,0.1);}
    textarea::placeholder,input::placeholder{color:rgba(255,255,255,0.2);}

    /* ‚îÄ‚îÄ CODE DISPLAY BOXES ‚îÄ‚îÄ */
    .code-boxes{display:flex;gap:8px;justify-content:center;margin:8px 0;}
    .code-box{
      width:52px;height:64px;display:flex;align-items:center;justify-content:center;
      font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;
      background:rgba(123,92,246,0.1);border:1.5px solid rgba(123,92,246,0.35);
      border-radius:14px;color:#fff;animation:codeGlow 2.5s ease-in-out infinite alternate;
    }
    @keyframes codeGlow{
      from{box-shadow:0 0 8px rgba(123,92,246,0.2);border-color:rgba(123,92,246,0.35);}
      to{box-shadow:0 0 22px rgba(123,92,246,0.55),inset 0 0 8px rgba(123,92,246,0.08);border-color:rgba(123,92,246,0.7);}
    }
    .code-input-field{
      font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;
      letter-spacing:0.35em;text-align:center;text-transform:uppercase;
      padding:18px 24px;background:rgba(0,0,0,0.5);border:1.5px solid var(--border);
      border-radius:16px;width:100%;color:#fff;outline:none;transition:border-color 0.25s,box-shadow 0.25s;
    }
    .code-input-field:focus{border-color:rgba(123,92,246,0.6);box-shadow:0 0 0 4px rgba(123,92,246,0.12),0 0 30px rgba(123,92,246,0.15);}
    .code-input-field::placeholder{color:rgba(255,255,255,0.12);letter-spacing:0.4em;}

    /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
    .screen{display:none;position:relative;z-index:1;}
    .screen.active{display:block;animation:fadeUp 0.4s cubic-bezier(0.16,1,0.3,1);}
    @keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes logoPulse{0%,100%{box-shadow:0 0 0 0 rgba(123,92,246,0.5);}50%{box-shadow:0 0 0 10px rgba(123,92,246,0);}}
    .logo-icon{animation:logoPulse 3s ease-in-out infinite;}
    @keyframes connectedPulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.6);}50%{box-shadow:0 0 0 5px rgba(34,197,94,0);}}
    .conn-dot{animation:connectedPulse 2s ease-in-out infinite;}
    @keyframes activePulseRing{0%{transform:scale(0.85);opacity:0.8;}100%{transform:scale(1.5);opacity:0;}}
    @keyframes activePulseDot{0%,100%{transform:scale(1);}50%{transform:scale(1.12);}}
    .pulse-wrap{position:relative;display:flex;align-items:center;justify-content:center;}
    .pulse-ring-el{position:absolute;inset:0;border-radius:50%;animation:activePulseRing 1.8s cubic-bezier(0.215,0.61,0.355,1) infinite;}
    .pulse-core{animation:activePulseDot 2.2s ease-in-out infinite;}
    @keyframes floatY{0%,100%{transform:translateY(0) rotate(-2deg);}50%{transform:translateY(-8px) rotate(2deg);}}
    .float-icon{animation:floatY 4s ease-in-out infinite;}
    @keyframes barPulse{0%,100%{opacity:.8}50%{opacity:1}}
    .speed-bar{animation:barPulse 1.1s ease-in-out infinite;border-radius:3px 3px 0 0;}
    @keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
    .shimmer-text{background:linear-gradient(90deg,#a78bfa,#38bdf8,#a78bfa);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite;}

    /* ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ */
    .progress-ring-track{fill:none;stroke:rgba(255,255,255,0.04);stroke-width:7;}
    .progress-ring-fill{fill:none;stroke-width:7;stroke:url(#ringGradient);stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset 0.35s ease;}

    /* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
    .drop-zone{border:2px dashed rgba(123,92,246,0.3);transition:all 0.3s;cursor:pointer;}
    .drop-zone:hover,.drop-zone.drag-active{border-color:rgba(123,92,246,0.7);background:rgba(123,92,246,0.04);}

    /* ‚îÄ‚îÄ STEP DOTS ‚îÄ‚îÄ */
    .step-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.12);transition:all 0.3s;}
    .step-dot.active{background:var(--violet);box-shadow:0 0 8px rgba(123,92,246,0.7);}

    /* ‚îÄ‚îÄ CONFIG PANEL ‚îÄ‚îÄ */
    .config-content{overflow:hidden;max-height:0;transition:max-height 0.4s cubic-bezier(0.16,1,0.3,1);}
    .config-content.open{max-height:600px;}

    /* ‚îÄ‚îÄ HASH STATUS ‚îÄ‚îÄ */
    .hash-ok{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);border-radius:10px;padding:10px 14px;}
    .hash-fail{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:10px;padding:10px 14px;}
    .hash-wait{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);border-radius:10px;padding:10px 14px;}

    /* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
    .mode-toggle{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:999px;padding:4px;cursor:pointer;user-select:none;}
    .mode-toggle-opt{font-size:11px;font-weight:600;padding:4px 10px;border-radius:999px;transition:all 0.2s;color:var(--text-muted);}
    .mode-toggle-opt.active{background:rgba(123,92,246,0.25);color:#fff;box-shadow:0 0 12px rgba(123,92,246,0.3);}
    .mode-toggle-opt.global.active{background:rgba(6,182,212,0.25);color:#fff;box-shadow:0 0 12px rgba(6,182,212,0.3);}

    /* ‚îÄ‚îÄ RESUME BANNER ‚îÄ‚îÄ */
    .resume-banner{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:14px;padding:14px 18px;margin-bottom:16px;}

    /* ‚îÄ‚îÄ RECEIVER CARD ‚îÄ‚îÄ */
    .receiver-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;margin-bottom:8px;transition:border-color 0.3s;}
    .receiver-card.active-xfer{border-color:rgba(123,92,246,0.3);}
    .receiver-card.done-xfer{border-color:rgba(34,197,94,0.3);}
    .mini-bar-track{height:4px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;margin-top:8px;}
    .mini-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#7B5CF6,#2563eb);transition:width 0.35s ease;}

    /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:rgba(123,92,246,0.4);border-radius:2px;}

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    @keyframes toastIn{from{opacity:0;transform:translate(-50%,20px);}to{opacity:1;transform:translate(-50%,0);}}
    #toast.visible{animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);}

    /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
    .badge-violet{background:var(--violet-dim);border:1px solid rgba(123,92,246,0.25);}
    .badge-cyan{background:var(--cyan-dim);border:1px solid rgba(6,182,212,0.25);}
    .badge-green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);}
  </style>
</head>
<body>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-5 py-3"
  style="background:rgba(3,6,16,0.75);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);">
  <div class="flex items-center gap-3">
    <div class="logo-icon w-8 h-8 rounded-xl flex items-center justify-center"
      style="background:linear-gradient(135deg,#7B5CF6,#2563eb);font-size:16px;">üëª</div>
    <span style="font-weight:800;font-size:15px;letter-spacing:-0.02em;">Ghost<span style="color:var(--violet);">Share</span></span>
    <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.2);">v4.0</span>
  </div>

  <!-- CENTER: Local / Global toggle -->
  <div class="mode-toggle" onclick="toggleMode()" title="Local = LAN/STUN only ‚Ä¢ Global = adds free TURN relay for firewall bypass">
    <div class="mode-toggle-opt active" id="mode-local">üì∂ Local</div>
    <div class="mode-toggle-opt global" id="mode-global">üåê Global</div>
  </div>

  <div id="conn-badge" style="display:none;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;
    background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);">
    <div class="conn-dot w-2 h-2 rounded-full" style="background:#22c55e;"></div>
    <span style="font-size:12px;font-weight:600;color:#22c55e;" id="conn-label">Connected</span>
  </div>
</header>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main style="padding-top:80px;padding-bottom:64px;padding-left:16px;padding-right:16px;max-width:640px;margin:0 auto;">

  <!-- ‚ïê‚ïê‚ïê‚ïê LANDING ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-landing" class="screen active">
    <div class="text-center" style="padding:48px 0 32px;">
      <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full mb-8"
        style="background:rgba(255,255,255,0.04);border:1px solid var(--border);">
        <span style="width:6px;height:6px;border-radius:50%;background:var(--violet);display:inline-block;box-shadow:0 0 8px var(--violet);"></span>
        <span style="font-size:12px;color:var(--text-muted);">6-char code ¬∑ Zero server ¬∑ Pure P2P</span>
      </div>
      <h1 style="font-size:52px;font-weight:900;letter-spacing:-0.04em;line-height:1.05;margin-bottom:16px;">
        Ghost<span class="shimmer-text">Share</span>
      </h1>
      <p style="color:var(--text-muted);font-size:16px;line-height:1.6;max-width:360px;margin:0 auto 12px;">
        Share a 6-character code. No accounts, no uploads, no limits.
      </p>
      <p style="font-family:'JetBrains Mono';font-size:13px;color:var(--violet);margin-bottom:40px;opacity:0.8;">
        A1B2C3 ‚Üí instant encrypted transfer
      </p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:40px;">
        <button onclick="initSend()" class="glass-card text-left" style="padding:28px;cursor:pointer;">
          <div style="width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;
            margin-bottom:20px;background:rgba(123,92,246,0.15);border:1px solid rgba(123,92,246,0.2);font-size:22px;">üì§</div>
          <div style="font-size:17px;font-weight:700;margin-bottom:4px;">Send Files</div>
          <div style="font-size:13px;color:var(--text-muted);line-height:1.5;">Get a code, share it, done</div>
        </button>
        <button onclick="initReceive()" class="glass-card text-left" style="padding:28px;cursor:pointer;">
          <div style="width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;
            margin-bottom:20px;background:rgba(6,182,212,0.12);border:1px solid rgba(6,182,212,0.2);font-size:22px;">üì•</div>
          <div style="font-size:17px;font-weight:700;margin-bottom:4px;">Receive Files</div>
          <div style="font-size:13px;color:var(--text-muted);line-height:1.5;">Enter a 6-char code, download</div>
        </button>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
        <span class="badge-violet" style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üîí DTLS Encrypted</span>
        <span class="badge-violet" style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">‚àû Unlimited Size</span>
        <span class="badge-cyan"   style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üì° Firewall Bypass</span>
        <span class="badge-cyan"   style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üë• Multi-Receiver</span>
        <span class="badge-green"  style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üîê SHA-256 Verified</span>
        <span class="badge-green"  style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">‚è∏ Resume on Drop</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê SEND ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-send" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">‚Üê Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Send Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Share a 6-char code ¬∑ Multi-receiver broadcast</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="sdot-1"></div>
        <div class="step-dot" id="sdot-2"></div>
        <div class="step-dot" id="sdot-3"></div>
      </div>
    </div>

    <!-- SEND STEP 1: file select -->
    <div id="s-step-1">
      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:16px;">
        <button onclick="toggleConf('s')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üì° Network Config <span style="font-size:11px;color:var(--text-muted);">STUN / TURN</span>
          </span>
          <span id="chev-s" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-s">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Built-in STUN Servers</div>
            <div class="mono glass" style="font-size:10px;line-height:1.8;color:rgba(123,92,246,0.8);padding:12px;border-radius:10px;margin-bottom:16px;">
              stun.l.google.com:19302<br/>stun1.l.google.com:19302<br/>stun.cloudflare.com:3478<br/>stun.mozilla.com<br/>stun.stunprotocol.org:3478
            </div>
            <div style="background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.2);border-radius:10px;padding:12px;margin-bottom:12px;">
              <div class="label" style="color:rgba(6,182,212,0.7);margin-bottom:6px;">üåê Global Mode ‚Äî Free TURN Relays</div>
              <div class="mono" style="font-size:10px;color:rgba(255,255,255,0.45);line-height:1.8;">
                openrelay.metered.ca:80 ¬∑ :443 ¬∑ TCP<br/>
                <span style="color:rgba(255,255,255,0.25);">Enabled automatically in Global mode</span>
              </div>
            </div>
            <div class="label" style="margin-bottom:8px;">Custom TURN Relay (optional override)</div>
            <input type="url" id="turn-url-s" placeholder="turn:your-server.com:3478" style="width:100%;padding:10px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-s" placeholder="username" style="flex:1;padding:10px 12px;"/>
              <input type="text" id="turn-pass-s" placeholder="password" style="flex:1;padding:10px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <!-- Drop Zone -->
      <div id="drop-zone" class="drop-zone glass-card"
        style="padding:40px;text-align:center;border-radius:20px;margin-bottom:16px;"
        onclick="pickFiles()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="float-icon" style="display:inline-block;margin-bottom:16px;font-size:40px;">üìÑ</div>
        <div style="font-size:16px;font-weight:600;margin-bottom:6px;">Drop files or click to browse</div>
        <div style="font-size:13px;color:var(--text-muted);">Any type ¬∑ Any size ¬∑ Multi-file auto-zipped</div>
        <input type="file" id="file-fallback" multiple style="display:none;" onchange="onFileInput(this.files)"/>
      </div>

      <!-- File list -->
      <div id="files-panel" style="display:none;" class="glass-card">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 16px 0;">
          <div style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;">
            üì¶ <span id="files-count-lbl">0 files</span>
          </div>
          <span class="mono" id="files-size-lbl" style="font-size:11px;color:var(--text-muted);"></span>
        </div>
        <div id="files-list" style="padding:12px 16px 16px;max-height:140px;overflow-y:auto;"></div>
      </div>

      <div style="margin-top:16px;">
        <button id="btn-start" onclick="startSenderSession()" disabled class="btn-primary"
          style="width:100%;padding:16px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
          üöÄ Generate Code &amp; Start Session
        </button>
      </div>
    </div>

    <!-- SEND STEP 2: show code, wait for receivers -->
    <div id="s-step-2" style="display:none;">
      <div class="glass-card" style="padding:28px;text-align:center;margin-bottom:16px;">
        <div class="label" style="margin-bottom:16px;">üì∂ Share this code with receivers</div>
        <div class="code-boxes" id="code-display"></div>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:16px;">
          <button onclick="copyCode()" class="btn-ghost" style="padding:8px 16px;font-size:12px;">üìã Copy Code</button>
          <span class="mono" style="font-size:11px;color:var(--text-muted);">Multiple peers can connect</span>
        </div>
      </div>

      <div class="glass-card" style="padding:20px;margin-bottom:16px;text-align:center;">
        <div class="label" style="margin-bottom:12px;">üî≤ QR Code</div>
        <div id="qr-sender" style="display:flex;justify-content:center;"></div>
      </div>

      <!-- Waiting / receiver list -->
      <div class="glass-card" style="padding:24px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div style="font-size:14px;font-weight:600;">Receivers</div>
          <div id="receiver-count-badge" style="font-size:11px;font-weight:600;color:var(--text-muted);
            background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:999px;padding:3px 10px;">
            0 connected
          </div>
        </div>
        <div id="waiting-indicator" style="text-align:center;padding:20px 0;">
          <div class="pulse-wrap" style="width:48px;height:48px;margin:0 auto 12px;position:relative;">
            <div class="pulse-ring-el" style="background:rgba(123,92,246,0.15);inset:0;position:absolute;border-radius:50%;"></div>
            <div class="pulse-core" style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;
              background:rgba(123,92,246,0.2);border:1px solid rgba(123,92,246,0.3);position:relative;z-index:1;font-size:14px;">üì∂</div>
          </div>
          <div style="font-size:13px;color:var(--text-muted);">Waiting for receivers...</div>
        </div>
        <div id="receivers-list" style="display:none;"></div>
      </div>
    </div>

    <!-- SEND STEP 3: active transfer -->
    <div id="s-step-3" style="display:none;">
      <div id="sender-progress-area"></div>
    </div>
  </div><!-- /screen-send -->

  <!-- ‚ïê‚ïê‚ïê‚ïê RECEIVE ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-receive" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">‚Üê Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Receive Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Enter the sender's 6-char code</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="rdot-1"></div>
        <div class="step-dot" id="rdot-2"></div>
      </div>
    </div>

    <!-- RECEIVE STEP 1: code input -->
    <div id="r-step-1">
      <!-- Resume banner (shown if IDB has partial data) -->
      <div id="resume-banner" class="resume-banner" style="display:none;">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:20px;">‚è∏</span>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:#f59e0b;margin-bottom:2px;">Interrupted Transfer Detected</div>
            <div id="resume-info" style="font-size:12px;color:var(--text-muted);"></div>
          </div>
          <button onclick="clearResume()" class="btn-danger" style="padding:6px 12px;font-size:11px;">Clear</button>
        </div>
      </div>

      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:16px;">
        <button onclick="toggleConf('r')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üì° Network Config <span style="font-size:11px;color:var(--text-muted);">optional TURN relay</span>
          </span>
          <span id="chev-r" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-r">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Custom TURN Relay</div>
            <input type="url" id="turn-url-r" placeholder="turn:openrelay.metered.ca:80" style="width:100%;padding:10px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-r" placeholder="username" style="flex:1;padding:10px 12px;"/>
              <input type="text" id="turn-pass-r" placeholder="password" style="flex:1;padding:10px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-card" style="padding:24px;margin-bottom:16px;">
        <div class="label" style="margin-bottom:16px;text-align:center;">Enter the sender's code</div>
        <input type="text" id="code-input" class="code-input-field" maxlength="6"
          placeholder="‚óè ‚óè ‚óè ‚óè ‚óè ‚óè"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');checkCodeReady()"
          onkeydown="if(event.key==='Enter')connectToSender()"/>
        <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:12px;">6 letters and numbers, no spaces</p>
      </div>

      <button id="btn-connect" onclick="connectToSender()" disabled class="btn-primary"
        style="width:100%;padding:16px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
        üîó Connect &amp; Receive
      </button>
    </div>

    <!-- RECEIVE STEP 2: transfer progress -->
    <div id="r-step-2" style="display:none;">
      <div id="recv-progress-area"></div>
    </div>
  </div><!-- /screen-receive -->

</main>

<!-- TOAST -->
<div id="toast" style="display:none;position:fixed;z-index:9999;bottom:24px;left:50%;transform:translateX(-50%);
  background:rgba(10,12,28,0.9);border:1px solid rgba(255,255,255,0.1);
  backdrop-filter:blur(20px);padding:12px 18px;border-radius:14px;
  align-items:center;gap:10px;min-width:220px;max-width:400px;white-space:nowrap;">
  <span id="toast-icon-el" style="font-size:16px;"></span>
  <span id="toast-msg" style="font-size:13px;font-weight:500;"></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js" crossorigin="anonymous"></script>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEBUG LOGGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _t0 = performance.now();
function dbg(sec,msg,data){const ts=((performance.now()-_t0)/1000).toFixed(3);data!==undefined?console.log(`[GS:${sec}] +${ts}s`,msg,data):console.log(`[GS:${sec}] +${ts}s`,msg);}
function dbgWarn(sec,msg,d){const ts=((performance.now()-_t0)/1000).toFixed(3);console.warn(`[GS:${sec}] ‚ö† +${ts}s`,msg,d||'');}
function dbgErr(sec,msg,e){const ts=((performance.now()-_t0)/1000).toFixed(3);console.error(`[GS:${sec}] ‚úñ +${ts}s`,msg,e||'');}

dbg('BOOT','‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GhostShare v4 initializing ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/** 64 KB chunks: below WebRTC DC limits, enables O(1) memory usage */
const CHUNK_SIZE   = 64 * 1024;

/** Backpressure: pause sending when DC buffer > 8 MB, resume at 1 MB */
const HIGH_WATER   = 8  * 1024 * 1024;
const LOW_WATER    = 1  * 1024 * 1024;

/**
 * FREE_TURN_SERVERS: openrelay.metered.ca is a permanently-free,
 * no-API-key TURN relay maintained by metered.ca for community use.
 * Global mode appends these to the STUN list for firewall bypass.
 */
const FREE_TURN_SERVERS = [
  { urls: 'turn:openrelay.metered.ca:80'              },
  { urls: 'turn:openrelay.metered.ca:443'             },
  { urls: 'turns:openrelay.metered.ca:443'            },
  { urls: 'turn:openrelay.metered.ca:80?transport=tcp'},
];

const STUN_SERVERS = [
  { urls: 'stun:stun.l.google.com:19302'     },
  { urls: 'stun:stun1.l.google.com:19302'    },
  { urls: 'stun:stun.cloudflare.com:3478'    },
  { urls: 'stun:stun.mozilla.com'            },
  { urls: 'stun:stun.stunprotocol.org:3478'  },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isGlobal      = false;          // Local vs Global mode
let peer          = null;           // PeerJS Peer instance
let isSender      = false;

// ‚îÄ‚îÄ Sender-specific ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
/**
 * connections[]: Array of active receiver connection objects.
 * Each entry: { id, conn, fromChunk, sentBytes, status, cardEl }
 *   id        ‚Äì short display ID (last 4 chars of PeerJS remote ID)
 *   conn      ‚Äì PeerJS DataConnection
 *   fromChunk ‚Äì chunk offset for resume (set when receiver sends 'hello')
 *   sentBytes ‚Äì bytes delivered to this receiver
 *   status    ‚Äì 'waiting'|'active'|'paused'|'done'|'error'
 *   cardEl    ‚Äì DOM element for this receiver's card
 */
let connections   = [];

// File state
let selectedFiles = [];
let transferBlob  = null;           // { blob, name } after buildBlob()
let totalBytes    = 0;
let xferStart     = 0;
let globalIsPaused = false;         // sender-side global pause

// Speed tracking (sender aggregate)
let speedWindow   = [];
let speedHistory  = [];
let lastPerfTime  = 0;
let lastPerfBytes = 0;

// Sender Merkle
let senderChunkHashes = [];

// ‚îÄ‚îÄ Receiver-specific ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recvConn      = null;           // single DataConnection (receiver)
let inMeta        = null;           // { name, size, mime, chunks, transferId }
let inChunks      = [];             // ArrayBuffer[] indexed by chunk number
let recvChunkHashes = [];           // Uint8Array[] per chunk SHA-256
let recvBytes     = 0;
let recvFromChunk = 0;              // resume offset
let recvIsPaused  = false;          // receiver-side pause
let pauseResolve  = null;           // resolves the sender pause Promise

// Timers
let elapsedTimer  = null;
let myCode        = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INDEXEDDB RESUME MODULE
//
//  Persists received chunks to IndexedDB so transfers can survive
//  browser crashes, tab closures, and network drops.
//
//  Schema:
//   DB  : "ghostshare-v4"
//   Store "transfers" : { transferId, name, size, mime, totalChunks,
//                         receivedCount, timestamp }
//   Store "chunks"    : key="${transferId}:${idx}" ‚Üí ArrayBuffer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IDB = (() => {
  let db = null;
  const DB_NAME    = 'ghostshare-v4';
  const DB_VERSION = 1;

  async function init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = e => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains('transfers'))
          d.createObjectStore('transfers', { keyPath: 'transferId' });
        if (!d.objectStoreNames.contains('chunks'))
          d.createObjectStore('chunks'); // key managed externally
      };
      req.onsuccess  = e => { db = e.target.result; resolve(db); };
      req.onerror    = () => reject(req.error);
    });
  }

  /** Persist one chunk (non-blocking fire-and-forget) */
  function saveChunk(transferId, idx, buffer) {
    if (!db) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const tx  = db.transaction('chunks', 'readwrite');
      const req = tx.objectStore('chunks').put(buffer, `${transferId}:${idx}`);
      tx.oncomplete = resolve;
      tx.onerror    = () => reject(tx.error);
    });
  }

  /** Save or update the transfer meta record */
  function saveMeta(meta) {
    if (!db) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const tx  = db.transaction('transfers', 'readwrite');
      const req = tx.objectStore('transfers').put({ ...meta, timestamp: Date.now() });
      tx.oncomplete = resolve;
      tx.onerror    = () => reject(tx.error);
    });
  }

  /** Load the most recent incomplete transfer meta, or null */
  async function getLatestMeta() {
    if (!db) return null;
    return new Promise((resolve) => {
      const tx  = db.transaction('transfers', 'readonly');
      const req = tx.objectStore('transfers').openCursor(null, 'prev');
      req.onsuccess = e => resolve(e.target.result?.value || null);
      req.onerror   = () => resolve(null);
    });
  }

  /** Load all stored chunks for a transfer ‚Üí sparse array indexed by chunkIdx */
  async function loadChunks(transferId, totalChunks) {
    if (!db) return [];
    const chunks = new Array(totalChunks).fill(null);
    return new Promise((resolve) => {
      const tx    = db.transaction('chunks', 'readonly');
      const store = tx.objectStore('chunks');
      // Iterate over all keys for this transferId
      const lower = `${transferId}:0`;
      const upper = `${transferId}:\uffff`;
      const range = IDBKeyRange.bound(lower, upper);
      const req   = store.openCursor(range);
      req.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          const idx = parseInt(cursor.key.split(':')[1], 10);
          if (!isNaN(idx) && idx < totalChunks) chunks[idx] = cursor.value;
          cursor.continue();
        } else {
          resolve(chunks);
        }
      };
      req.onerror = () => resolve([]);
    });
  }

  /** Delete all IDB data for a transfer (called on success) */
  function clearTransfer(transferId) {
    if (!db) return;
    // Delete meta
    const tx1 = db.transaction('transfers', 'readwrite');
    tx1.objectStore('transfers').delete(transferId);

    // Delete all chunks for this transfer
    const tx2  = db.transaction('chunks', 'readwrite');
    const store = tx2.objectStore('chunks');
    const range = IDBKeyRange.bound(`${transferId}:0`, `${transferId}:\uffff`);
    const req   = store.openCursor(range);
    req.onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) { cursor.delete(); cursor.continue(); }
    };
    dbg('IDB', `Cleared transfer ${transferId}`);
  }

  return { init, saveChunk, saveMeta, getLatestMeta, loadChunks, clearTransfer };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/** 6-char code from unambiguous alphabet (no 0/O/1/I) */
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const bytes  = new Uint8Array(6);
  crypto.getRandomValues(bytes);
  return Array.from(bytes).map(b => chars[b % chars.length]).join('');
}

function bufToHex(buf) {
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

/**
 * MERKLE HASH: hash each chunk individually then SHA-256 the concatenation.
 * Avoids loading the whole file into RAM for the digest.
 */
async function computeMerkleHash(chunkHashList) {
  if (!chunkHashList.length) return 'empty';
  const combined = new Uint8Array(chunkHashList.length * 32);
  chunkHashList.forEach((h, i) => combined.set(h, i * 32));
  const final = await crypto.subtle.digest('SHA-256', combined);
  return bufToHex(final);
}

/** Stable transfer ID from filename + size (no async needed) */
function makeTransferId(name, size) {
  return `${name.replace(/[^a-zA-Z0-9]/g,'_')}-${size}`;
}

function fmtBytes(b) {
  if (!b) return '0 B';
  const u = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(b) / Math.log(1024));
  return `${(b / Math.pow(1024, i)).toFixed(i > 0 ? 1 : 0)} ${u[i]}`;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function fileEmoji(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  return ({pdf:'üìÑ',doc:'üìù',docx:'üìù',txt:'üìù',md:'üìù',
           jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',webp:'üñº',svg:'üñº',
           mp4:'üé¨',mov:'üé¨',mkv:'üé¨',avi:'üé¨',webm:'üé¨',
           mp3:'üéµ',wav:'üéµ',flac:'üéµ',aac:'üéµ',
           zip:'üì¶',tar:'üì¶',gz:'üì¶',rar:'üì¶','7z':'üì¶',
           js:'üíª',ts:'üíª',py:'üíª',html:'üíª',css:'üíª',json:'üíª',
           xlsx:'üìä',csv:'üìä',exe:'‚öô',dmg:'‚öô'}[ext] || 'üìÑ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DOM HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function $(id) { return document.getElementById(id); }
function show(id) { const e=$(id); if(e) e.style.display=''; }
function hide(id) { const e=$(id); if(e) e.style.display='none'; }
function showFlex(id) { const e=$(id); if(e) e.style.display='flex'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const t = $(id);
  if (t) t.classList.add('active');
}
function goHome() {
  dbg('NAV','goHome()');
  cleanup();
  showScreen('screen-landing');
  hide('conn-badge');
}
function initSend() {
  dbg('NAV','initSend()');
  isSender = true;
  showScreen('screen-send');
  resetSendUI();
}
function initReceive() {
  dbg('NAV','initReceive()');
  isSender = false;
  showScreen('screen-receive');
  resetReceiveUI();
  checkForResume();
}
function resetSendUI() {
  show('s-step-1'); hide('s-step-2'); hide('s-step-3');
  setStepDots(['sdot-1','sdot-2','sdot-3'], 0);
  const btn = $('btn-start'); if (btn) btn.disabled = true;
  hide('files-panel');
  const fl = $('files-list'); if (fl) fl.innerHTML = '';
  selectedFiles = [];
  connections   = [];
}
function resetReceiveUI() {
  show('r-step-1'); hide('r-step-2');
  setStepDots(['rdot-1','rdot-2'], 0);
  const inp = $('code-input'); if (inp) { inp.value = ''; checkCodeReady(); }
}
function setStepDots(ids, activeIdx) {
  ids.forEach((id, i) => {
    const el = $(id); if (!el) return;
    el.classList.toggle('active', i === activeIdx);
  });
}
function showSendStep(n) {
  hide('s-step-1'); hide('s-step-2'); hide('s-step-3');
  show(`s-step-${n}`);
  setStepDots(['sdot-1','sdot-2','sdot-3'], n - 1);
}
function showReceiveStep(n) {
  hide('r-step-1'); hide('r-step-2');
  show(`r-step-${n}`);
  setStepDots(['rdot-1','rdot-2'], n - 1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE TOGGLE: Local ‚Üî Global
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMode() {
  isGlobal = !isGlobal;
  $('mode-local').classList.toggle('active', !isGlobal);
  $('mode-global').classList.toggle('active',  isGlobal);
  showToast(isGlobal ? 'üåê Global mode ‚Äî TURN relay enabled' : 'üì∂ Local mode ‚Äî STUN only',
            isGlobal ? 'üåê' : 'üì∂', isGlobal ? 'cyan' : 'violet');
  dbg('MODE', isGlobal ? 'Global (STUN+TURN)' : 'Local (STUN only)');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NETWORK CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleConf(side) {
  const panel = $(`conf-${side}`);
  const chev  = $(`chev-${side}`);
  if (!panel) return;
  const open = panel.classList.toggle('open');
  if (chev) chev.style.transform = open ? 'rotate(180deg)' : '';
}

/**
 * Build ICE config:
 *  Local  ‚Üí STUN only (fastest, works on same network)
 *  Global ‚Üí STUN + free openrelay TURN (works across firewalls/NATs)
 *  + any user-provided custom TURN server
 */
function buildIceConfig(side) {
  const iceServers = [...STUN_SERVERS];

  if (isGlobal) {
    iceServers.push(...FREE_TURN_SERVERS);
    dbg('ICE', 'Global mode: added free TURN relays');
  }

  const url  = ($(`turn-url-${side}`)?.value  || '').trim();
  const user = ($(`turn-user-${side}`)?.value || '').trim();
  const pass = ($(`turn-pass-${side}`)?.value || '').trim();
  if (url) {
    dbg('ICE', `Custom TURN: ${url}`);
    iceServers.push({ urls: url, username: user || undefined, credential: pass || undefined });
  }

  return { iceServers, iceCandidatePoolSize: 10 };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function pickFiles() {
  if ('showOpenFilePicker' in window) {
    try {
      const handles = await window.showOpenFilePicker({ multiple: true });
      selectedFiles = await Promise.all(handles.map(h => h.getFile()));
      renderFileList(selectedFiles);
    } catch(e) {
      if (e.name !== 'AbortError') $('file-fallback').click();
    }
  } else {
    $('file-fallback').click();
  }
}
function onFileInput(fileList) {
  selectedFiles = Array.from(fileList);
  renderFileList(selectedFiles);
}
function onDragOver(e)  { e.preventDefault(); $('drop-zone')?.classList.add('drag-active'); }
function onDragLeave(e) { $('drop-zone')?.classList.remove('drag-active'); }
function onDrop(e) {
  e.preventDefault();
  $('drop-zone')?.classList.remove('drag-active');
  selectedFiles = Array.from(e.dataTransfer.files);
  if (selectedFiles.length) renderFileList(selectedFiles);
}
function renderFileList(files) {
  if (!files.length) return;
  const total = files.reduce((s,f) => s + f.size, 0);
  const cl = $('files-count-lbl'), sl = $('files-size-lbl'),
        ll = $('files-list'),     pl = $('files-panel'),
        btn = $('btn-start');
  if (cl)  cl.textContent = `${files.length} file${files.length > 1 ? 's' : ''}`;
  if (sl)  sl.textContent = fmtBytes(total);
  if (ll)  ll.innerHTML   = files.map(f => `
    <div style="display:flex;align-items:center;gap:8px;font-size:12px;padding:3px 0;">
      <span>${fileEmoji(f.name)}</span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.65);">${escHtml(f.name)}</span>
      <span class="mono" style="color:var(--text-muted);">${fmtBytes(f.size)}</span>
    </div>`).join('');
  if (pl)  pl.style.display = 'block';
  if (btn) btn.disabled     = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILD BLOB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buildBlob(files) {
  if (files.length === 1) {
    dbg('BLOB', 'Single file ‚Äî no zip');
    return { blob: files[0], name: files[0].name };
  }
  dbg('BLOB', `${files.length} files ‚Üí JSZip`);
  if (typeof JSZip === 'undefined') throw new Error('JSZip not loaded');
  const zip = new JSZip();
  for (const f of files) zip.file(f.name, f, { binary: true });
  const blob = await zip.generateAsync(
    { type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 3 } },
    meta => { if (meta.percent % 25 < 2) dbg('ZIP', `${meta.percent.toFixed(0)}%`); }
  );
  return { blob, name: `ghost-share-${Date.now()}.zip` };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE DISPLAY + QR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function displayCode(code) {
  myCode = code;
  const el = $('code-display');
  if (!el) return;
  el.innerHTML = code.split('').map(ch =>
    `<div class="code-box">${ch}</div>`
  ).join('');
  genQR('qr-sender', code, '#7B5CF6');
}
function copyCode() {
  if (!myCode) return;
  navigator.clipboard?.writeText(myCode)
    .then(()  => showToast('Code copied!','‚úÖ','green'))
    .catch(()  => showToast('Code: ' + myCode, 'üìã','violet'));
}
function genQR(containerId, text, color) {
  const el = $(containerId);
  if (!el || typeof QRCode === 'undefined') return;
  el.innerHTML = '';
  try {
    new QRCode(el, { text, width: 180, height: 180,
      colorDark: color || '#7B5CF6', colorLight: '#030610',
      correctLevel: QRCode.CorrectLevel.M });
  } catch(e) {
    el.innerHTML = '<p style="font-size:11px;color:var(--text-muted);">QR failed</p>';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESUME DETECTION (Receiver)
//
//  On initReceive(), check IDB for any partial transfer.
//  If found, show the resume banner with the transfer name and
//  how many chunks were already received.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkForResume() {
  try {
    const meta = await IDB.getLatestMeta();
    if (!meta) return;
    const age   = (Date.now() - meta.timestamp) / 1000 / 60; // minutes
    if (age > 60) { IDB.clearTransfer(meta.transferId); return; } // expire after 1h

    const pct   = Math.round((meta.receivedCount / meta.totalChunks) * 100);
    const banner = $('resume-banner');
    const info   = $('resume-info');
    if (!banner || !info) return;
    info.innerHTML = `<b style="color:rgba(255,255,255,0.7);">${escHtml(meta.name)}</b> ‚Äî ${fmtBytes(meta.size)} ‚Äî ${pct}% received (${fmtBytes(meta.receivedCount * CHUNK_SIZE)} of ${fmtBytes(meta.size)})`;
    banner.style.display = 'block';
    banner._resumeMeta   = meta; // stash for use when connecting
    dbg('RESUME', `Found partial transfer: ${meta.name} ${pct}%`);
  } catch(e) {
    dbgWarn('RESUME', 'checkForResume error:', e);
  }
}

function clearResume() {
  const banner = $('resume-banner');
  if (banner?._resumeMeta) IDB.clearTransfer(banner._resumeMeta.transferId);
  hide('resume-banner');
  showToast('Resume data cleared','üóëÔ∏è','violet');
}

function checkCodeReady() {
  const v   = ($('code-input')?.value || '').trim();
  const btn = $('btn-connect');
  if (btn) btn.disabled = v.length !== 6;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS ‚Äî SENDER (Multi-Receiver Broadcast)
//
//  MULTI-RECEIVER DESIGN:
//  1. Sender creates a single Peer with the 6-char code as its ID.
//  2. peer.on('connection') fires for EVERY receiver that connects.
//  3. Each receiver is pushed into connections[].
//  4. startConnectionLoop(connObj) runs as an INDEPENDENT async loop
//     per receiver ‚Äî they can be at different progress points.
//  5. Pause/Resume affects all active connection loops via globalIsPaused.
//  6. Resume: if a receiver sends {type:'hello', resumeFrom: N},
//     the loop for that receiver begins at chunk N.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startSenderSession() {
  dbg('PEER','startSenderSession()');
  if (!selectedFiles.length) { showToast('Select files first','‚ö†Ô∏è','red'); return; }

  const btn = $('btn-start');
  if (btn) { btn.disabled = true; btn.textContent = 'Connecting...'; }

  showToast('Preparing files...','üì¶','violet');
  try {
    transferBlob = await buildBlob(selectedFiles);
  } catch(e) {
    dbgErr('BLOB','buildBlob failed:',e);
    showToast('Failed to prepare files','‚ùå','red');
    if (btn) { btn.disabled = false; btn.innerHTML = 'üöÄ Generate Code &amp; Start Session'; }
    return;
  }

  totalBytes = transferBlob.blob.size;
  dbg('PEER',`blob ready: ${fmtBytes(totalBytes)}`);

  // Pre-compute Merkle hashes for the blob (done once, shared to all receivers)
  senderChunkHashes = [];
  computeSenderHashes(transferBlob.blob); // fire-and-forget async

  const code   = genCode();
  const iceCfg = buildIceConfig('s');
  dbg('PEER',`Creating sender peer id="${code}"`);

  peer = new Peer(code, { config: iceCfg, debug: 0 });

  peer.on('open', id => {
    dbg('PEER',`Sender open id="${id}"`);
    displayCode(id);
    showSendStep(2);
    showToast(`Code: ${id} ‚Äî share it!`,'üì°','violet');
  });

  // ‚îÄ‚îÄ Each new receiver connection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  peer.on('connection', c => {
    const shortId = (c.peer || '').slice(-4).toUpperCase() || `R${connections.length + 1}`;
    dbg('PEER',`New receiver: ${shortId}`);

    const connObj = {
      id: shortId,
      conn: c,
      fromChunk: 0,         // may be updated by 'hello' message
      sentBytes: 0,
      status: 'waiting',
      cardEl: null,
      _resolveHello: null,  // resolved when hello received
    };
    connections.push(connObj);

    c.serialization = 'raw';

    c.on('open', () => {
      dbg('PEER',`Receiver ${shortId} DC open`);
      showFlex('conn-badge');
      updateReceiverCount();
      addReceiverCard(connObj);
      startConnectionLoop(connObj); // independent async loop for this receiver
    });

    c.on('data', data => {
      if (typeof data === 'string') {
        try {
          const msg = JSON.parse(data);
          handleSenderControlMsg(connObj, msg);
        } catch(e) { dbgWarn('CTRL','Bad JSON from receiver',e); }
      }
    });

    c.on('error', e => {
      dbgErr('CONN',`Receiver ${shortId} error:`,e);
      connObj.status = 'error';
      updateReceiverCard(connObj);
    });

    c.on('close', () => {
      dbgWarn('CONN',`Receiver ${shortId} disconnected`);
      connObj.status = 'error';
      updateReceiverCard(connObj);
      updateReceiverCount();
    });
  });

  peer.on('error', e => {
    dbgErr('PEER','Sender peer error:',e);
    if (e.type === 'unavailable-id') {
      peer.destroy(); peer = null;
      startSenderSession(); // retry with new code
    } else {
      showToast(`Peer error: ${e.type}`,'‚ùå','red');
      if (btn) { btn.disabled = false; btn.innerHTML = 'üöÄ Generate Code &amp; Start Session'; }
    }
  });
}

/**
 * Pre-compute chunk hashes in the background.
 * Done concurrently with waiting for receivers ‚Äî by the time
 * transfer starts, hashes are likely already computed.
 */
async function computeSenderHashes(blob) {
  const totalChunks = Math.ceil(blob.size / CHUNK_SIZE);
  senderChunkHashes = new Array(totalChunks);
  dbg('HASH',`Pre-computing ${totalChunks} chunk hashes...`);
  for (let i = 0; i < totalChunks; i++) {
    const start  = i * CHUNK_SIZE;
    const buf    = await blob.slice(start, Math.min(start + CHUNK_SIZE, blob.size)).arrayBuffer();
    senderChunkHashes[i] = new Uint8Array(await crypto.subtle.digest('SHA-256', buf));
  }
  dbg('HASH','All chunk hashes ready');
}

function handleSenderControlMsg(connObj, msg) {
  dbg('CTRL',`Sender got msg type="${msg.type}" from ${connObj.id}`);

  if (msg.type === 'hello') {
    /**
     * Receiver announces itself, optionally with a resume offset.
     * fromChunk > 0 means the receiver already has those chunks in IDB.
     */
    connObj.fromChunk = msg.resumeFrom || 0;
    dbg('CTRL',`${connObj.id} resume from chunk ${connObj.fromChunk}`);
    if (connObj._resolveHello) { connObj._resolveHello(); connObj._resolveHello = null; }
  }

  if (msg.type === 'verify') {
    const ok = msg.ok;
    connObj.status = ok ? 'done' : 'error';
    updateReceiverCard(connObj);
    showToast(ok ? `‚úì ${connObj.id} verified transfer` : `‚ö† ${connObj.id} hash mismatch`,
              ok ? '‚úÖ' : '‚ö†Ô∏è', ok ? 'green' : 'red');
    // Mark done on ring if all receivers done
    if (connections.every(c => c.status === 'done' || c.status === 'error')) finishUI(false);
  }

  if (msg.type === 'pause') {
    globalIsPaused = true;
    showToast(`${connObj.id} requested pause`,'‚è∏','amber');
    renderGlobalPauseState(true);
  }

  if (msg.type === 'resume') {
    doGlobalResume();
  }
}

/**
 * Independent send loop for one receiver.
 * Waits briefly for the 'hello' message (which carries resumeFrom),
 * then streams chunks starting at fromChunk.
 */
async function startConnectionLoop(connObj) {
  dbg('XFER',`startConnectionLoop for ${connObj.id}`);
  connObj.status = 'waiting';
  updateReceiverCard(connObj);

  // ‚îÄ‚îÄ Wait for hello message (up to 3s) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  await Promise.race([
    new Promise(r => { connObj._resolveHello = r; }),
    new Promise(r => setTimeout(r, 3000)), // timeout fallback
  ]);

  const { blob, name } = transferBlob;
  const totalChunks    = Math.ceil(totalBytes / CHUNK_SIZE);
  const startChunk     = connObj.fromChunk || 0;

  // ‚îÄ‚îÄ Send META ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const meta = {
    type: 'meta', name,
    size: totalBytes,
    mime: blob.type || 'application/octet-stream',
    chunks: totalChunks,
    fromChunk: startChunk,            // tell receiver to restore IDB chunks [0..startChunk)
    transferId: makeTransferId(name, totalBytes),
  };
  connObj.conn.send(JSON.stringify(meta));
  dbg('XFER',`${connObj.id} META sent (resume from chunk ${startChunk})`);

  connObj.status   = 'active';
  connObj.sentBytes = startChunk * CHUNK_SIZE;
  updateReceiverCard(connObj);
  showSendStep(3);
  renderSenderProgressUI(name);
  xferStart = performance.now();

  // Set DC backpressure threshold
  const rawDC = connObj.conn._dc || connObj.conn.dataChannel;
  if (rawDC) rawDC.bufferedAmountLowThreshold = LOW_WATER;

  // ‚îÄ‚îÄ Chunk loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for (let i = startChunk; i < totalChunks; i++) {

    // Global pause gate
    if (globalIsPaused) {
      dbg('XFER',`${connObj.id} PAUSED at chunk ${i}`);
      await new Promise(r => { pauseResolve = r; });
      dbg('XFER',`${connObj.id} RESUMED`);
    }

    // Per-connection backpressure
    const dc = connObj.conn._dc || connObj.conn.dataChannel;
    if (dc && dc.bufferedAmount > HIGH_WATER) {
      await new Promise(r => {
        if (!dc) return r();
        const h = () => { dc.removeEventListener('bufferedamountlow', h); r(); };
        dc.addEventListener('bufferedamountlow', h);
        setTimeout(() => { dc.removeEventListener('bufferedamountlow', h); r(); }, 10000);
      });
    }

    // Read and send chunk
    const start  = i * CHUNK_SIZE;
    const end    = Math.min(start + CHUNK_SIZE, totalBytes);
    const buffer = await blob.slice(start, end).arrayBuffer();

    try {
      connObj.conn.send(buffer);
    } catch(e) {
      dbgErr('XFER',`${connObj.id} send failed at chunk ${i}:`,e);
      connObj.status = 'error';
      updateReceiverCard(connObj);
      return;
    }

    connObj.sentBytes = end;
    updateReceiverCard(connObj);

    // Tick aggregate speed (sum across all active connections)
    const aggBytes = connections.reduce((s, c) => s + c.sentBytes, 0);
    tickSpeed(aggBytes / connections.length); // normalize to per-receiver

    if (i % 64 === 0 || i === totalChunks - 1) {
      dbg('XFER',`${connObj.id} chunk ${i+1}/${totalChunks}`);
    }
  }

  // ‚îÄ‚îÄ Send DONE with Merkle hash ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const allHashes = await waitForHashes(totalChunks);
  const fileHash  = await computeMerkleHash(allHashes);
  connObj.conn.send(JSON.stringify({ type: 'done', hash: fileHash }));
  dbg('XFER',`${connObj.id} DONE sent, hash=${fileHash.substring(0,16)}...`);
  connObj.status = 'waiting-verify';
  updateReceiverCard(connObj);
}

/** Waits until senderChunkHashes[] is fully populated */
async function waitForHashes(totalChunks) {
  const deadline = Date.now() + 30000;
  while (senderChunkHashes.filter(Boolean).length < totalChunks && Date.now() < deadline) {
    await new Promise(r => setTimeout(r, 100));
  }
  return senderChunkHashes.slice(0, totalChunks);
}

// ‚îÄ‚îÄ Sender Pause/Resume ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pauseAll() {
  globalIsPaused = true;
  renderGlobalPauseState(true);
  connections.forEach(c => {
    try { c.conn.send(JSON.stringify({ type: 'pause' })); } catch(e) {}
  });
  showToast('Transfer paused','‚è∏','amber');
}
function resumeAll() {
  doGlobalResume();
  connections.forEach(c => {
    try { c.conn.send(JSON.stringify({ type: 'resume' })); } catch(e) {}
  });
  showToast('Transfer resumed','‚ñ∂','green');
}
function doGlobalResume() {
  globalIsPaused = false;
  if (pauseResolve) { pauseResolve(); pauseResolve = null; }
  renderGlobalPauseState(false);
}
function renderGlobalPauseState(paused) {
  const btn = $('global-pause-btn');
  if (!btn) return;
  btn.className = paused ? 'btn-resume' : 'btn-pause';
  btn.textContent = paused ? '‚ñ∂ Resume All' : '‚è∏ Pause All';
  btn.onclick = paused ? resumeAll : pauseAll;
}

// ‚îÄ‚îÄ Receiver card management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateReceiverCount() {
  const badge = $('receiver-count-badge');
  const n     = connections.length;
  if (badge) badge.textContent = `${n} connected`;

  // Show/hide waiting indicator
  const waiting  = $('waiting-indicator');
  const rList    = $('receivers-list');
  if (waiting)  waiting.style.display  = n > 0 ? 'none' : 'block';
  if (rList)    rList.style.display    = n > 0 ? 'block' : 'none';
}

function addReceiverCard(connObj) {
  const rList = $('receivers-list');
  if (!rList) return;
  const div = document.createElement('div');
  div.id    = `rcard-${connObj.id}`;
  div.className = 'receiver-card';
  rList.appendChild(div);
  connObj.cardEl = div;
  updateReceiverCard(connObj);
}

function updateReceiverCard(connObj) {
  const card = connObj.cardEl;
  if (!card) return;
  const pct = totalBytes > 0 ? Math.round((connObj.sentBytes / totalBytes) * 100) : 0;
  const statusColor = {
    waiting: 'var(--text-muted)', active: '#7B5CF6', paused: '#f59e0b',
    done: '#22c55e', error: '#ef4444', 'waiting-verify': '#06B6D4',
  }[connObj.status] || '#fff';
  const statusLabel = {
    waiting: 'Waiting', active: `${pct}%`, paused: 'Paused',
    done: '‚úì Done', error: '‚úó Error', 'waiting-verify': 'Verifying...',
  }[connObj.status] || connObj.status;

  card.className = `receiver-card ${connObj.status === 'active' ? 'active-xfer' : connObj.status === 'done' ? 'done-xfer' : ''}`;
  card.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:8px;height:8px;border-radius:50%;background:${statusColor};flex-shrink:0;"></div>
      <span class="mono" style="font-size:12px;font-weight:600;">Receiver ${connObj.id}</span>
      <div style="flex:1;"></div>
      <span style="font-size:12px;font-weight:700;color:${statusColor};">${statusLabel}</span>
      <span class="mono" style="font-size:10px;color:var(--text-muted);">${fmtBytes(connObj.sentBytes)} / ${fmtBytes(totalBytes)}</span>
    </div>
    <div class="mini-bar-track">
      <div class="mini-bar-fill" style="width:${pct}%;${connObj.status==='done'?'background:linear-gradient(90deg,#22c55e,#16a34a)':''}"></div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS ‚Äî RECEIVER
//
//  RESUME FLOW:
//  1. Check IDB for any partial transfer matching this session.
//  2. On connection open: send {type:'hello', resumeFrom: N}.
//     N = 0 for fresh transfer, or chunk count from IDB for resume.
//  3. Load IDB chunks [0..N) back into inChunks[] so they don't
//     need to be re-downloaded.
//  4. Sender starts sending from chunk N.
//  5. Each chunk received: stored in inChunks[idx] AND written to IDB.
//  6. On 'done': assemble, verify, download, clear IDB.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectToSender() {
  const code = ($('code-input')?.value || '').trim().toUpperCase();
  dbg('PEER',`connectToSender() code="${code}"`);
  if (code.length !== 6) { showToast('Enter a 6-character code','‚ö†Ô∏è','red'); return; }

  const btn = $('btn-connect');
  if (btn) { btn.disabled = true; btn.textContent = 'Connecting...'; }

  const iceCfg = buildIceConfig('r');
  peer = new Peer({ config: iceCfg, debug: 0 });

  peer.on('open', myId => {
    dbg('PEER',`Receiver peer open myId="${myId}" ‚Üí connecting to "${code}"`);
    recvConn = peer.connect(code, { reliable: true, serialization: 'raw' });

    recvConn.on('open', async () => {
      dbg('PEER','Connected to sender');
      showFlex('conn-badge');
      const labelEl = $('conn-label');
      if (labelEl) { labelEl.textContent = 'Connected'; labelEl.style.color = '#06B6D4'; }

      showReceiveStep(2);
      renderReceiveWaiting();
      setupReceiverDC();

      // ‚îÄ‚îÄ Announce ourselves with optional resume offset ‚îÄ‚îÄ
      const banner     = $('resume-banner');
      const resumeMeta = banner?._resumeMeta;
      recvFromChunk    = resumeMeta ? resumeMeta.receivedCount : 0;

      // If resuming, pre-load IDB chunks into memory
      if (resumeMeta && recvFromChunk > 0) {
        dbg('RESUME',`Loading ${recvFromChunk} chunks from IDB...`);
        showToast(`Resuming from ${Math.round(recvFromChunk / resumeMeta.totalChunks * 100)}%...`, '‚è©','cyan');
        // We'll load them after META arrives (when we know totalChunks)
        // For now, store resumeMeta for later use
        recvConn._resumeMeta = resumeMeta;
      }

      recvConn.send(JSON.stringify({ type: 'hello', resumeFrom: recvFromChunk }));
      dbg('RECV',`Sent hello, resumeFrom=${recvFromChunk}`);
    });

    recvConn.on('error', e => {
      dbgErr('CONN','Recv conn error:',e);
      showToast('Connection failed ‚Äî check code','‚ùå','red');
      if (btn) { btn.disabled = false; btn.textContent = 'üîó Connect & Receive'; }
    });

    recvConn.on('close', () => {
      dbgWarn('CONN','Receiver connection closed');
      if (inMeta && recvBytes < totalBytes) {
        // Save state to IDB before disconnecting
        IDB.saveMeta({
          transferId:    inMeta.transferId,
          name:          inMeta.name,
          size:          inMeta.size,
          mime:          inMeta.mime,
          totalChunks:   inMeta.chunks,
          receivedCount: inChunks.filter(Boolean).length,
        }).then(() => dbg('IDB','Transfer state saved for resume'));
        showToast('Connection dropped ‚Äî re-enter code to resume','üì°','amber');
      } else {
        onDisconnect();
      }
    });
  });

  peer.on('error', e => {
    dbgErr('PEER','Receiver peer error:',e);
    const msg = e.type === 'peer-unavailable'
      ? `Code "${code}" not found ‚Äî check code` : `Error: ${e.type}`;
    showToast(msg,'‚ùå','red');
    if (btn) { btn.disabled = false; btn.textContent = 'üîó Connect & Receive'; }
  });
}

function setupReceiverDC() {
  recvConn.on('data', data => handleIncoming(data));
  dbg('RECV','Receiver DC handler attached');
}

function renderReceiveWaiting() {
  const el = $('recv-progress-area');
  if (el) el.innerHTML = `
    <div class="glass-card" style="padding:32px;text-align:center;">
      <div class="pulse-wrap" style="width:64px;height:64px;margin:0 auto 20px;position:relative;">
        <div class="pulse-ring-el" style="background:rgba(6,182,212,0.15);inset:0;position:absolute;border-radius:50%;"></div>
        <div class="pulse-core" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
          background:rgba(6,182,212,0.2);border:1px solid rgba(6,182,212,0.3);position:relative;z-index:1;font-size:18px;">üì°</div>
      </div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px;">Connected ‚Äî waiting for file...</div>
      <div style="font-size:13px;color:var(--text-muted);">Sender will start the transfer momentarily</div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECEIVE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleIncoming(data) {
  if (typeof data === 'string') {
    let msg;
    try { msg = JSON.parse(data); } catch(e) { return; }

    if (msg.type === 'meta') {
      dbg('RECV','‚ïê‚ïê‚ïê META ‚ïê‚ïê‚ïê', msg);
      inMeta    = { ...msg, transferId: msg.transferId || makeTransferId(msg.name, msg.size) };
      totalBytes = msg.size;
      recvBytes  = 0;
      recvChunkHashes = [];
      speedWindow  = [];
      speedHistory = [];
      lastPerfTime = xferStart = performance.now();
      lastPerfBytes = 0;
      recvIsPaused  = false;

      // If resuming: restore chunks from IDB
      const resumeMeta = recvConn?._resumeMeta;
      if (resumeMeta && msg.fromChunk > 0) {
        inChunks   = new Array(msg.chunks).fill(null);
        recvBytes  = 0;
        dbg('RESUME',`Loading ${msg.fromChunk} chunks from IDB for resume...`);
        const stored = await IDB.loadChunks(inMeta.transferId, msg.chunks);
        for (let i = 0; i < msg.fromChunk; i++) {
          if (stored[i]) {
            inChunks[i] = stored[i];
            recvBytes  += stored[i].byteLength;
          }
        }
        dbg('RESUME',`Restored ${inChunks.filter(Boolean).length} chunks (${fmtBytes(recvBytes)})`);
      } else {
        inChunks = new Array(msg.chunks).fill(null);
      }

      // Save meta to IDB immediately
      await IDB.saveMeta({
        transferId:    inMeta.transferId,
        name:          msg.name,
        size:          msg.size,
        mime:          msg.mime,
        totalChunks:   msg.chunks,
        receivedCount: msg.fromChunk || 0,
      });

      renderReceiverProgressUI('recv-progress-area', msg.name);
      updateRing(recvBytes / totalBytes);
    }

    if (msg.type === 'done') {
      dbg('RECV','‚ïê‚ïê‚ïê DONE ‚ïê‚ïê‚ïê', msg.hash?.substring(0,16));
      assembleAndDownload(msg.hash);
    }

    if (msg.type === 'pause') {
      dbg('RECV','Sender paused');
      const st = $('xfer-status');
      if (st) { st.textContent = '‚è∏ Sender paused'; st.style.color = '#f59e0b'; }
    }

    if (msg.type === 'resume') {
      const st = $('xfer-status');
      if (st) { st.textContent = 'Receiving...'; st.style.color = 'var(--text-muted)'; }
    }

  } else if (data instanceof ArrayBuffer || data instanceof Uint8Array) {
    const buf = data instanceof Uint8Array ? data.buffer : data;

    // Find first null slot (in-order SCTP delivery means sequential fill)
    const idx = inChunks.findIndex(c => c === null);
    if (idx === -1) { dbgWarn('RECV','Unexpected extra chunk'); return; }

    inChunks[idx] = buf;
    recvBytes += buf.byteLength;

    // Hash chunk (async, keyed by idx for ordering)
    const chunkIdx = idx;
    crypto.subtle.digest('SHA-256', buf).then(h => {
      recvChunkHashes[chunkIdx] = new Uint8Array(h);
    });

    // Non-blocking IDB persist (fire-and-forget)
    if (inMeta) {
      IDB.saveChunk(inMeta.transferId, idx, buf).catch(() => {});
      // Update IDB meta receivedCount every 64 chunks
      if (idx % 64 === 0) {
        IDB.saveMeta({ ...inMeta, receivedCount: idx + 1,
          totalChunks: inMeta.chunks, timestamp: Date.now() }).catch(() => {});
      }
    }

    if (idx % 64 === 0) dbg('RECV',`Chunk #${idx} | ${fmtBytes(recvBytes)}/${fmtBytes(totalBytes)}`);
    tickSpeed(recvBytes);
    updateRing(recvBytes / totalBytes);
  }
}

async function assembleAndDownload(expectedHash) {
  dbg('RECV',`assembleAndDownload() hash=${expectedHash?.substring(0,16)}`);

  // Wait for all chunk hashes (up to 5s)
  const totalChunks = inChunks.length;
  const deadline    = Date.now() + 5000;
  while (recvChunkHashes.filter(Boolean).length < totalChunks && Date.now() < deadline) {
    await new Promise(r => setTimeout(r, 50));
  }

  const hashEl = $('hash-status');
  if (hashEl) {
    hashEl.style.display = 'block';
    hashEl.className     = 'hash-wait';
    hashEl.innerHTML     = '<span style="color:#f59e0b;font-weight:600;">üîê Verifying SHA-256 integrity...</span>';
  }

  let hashOk = false, actualHash = '';
  try {
    const validHashes = recvChunkHashes.slice(0, totalChunks).filter(Boolean);
    actualHash = await computeMerkleHash(validHashes);
    hashOk     = (actualHash === expectedHash && validHashes.length === totalChunks);
    dbg('RECV',`Hash ok=${hashOk}`);
  } catch(e) { dbgErr('RECV','Hash error:',e); }

  // Download
  const blob = new Blob(inChunks.filter(Boolean), { type: inMeta?.mime || 'application/octet-stream' });
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement('a'), { href: url, download: inMeta?.name || 'download' });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
  dbg('RECV',`Downloaded: "${inMeta?.name}" ${fmtBytes(blob.size)}`);

  // Update hash UI
  if (hashEl) {
    hashEl.className = hashOk ? 'hash-ok' : 'hash-fail';
    hashEl.innerHTML = hashOk
      ? `<span style="color:#22c55e;font-weight:600;">‚úì SHA-256 verified ‚Äî file intact</span><br/>
         <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.3);">${actualHash.substring(0,32)}...</span>`
      : `<span style="color:#ef4444;font-weight:600;">‚úó Hash mismatch ‚Äî data may be corrupt</span>`;
  }

  // Send verify ACK to sender
  if (recvConn) recvConn.send(JSON.stringify({ type: 'verify', ok: hashOk, hash: actualHash }));

  // Clear IDB on success
  if (hashOk && inMeta) IDB.clearTransfer(inMeta.transferId);

  showToast(hashOk ? `‚úì ${inMeta?.name} downloaded` : '‚ö† Download done ‚Äî hash mismatch',
            hashOk ? '‚úÖ' : '‚ö†Ô∏è', hashOk ? 'green' : 'red');
  finishUI(hashOk);
  inChunks = []; recvChunkHashes = [];
}

// ‚îÄ‚îÄ Receiver Pause/Resume ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function recvPause() {
  recvIsPaused = true;
  if (recvConn) recvConn.send(JSON.stringify({ type: 'pause' }));
  const btn = $('pause-btn');
  if (btn) { btn.className = 'btn-resume'; btn.textContent = '‚ñ∂ Resume'; btn.onclick = recvResume; }
  const st = $('xfer-status');
  if (st) { st.textContent = '‚è∏ Paused'; st.style.color = '#f59e0b'; }
}
function recvResume() {
  recvIsPaused = false;
  if (recvConn) recvConn.send(JSON.stringify({ type: 'resume' }));
  const btn = $('pause-btn');
  if (btn) { btn.className = 'btn-pause'; btn.textContent = '‚è∏ Pause'; btn.onclick = recvPause; }
  const st = $('xfer-status');
  if (st) { st.textContent = 'Receiving...'; st.style.color = 'var(--text-muted)'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS UI ‚Äî SENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSenderProgressUI(filename) {
  const el = $('sender-progress-area');
  if (!el || el.dataset.rendered) return; // render once
  el.dataset.rendered = '1';
  const circ = (2 * Math.PI * 44).toFixed(2);

  el.innerHTML = `
    <div class="glass-card" style="padding:20px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:104px;height:104px;">
          <svg width="104" height="104" viewBox="0 0 104 104">
            <defs>
              <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#7B5CF6"/>
                <stop offset="100%" stop-color="#2563eb"/>
              </linearGradient>
            </defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:20px;font-weight:800;">0%</span>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.75);margin-bottom:6px;">${escHtml(filename)}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div class="conn-dot" style="width:8px;height:8px;border-radius:50%;background:#22c55e;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">Sending...</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:6px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:28px;font-weight:700;color:var(--violet);line-height:1;">0.00</span>
            <span style="font-size:13px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:4px;">0 B / ${fmtBytes(totalBytes)}</div>
        </div>
      </div>

      <div class="label" style="margin-bottom:8px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:40px;"></div>
      <div style="display:flex;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>

      <!-- Global pause/resume -->
      <div style="margin-top:16px;text-align:center;">
        <button id="global-pause-btn" class="btn-pause" style="padding:10px 28px;font-size:13px;"
          onclick="pauseAll()">‚è∏ Pause All</button>
      </div>
    </div>

    <!-- Per-receiver list -->
    <div class="glass-card" style="padding:16px;margin-bottom:16px;">
      <div class="label" style="margin-bottom:12px;">Receivers</div>
      <div id="sender-receivers-list"></div>
    </div>

    <div id="verify-status" style="margin-bottom:12px;"></div>`;

  // Mirror receiver cards here too
  setTimeout(() => {
    const srl = $('sender-receivers-list');
    if (!srl) return;
    connections.forEach(c => {
      const div = document.createElement('div');
      div.id    = `rcard-${c.id}`;
      div.className = 'receiver-card';
      srl.appendChild(div);
      c.cardEl = div;
      updateReceiverCard(c);
    });
  }, 50);

  startElapsedTimer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS UI ‚Äî RECEIVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReceiverProgressUI(containerId, filename) {
  const el = $(containerId);
  if (!el) return;
  const circ = (2 * Math.PI * 44).toFixed(2);

  el.innerHTML = `
    <div class="glass-card" style="padding:20px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:104px;height:104px;">
          <svg width="104" height="104" viewBox="0 0 104 104">
            <defs>
              <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#06B6D4"/>
                <stop offset="100%" stop-color="#7B5CF6"/>
              </linearGradient>
            </defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:20px;font-weight:800;">0%</span>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.75);margin-bottom:6px;">${escHtml(filename)}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div class="conn-dot" style="width:8px;height:8px;border-radius:50%;background:#06B6D4;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">Receiving...</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:6px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:28px;font-weight:700;color:var(--cyan);line-height:1;">0.00</span>
            <span style="font-size:13px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:4px;">0 B / ${fmtBytes(totalBytes)}</div>
        </div>
      </div>

      <div class="label" style="margin-bottom:8px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:40px;"></div>
      <div style="display:flex;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>

      <div style="margin-top:16px;text-align:center;">
        <button id="pause-btn" class="btn-pause" style="padding:10px 28px;font-size:13px;" onclick="recvPause()">‚è∏ Pause</button>
      </div>
    </div>

    <div id="hash-status" class="hash-wait" style="display:none;margin-bottom:12px;">
      <span style="color:#f59e0b;font-weight:600;">üîê Awaiting hash...</span>
    </div>`;

  startElapsedTimer();
  // If resuming, pre-fill ring
  if (recvBytes > 0 && totalBytes > 0) updateRing(recvBytes / totalBytes);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPEED & PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickSpeed(bytes) {
  const now = performance.now();
  const dt  = (now - lastPerfTime) / 1000;
  if (dt < 0.15) return;
  const rate = (bytes - lastPerfBytes) / dt;
  if (rate < 0) return;
  speedWindow.push(rate);
  if (speedWindow.length > 10) speedWindow.shift();
  speedHistory.push(rate);
  if (speedHistory.length > 28) speedHistory.shift();
  lastPerfTime  = now;
  lastPerfBytes = bytes;
  paintSpeed(bytes);
}

function paintSpeed(bytes) {
  const avg  = speedWindow.reduce((a,b) => a+b, 0) / (speedWindow.length || 1);
  const mbps = avg / (1024 * 1024);
  const sv   = $('speed-val'); if (sv) sv.textContent = mbps.toFixed(2);
  const bl   = $('bytes-lbl'); if (bl) bl.textContent = `${fmtBytes(bytes)} / ${fmtBytes(totalBytes)}`;
  const eta  = $('eta-lbl');
  if (eta && avg > 0) {
    const rem = totalBytes - bytes;
    const s   = rem / avg;
    eta.textContent = s < 60 ? `~${s.toFixed(0)}s remaining` : `~${(s/60).toFixed(1)}m remaining`;
  }
  // Bar chart
  const barsEl = $('speed-bars'); if (!barsEl) return;
  const arr    = speedHistory;
  const maxSpd = Math.max(...arr, 1);
  const pad    = 28 - arr.length;
  barsEl.innerHTML = [...Array(pad).fill(0), ...arr].map(s => {
    const f  = s / maxSpd;
    const h  = Math.max(3, f * 38);
    const r  = Math.round(73 + f * 95);
    const g  = Math.round(40 + f * 20);
    const op = (0.3 + f * 0.7).toFixed(2);
    return `<div class="speed-bar" style="flex:1;height:${h.toFixed(1)}px;background:rgb(${r},${g},246);opacity:${op};"></div>`;
  }).join('');
}

function updateRing(pct) {
  const ring  = $('ring-fill');
  const pctEl = $('ring-pct');
  if (!ring) return;
  const circ = 2 * Math.PI * 44;
  ring.style.strokeDashoffset = (circ * (1 - pct)).toFixed(2);
  const avg    = speedWindow.length ? speedWindow.reduce((a,b) => a+b,0)/speedWindow.length : 0;
  const mbps   = avg / (1024 * 1024);
  const glowPx = Math.min(3 + mbps * 1.2, 30);
  const glowOp = Math.min(0.4 + mbps * 0.04, 0.95).toFixed(2);
  const wrap = $('ring-wrap');
  if (wrap) wrap.style.filter = `drop-shadow(0 0 ${glowPx.toFixed(1)}px rgba(123,92,246,${glowOp}))`;
  if (pctEl) pctEl.textContent = `${Math.round(pct * 100)}%`;
}

function finishUI(hashOk) {
  clearInterval(elapsedTimer);
  updateRing(1);
  const s = $('xfer-status');
  if (s) { s.textContent = isSender ? '‚úì Sent' : '‚úì Downloaded'; s.style.color = '#22c55e'; }
  const hashEl = $('hash-status');
  if (hashEl && !isSender) hashEl.style.display = 'block';
  const pbtn = $('pause-btn');
  if (pbtn) { pbtn.disabled = true; pbtn.style.opacity = '0.4'; }
  const gpbtn = $('global-pause-btn');
  if (gpbtn) { gpbtn.disabled = true; gpbtn.style.opacity = '0.4'; }
}

function startElapsedTimer() {
  clearInterval(elapsedTimer);
  elapsedTimer = setInterval(() => {
    const el = $('elapsed-lbl');
    if (el) el.textContent = `${((performance.now() - xferStart) / 1000).toFixed(1)}s elapsed`;
  }, 500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLEANUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cleanup() {
  clearInterval(elapsedTimer);
  globalIsPaused = false; recvIsPaused = false;
  if (pauseResolve) { pauseResolve(); pauseResolve = null; }
  connections.forEach(c => { try { c.conn.close(); } catch(e) {} });
  connections = [];
  if (recvConn) { try { recvConn.close(); } catch(e) {} recvConn = null; }
  if (peer)     { try { peer.destroy();    } catch(e) {} peer = null; }
  selectedFiles = []; inChunks = []; recvChunkHashes = []; senderChunkHashes = [];
  speedWindow   = []; speedHistory = [];
  totalBytes = recvBytes = 0;
  inMeta = null; transferBlob = null; myCode = null;
}

function onDisconnect() {
  clearInterval(elapsedTimer);
  hide('conn-badge');
  showToast('Connection dropped','üì°','red');
  const s = $('xfer-status');
  if (s) { s.textContent = '‚ö† Disconnected'; s.style.color = '#ef4444'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _toastTimer = null;
function showToast(msg, icon, color) {
  const toast  = $('toast');
  const iconEl = $('toast-icon-el');
  const msgEl  = $('toast-msg');
  if (!toast) return;
  if (iconEl) iconEl.textContent = icon || '‚Ñπ';
  if (msgEl)  msgEl.textContent  = msg;
  toast.style.display = 'flex';
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { toast.style.display = 'none'; }, 4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function boot() {
  dbg('BOOT','boot()');
  // Init IDB (non-blocking ‚Äî graceful failure if unavailable)
  try {
    await IDB.init();
    dbg('IDB','IndexedDB initialized');
  } catch(e) {
    dbgWarn('IDB','IndexedDB unavailable ‚Äî resume disabled:', e.message);
  }

  // Dependency checks
  const deps = {
    'WebRTC':    typeof RTCPeerConnection !== 'undefined',
    'PeerJS':    typeof Peer              !== 'undefined',
    'JSZip':     typeof JSZip             !== 'undefined',
    'Web Crypto':typeof crypto?.subtle    !== 'undefined',
    'IndexedDB': typeof indexedDB         !== 'undefined',
  };
  for (const [n, ok] of Object.entries(deps)) dbg('DEPS',`${ok?'‚úî':'‚úò'} ${n}`);
  if (!deps['WebRTC'])   showToast('WebRTC not supported','‚ùå','red');
  if (!deps['PeerJS'])   showToast('PeerJS failed to load ‚Äî check internet','‚ùå','red');

  showToast('GhostShare v4 ready üëª','üëª','violet');
  dbg('BOOT','‚úÖ Initialized');
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', boot);
} else {
  boot();
}
</script>
</body>
</html>
