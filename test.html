<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GhostShare ‚Äî P2P File Transfer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --violet: #7B5CF6;
      --violet-dim: rgba(123,92,246,0.15);
      --cyan: #06B6D4;
      --cyan-dim: rgba(6,182,212,0.15);
      --green: #22c55e;
      --amber: #f59e0b;
      --red: #ef4444;
      --bg: #030610;
      --surface: rgba(255,255,255,0.028);
      --border: rgba(255,255,255,0.07);
      --border-glow: rgba(123,92,246,0.35);
      --text-muted: rgba(255,255,255,0.38);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html{scroll-behavior:smooth;}
    body{font-family:'Outfit',sans-serif;background-color:var(--bg);color:#fff;min-height:100vh;overflow-x:hidden;}
    body::before{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        radial-gradient(ellipse 60% 50% at 15% 40%, rgba(123,92,246,0.12) 0%, transparent 70%),
        radial-gradient(ellipse 50% 60% at 85% 20%, rgba(6,182,212,0.08) 0%, transparent 65%),
        radial-gradient(ellipse 40% 40% at 50% 90%, rgba(123,92,246,0.06) 0%, transparent 60%);
    }
    body::after{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),
        linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
      background-size:48px 48px;
      mask-image:radial-gradient(ellipse at center,black 30%,transparent 80%);
    }

    /* ‚îÄ‚îÄ GLASS ‚îÄ‚îÄ */
    .glass{background:var(--surface);border:1px solid var(--border);backdrop-filter:blur(24px);}
    .glass-card{
      background:rgba(255,255,255,0.035);border:1px solid var(--border);
      backdrop-filter:blur(20px);border-radius:16px;transition:border-color 0.3s;
    }
    .glass-card:hover{border-color:var(--border-glow);}

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-primary{
      background:linear-gradient(135deg,#6d40f5 0%,#2563eb 100%);
      border:1px solid rgba(109,64,245,0.5);border-radius:12px;
      font-weight:600;cursor:pointer;position:relative;overflow:hidden;color:#fff;
      transition:transform 0.2s,box-shadow 0.3s;
    }
    .btn-primary::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);transition:left 0.45s ease;}
    .btn-primary:hover::before{left:100%;}
    .btn-primary:hover{box-shadow:0 0 28px rgba(109,64,245,0.55),0 4px 20px rgba(0,0,0,0.4);transform:translateY(-1px);}
    .btn-primary:active{transform:translateY(0);}
    .btn-primary:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none;}
    .btn-ghost{background:rgba(255,255,255,0.045);border:1px solid var(--border);border-radius:10px;cursor:pointer;color:#fff;transition:background 0.2s,border-color 0.2s;}
    .btn-ghost:hover{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.14);}
    .btn-pause{background:rgba(234,179,8,0.12);border:1px solid rgba(234,179,8,0.3);border-radius:10px;cursor:pointer;color:#f59e0b;font-weight:600;transition:background 0.2s;}
    .btn-pause:hover{background:rgba(234,179,8,0.2);}
    .btn-resume{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);border-radius:10px;cursor:pointer;color:#22c55e;font-weight:600;transition:background 0.2s;}
    .btn-resume:hover{background:rgba(34,197,94,0.2);}
    .btn-danger{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);border-radius:10px;cursor:pointer;color:#ef4444;font-weight:600;transition:background 0.2s;}
    .btn-danger:hover{background:rgba(239,68,68,0.2);}
    .btn-amber{background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.3);border-radius:10px;cursor:pointer;color:#f59e0b;font-weight:600;transition:background 0.2s;}
    .btn-amber:hover{background:rgba(245,158,11,0.2);}

    /* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
    .mono{font-family:'JetBrains Mono',monospace;}
    .label{font-size:11px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);}

    /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
    textarea,input[type="text"],input[type="url"],input[type="password"]{
      font-family:'JetBrains Mono',monospace;font-size:11px;
      background:rgba(0,0,0,0.4);border:1px solid var(--border);
      color:rgba(255,255,255,0.8);outline:none;border-radius:10px;
      transition:border-color 0.25s,box-shadow 0.25s;resize:none;
    }
    textarea:focus,input:focus{border-color:rgba(123,92,246,0.5);box-shadow:0 0 0 3px rgba(123,92,246,0.1);}
    textarea::placeholder,input::placeholder{color:rgba(255,255,255,0.2);}

    /* ‚îÄ‚îÄ TOGGLE SWITCH ‚îÄ‚îÄ */
    .toggle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;}
    .toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;}
    .toggle-switch input{opacity:0;width:0;height:0;}
    .toggle-slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:22px;transition:all 0.25s;}
    .toggle-slider:before{content:'';position:absolute;width:16px;height:16px;left:2px;bottom:2px;background:rgba(255,255,255,0.4);border-radius:50%;transition:all 0.25s;}
    input:checked+.toggle-slider{background:rgba(123,92,246,0.35);border-color:rgba(123,92,246,0.5);box-shadow:0 0 10px rgba(123,92,246,0.3);}
    input:checked+.toggle-slider:before{transform:translateX(18px);background:#fff;}
    .toggle-label-text{font-size:13px;font-weight:500;color:rgba(255,255,255,0.8);}
    .toggle-sub{font-size:11px;color:var(--text-muted);margin-top:2px;}

    /* ‚îÄ‚îÄ CODE DISPLAY BOXES ‚îÄ‚îÄ */
    .code-boxes{display:flex;gap:8px;justify-content:center;margin:8px 0;}
    .code-box{
      width:52px;height:64px;display:flex;align-items:center;justify-content:center;
      font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;
      background:rgba(123,92,246,0.1);border:1.5px solid rgba(123,92,246,0.35);
      border-radius:14px;color:#fff;animation:codeGlow 2.5s ease-in-out infinite alternate;
    }
    @keyframes codeGlow{
      from{box-shadow:0 0 8px rgba(123,92,246,0.2);border-color:rgba(123,92,246,0.35);}
      to{box-shadow:0 0 22px rgba(123,92,246,0.55),inset 0 0 8px rgba(123,92,246,0.08);border-color:rgba(123,92,246,0.7);}
    }
    .code-input-field{
      font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;
      letter-spacing:0.35em;text-align:center;text-transform:uppercase;
      padding:18px 24px;background:rgba(0,0,0,0.5);border:1.5px solid var(--border);
      border-radius:16px;width:100%;color:#fff;outline:none;transition:border-color 0.25s,box-shadow 0.25s;
    }
    .code-input-field:focus{border-color:rgba(123,92,246,0.6);box-shadow:0 0 0 4px rgba(123,92,246,0.12),0 0 30px rgba(123,92,246,0.15);}
    .code-input-field::placeholder{color:rgba(255,255,255,0.12);letter-spacing:0.4em;}

    /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
    .screen{display:none;position:relative;z-index:1;}
    .screen.active{display:block;animation:fadeUp 0.4s cubic-bezier(0.16,1,0.3,1);}
    @keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes logoPulse{0%,100%{box-shadow:0 0 0 0 rgba(123,92,246,0.5);}50%{box-shadow:0 0 0 10px rgba(123,92,246,0);}}
    .logo-icon{animation:logoPulse 3s ease-in-out infinite;}
    @keyframes connectedPulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.6);}50%{box-shadow:0 0 0 5px rgba(34,197,94,0);}}
    .conn-dot{animation:connectedPulse 2s ease-in-out infinite;}
    @keyframes activePulseRing{0%{transform:scale(0.85);opacity:0.8;}100%{transform:scale(1.5);opacity:0;}}
    @keyframes activePulseDot{0%,100%{transform:scale(1);}50%{transform:scale(1.12);}}
    .pulse-wrap{position:relative;display:flex;align-items:center;justify-content:center;}
    .pulse-ring-el{position:absolute;inset:0;border-radius:50%;animation:activePulseRing 1.8s cubic-bezier(0.215,0.61,0.355,1) infinite;}
    .pulse-core{animation:activePulseDot 2.2s ease-in-out infinite;}
    @keyframes floatY{0%,100%{transform:translateY(0) rotate(-2deg);}50%{transform:translateY(-8px) rotate(2deg);}}
    .float-icon{animation:floatY 4s ease-in-out infinite;}
    @keyframes barPulse{0%,100%{opacity:.8}50%{opacity:1}}
    .speed-bar{animation:barPulse 1.1s ease-in-out infinite;border-radius:3px 3px 0 0;}
    @keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
    .shimmer-text{background:linear-gradient(90deg,#a78bfa,#38bdf8,#a78bfa);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite;}
    @keyframes destructFlash{0%,100%{opacity:1;}50%{opacity:0.3;}}
    .destruct-anim{animation:destructFlash 0.3s ease-in-out 4;}
    @keyframes pairPulse{0%,100%{box-shadow:0 0 0 0 rgba(6,182,212,0.5);}50%{box-shadow:0 0 0 6px rgba(6,182,212,0);}}
    .pair-dot-pulse{animation:pairPulse 2s ease-in-out infinite;}

    /* ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ */
    .progress-ring-track{fill:none;stroke:rgba(255,255,255,0.04);stroke-width:7;}
    .progress-ring-fill{fill:none;stroke-width:7;stroke:url(#ringGradient);stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset 0.35s ease;}

    /* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
    .drop-zone{border:2px dashed rgba(123,92,246,0.3);transition:all 0.3s;cursor:pointer;}
    .drop-zone:hover,.drop-zone.drag-active{border-color:rgba(123,92,246,0.7);background:rgba(123,92,246,0.04);}
    .drop-zone-link{border:2px dashed rgba(6,182,212,0.3);transition:all 0.3s;cursor:pointer;border-radius:16px;}
    .drop-zone-link:hover,.drop-zone-link.drag-active{border-color:rgba(6,182,212,0.7);background:rgba(6,182,212,0.04);}

    /* ‚îÄ‚îÄ STEP DOTS ‚îÄ‚îÄ */
    .step-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.12);transition:all 0.3s;}
    .step-dot.active{background:var(--violet);box-shadow:0 0 8px rgba(123,92,246,0.7);}

    /* ‚îÄ‚îÄ CONFIG PANEL ‚îÄ‚îÄ */
    .config-content{overflow:hidden;max-height:0;transition:max-height 0.4s cubic-bezier(0.16,1,0.3,1);}
    .config-content.open{max-height:700px;}

    /* ‚îÄ‚îÄ HASH STATUS ‚îÄ‚îÄ */
    .hash-ok{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);border-radius:10px;padding:10px 14px;}
    .hash-fail{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:10px;padding:10px 14px;}
    .hash-wait{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);border-radius:10px;padding:10px 14px;}

    /* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
    .mode-toggle{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:999px;padding:3px;cursor:pointer;user-select:none;}
    .mode-toggle-opt{font-size:11px;font-weight:600;padding:4px 9px;border-radius:999px;transition:all 0.2s;color:var(--text-muted);}
    .mode-toggle-opt.active{background:rgba(123,92,246,0.25);color:#fff;box-shadow:0 0 12px rgba(123,92,246,0.3);}
    .mode-toggle-opt.global.active{background:rgba(6,182,212,0.25);color:#fff;box-shadow:0 0 12px rgba(6,182,212,0.3);}

    /* ‚îÄ‚îÄ RESUME BANNER ‚îÄ‚îÄ */
    .resume-banner{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:14px;padding:14px 18px;margin-bottom:16px;}

    /* ‚îÄ‚îÄ RECEIVER CARD ‚îÄ‚îÄ */
    .receiver-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;margin-bottom:8px;transition:border-color 0.3s;}
    .receiver-card.active-xfer{border-color:rgba(123,92,246,0.3);}
    .receiver-card.done-xfer{border-color:rgba(34,197,94,0.3);}
    .mini-bar-track{height:4px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;margin-top:8px;}
    .mini-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#7B5CF6,#2563eb);transition:width 0.35s ease;}

    /* ‚îÄ‚îÄ LINK PAIR CARD ‚îÄ‚îÄ */
    .link-token-display{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;letter-spacing:0.25em;color:#fff;}

    /* ‚îÄ‚îÄ ENC BADGE ‚îÄ‚îÄ */
    .enc-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;
      background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);font-size:10px;font-weight:600;color:#22c55e;}
    .destruct-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;
      background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);font-size:10px;font-weight:600;color:#ef4444;}

    /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:rgba(123,92,246,0.4);border-radius:2px;}

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    @keyframes toastIn{from{opacity:0;transform:translate(-50%,20px);}to{opacity:1;transform:translate(-50%,0);}}
    #toast.visible{animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);}

    /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
    .badge-violet{background:var(--violet-dim);border:1px solid rgba(123,92,246,0.25);}
    .badge-cyan{background:var(--cyan-dim);border:1px solid rgba(6,182,212,0.25);}
    .badge-green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);}
    .badge-red{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);}
  </style>
</head>
<body>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-5 py-3"
  style="background:rgba(3,6,16,0.75);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);">
  <div class="flex items-center gap-3">
    <div class="logo-icon w-8 h-8 rounded-xl flex items-center justify-center"
      style="background:linear-gradient(135deg,#7B5CF6,#2563eb);font-size:16px;">üëª</div>
    <span style="font-weight:800;font-size:15px;letter-spacing:-0.02em;">Ghost<span style="color:var(--violet);">Share</span></span>
    <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.2);">v5.0</span>
  </div>

  <div style="display:flex;align-items:center;gap:8px;">
    <!-- Local / Global mode toggle -->
    <div class="mode-toggle" onclick="toggleMode()" title="Local = STUN only ¬∑ Global = adds free TURN relay">
      <div class="mode-toggle-opt active" id="mode-local">üì∂ Local</div>
      <div class="mode-toggle-opt global" id="mode-global">üåê Global</div>
    </div>

    <!-- Link pair badge ‚Äî shown when partner is online -->
    <div id="link-badge" style="display:none;align-items:center;gap:6px;padding:5px 11px;border-radius:999px;
      background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);cursor:pointer;" onclick="goHome()">
      <div class="pair-dot-pulse" style="width:7px;height:7px;border-radius:50%;background:#06B6D4;flex-shrink:0;"></div>
      <span style="font-size:11px;font-weight:700;color:#06B6D4;">Paired</span>
    </div>

    <!-- Transfer connected badge -->
    <div id="conn-badge" style="display:none;align-items:center;gap:6px;padding:5px 11px;border-radius:999px;
      background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);">
      <div class="conn-dot w-2 h-2 rounded-full" style="background:#22c55e;"></div>
      <span style="font-size:11px;font-weight:600;color:#22c55e;" id="conn-label">Connected</span>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main style="padding-top:80px;padding-bottom:64px;padding-left:16px;padding-right:16px;max-width:640px;margin:0 auto;">

  <!-- ‚ïê‚ïê‚ïê‚ïê LANDING ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-landing" class="screen active">
    <div class="text-center" style="padding:36px 0 24px;">
      <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full mb-6"
        style="background:rgba(255,255,255,0.04);border:1px solid var(--border);">
        <span style="width:6px;height:6px;border-radius:50%;background:var(--violet);display:inline-block;box-shadow:0 0 8px var(--violet);"></span>
        <span style="font-size:12px;color:var(--text-muted);">6-char code ¬∑ Zero server ¬∑ Pure P2P</span>
      </div>
      <h1 style="font-size:52px;font-weight:900;letter-spacing:-0.04em;line-height:1.05;margin-bottom:14px;">
        Ghost<span class="shimmer-text">Share</span>
      </h1>
      <p style="color:var(--text-muted);font-size:16px;line-height:1.6;max-width:360px;margin:0 auto 10px;">
        Share a 6-character code. No accounts, no uploads, no limits.
      </p>
      <p style="font-family:'JetBrains Mono';font-size:13px;color:var(--violet);margin-bottom:32px;opacity:0.8;">
        A1B2C3 ‚Üí instant encrypted transfer
      </p>

      <!-- Send / Receive buttons -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
        <button onclick="initSend()" class="glass-card text-left" style="padding:24px;cursor:pointer;">
          <div style="width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;
            margin-bottom:16px;background:rgba(123,92,246,0.15);border:1px solid rgba(123,92,246,0.2);font-size:20px;">üì§</div>
          <div style="font-size:16px;font-weight:700;margin-bottom:4px;">Send Files</div>
          <div style="font-size:12px;color:var(--text-muted);line-height:1.5;">Get a code, share it, done</div>
        </button>
        <button onclick="initReceive()" class="glass-card text-left" style="padding:24px;cursor:pointer;">
          <div style="width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;
            margin-bottom:16px;background:rgba(6,182,212,0.12);border:1px solid rgba(6,182,212,0.2);font-size:20px;">üì•</div>
          <div style="font-size:16px;font-weight:700;margin-bottom:4px;">Receive Files</div>
          <div style="font-size:12px;color:var(--text-muted);line-height:1.5;">Enter a 6-char code</div>
        </button>
      </div>

      <!-- ‚ïê‚ïê LINK PAIR SECTION ‚ïê‚ïê -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:20px;text-align:left;">
        <button onclick="toggleConf('link')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;">
            üîó Permanent Link
            <span id="link-header-badge" style="display:none;" class="badge-cyan" style="padding:2px 8px;border-radius:999px;font-size:10px;font-weight:600;color:#06B6D4;">Active</span>
          </span>
          <span id="chev-link" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-link">
          <div style="padding:0 16px 16px;">
            <!-- Rendered dynamically by LINK_PAIR._renderUI() -->
            <div id="link-pair-section"></div>
          </div>
        </div>
      </div>

      <!-- Feature badges -->
      <div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center;">
        <span class="badge-violet" style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">üîí AES-256-GCM</span>
        <span class="badge-violet" style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">‚àû Unlimited Size</span>
        <span class="badge-cyan"   style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">üì° Firewall Bypass</span>
        <span class="badge-cyan"   style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">üë• Multi-Receiver</span>
        <span class="badge-green"  style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">üí• Auto-Destruct</span>
        <span class="badge-green"  style="padding:5px 11px;border-radius:999px;font-size:11px;font-weight:500;">‚è∏ Resume on Drop</span>
      </div>
    </div>
  </div><!-- /screen-landing -->

  <!-- ‚ïê‚ïê‚ïê‚ïê SEND ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-send" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">‚Üê Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Send Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Share a 6-char code ¬∑ Multi-receiver</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="sdot-1"></div>
        <div class="step-dot" id="sdot-2"></div>
        <div class="step-dot" id="sdot-3"></div>
      </div>
    </div>

    <!-- SEND STEP 1: file select + config -->
    <div id="s-step-1">

      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('s')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üì° Network Config <span style="font-size:11px;color:var(--text-muted);">STUN / TURN</span>
          </span>
          <span id="chev-s" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-s">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Built-in STUN Servers</div>
            <div class="mono glass" style="font-size:10px;line-height:1.8;color:rgba(123,92,246,0.8);padding:10px 12px;border-radius:10px;margin-bottom:14px;">
              stun.l.google.com:19302 ¬∑ stun1.l.google.com:19302<br/>
              stun.cloudflare.com:3478 ¬∑ stun.mozilla.com
            </div>
            <div style="background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.18);border-radius:10px;padding:11px;margin-bottom:12px;">
              <div class="label" style="color:rgba(6,182,212,0.7);margin-bottom:5px;">üåê Global Mode ‚Äî Free TURN Relays</div>
              <div class="mono" style="font-size:10px;color:rgba(255,255,255,0.4);">openrelay.metered.ca :80 :443 ‚Äî auto-enabled in Global mode</div>
            </div>
            <div class="label" style="margin-bottom:8px;">Custom TURN Relay (optional)</div>
            <input type="url" id="turn-url-s" placeholder="turn:your-server.com:3478" style="width:100%;padding:9px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-s" placeholder="username" style="flex:1;padding:9px 12px;"/>
              <input type="text" id="turn-pass-s" placeholder="password" style="flex:1;padding:9px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê SECURITY PANEL ‚ïê‚ïê -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('sec-s')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üîê Security
            <span id="sec-s-badges" style="display:flex;gap:4px;"></span>
          </span>
          <span id="chev-sec-s" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-sec-s">
          <div style="padding:0 16px 16px;">

            <!-- AES-GCM Password -->
            <div style="background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.15);border-radius:12px;padding:14px;margin-bottom:12px;">
              <div class="toggle-row">
                <div>
                  <div class="toggle-label-text">üîë Password Protect</div>
                  <div class="toggle-sub">AES-256-GCM ¬∑ encrypted per-chunk</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="enc-toggle" onchange="onEncToggle()"/>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div id="enc-password-wrap" style="display:none;margin-top:10px;">
                <input type="password" id="enc-password" placeholder="Enter passphrase"
                  style="width:100%;padding:10px 12px;"
                  oninput="validateEncPassword()"
                  autocomplete="new-password"/>
                <div id="enc-strength" style="margin-top:6px;font-size:11px;color:var(--text-muted);"></div>
              </div>
            </div>

            <!-- Auto-Destruct -->
            <div style="background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.12);border-radius:12px;padding:14px;">
              <div class="toggle-row">
                <div>
                  <div class="toggle-label-text">üí• Auto-Destruct</div>
                  <div class="toggle-sub">Destroy session after verified transfer</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="autodestruct-toggle" onchange="onAutoDestructToggle()"/>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p id="autodestruct-hint" style="display:none;font-size:11px;color:rgba(239,68,68,0.7);margin-top:6px;line-height:1.5;">
                Peer ID and connection are permanently revoked the moment the receiver confirms integrity via SHA-256.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Drop Zone -->
      <div id="drop-zone" class="drop-zone glass-card"
        style="padding:36px;text-align:center;border-radius:20px;margin-bottom:12px;"
        onclick="pickFiles()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="float-icon" style="display:inline-block;margin-bottom:14px;font-size:38px;">üìÑ</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:5px;">Drop files or click to browse</div>
        <div style="font-size:12px;color:var(--text-muted);">Any type ¬∑ Any size ¬∑ Multi-file auto-zipped</div>
        <input type="file" id="file-fallback" multiple style="display:none;" onchange="onFileInput(this.files)"/>
      </div>

      <!-- File list -->
      <div id="files-panel" style="display:none;" class="glass-card">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px 0;">
          <div style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;">
            üì¶ <span id="files-count-lbl">0 files</span>
          </div>
          <span class="mono" id="files-size-lbl" style="font-size:11px;color:var(--text-muted);"></span>
        </div>
        <div id="files-list" style="padding:10px 16px 14px;max-height:130px;overflow-y:auto;"></div>
      </div>

      <div style="margin-top:14px;">
        <button id="btn-start" onclick="startSenderSession()" disabled class="btn-primary"
          style="width:100%;padding:15px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
          üöÄ Generate Code &amp; Start Session
        </button>
      </div>
    </div><!-- /s-step-1 -->

    <!-- SEND STEP 2: show code, wait for receivers -->
    <div id="s-step-2" style="display:none;">
      <div class="glass-card" style="padding:26px;text-align:center;margin-bottom:14px;">
        <div class="label" style="margin-bottom:14px;">üì∂ Share this code with receivers</div>
        <div class="code-boxes" id="code-display"></div>
        <!-- Active security badges shown below the code -->
        <div id="active-sec-badges" style="display:flex;justify-content:center;gap:6px;margin-top:12px;"></div>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:14px;">
          <button onclick="copyCode()" class="btn-ghost" style="padding:7px 14px;font-size:12px;">üìã Copy</button>
          <span class="mono" style="font-size:11px;color:var(--text-muted);">Multiple peers can connect</span>
        </div>
      </div>

      <div class="glass-card" style="padding:18px;margin-bottom:14px;text-align:center;">
        <div class="label" style="margin-bottom:10px;">üî≤ QR Code</div>
        <div id="qr-sender" style="display:flex;justify-content:center;"></div>
      </div>

      <!-- Receiver list / waiting -->
      <div class="glass-card" style="padding:22px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div style="font-size:14px;font-weight:600;">Receivers</div>
          <div id="receiver-count-badge" style="font-size:11px;font-weight:600;color:var(--text-muted);
            background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:999px;padding:3px 10px;">
            0 connected
          </div>
        </div>
        <div id="waiting-indicator" style="text-align:center;padding:16px 0;">
          <div class="pulse-wrap" style="width:44px;height:44px;margin:0 auto 10px;position:relative;">
            <div class="pulse-ring-el" style="background:rgba(123,92,246,0.15);inset:0;position:absolute;border-radius:50%;"></div>
            <div class="pulse-core" style="width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;
              background:rgba(123,92,246,0.2);border:1px solid rgba(123,92,246,0.3);position:relative;z-index:1;font-size:13px;">üì∂</div>
          </div>
          <div style="font-size:13px;color:var(--text-muted);">Waiting for receivers...</div>
        </div>
        <div id="receivers-list" style="display:none;"></div>
      </div>
    </div><!-- /s-step-2 -->

    <!-- SEND STEP 3: active transfer -->
    <div id="s-step-3" style="display:none;">
      <div id="sender-progress-area"></div>
    </div>
  </div><!-- /screen-send -->

  <!-- ‚ïê‚ïê‚ïê‚ïê RECEIVE ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-receive" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">‚Üê Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Receive Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Enter the sender's 6-char code</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="rdot-1"></div>
        <div class="step-dot" id="rdot-2"></div>
      </div>
    </div>

    <!-- RECEIVE STEP 1 -->
    <div id="r-step-1">
      <!-- Resume banner -->
      <div id="resume-banner" class="resume-banner" style="display:none;">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:20px;">‚è∏</span>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:#f59e0b;margin-bottom:2px;">Interrupted Transfer Detected</div>
            <div id="resume-info" style="font-size:12px;color:var(--text-muted);"></div>
          </div>
          <button onclick="clearResume()" class="btn-danger" style="padding:6px 12px;font-size:11px;">Clear</button>
        </div>
      </div>

      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('r')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üì° Network Config
          </span>
          <span id="chev-r" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-r">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Custom TURN Relay (optional)</div>
            <input type="url" id="turn-url-r" placeholder="turn:openrelay.metered.ca:80" style="width:100%;padding:9px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-r" placeholder="username" style="flex:1;padding:9px 12px;"/>
              <input type="text" id="turn-pass-r" placeholder="password" style="flex:1;padding:9px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <!-- Security: decryption password -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:12px;">
        <button onclick="toggleConf('sec-r')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:13px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üîê Decryption Password
            <span style="font-size:11px;color:var(--text-muted);">if sender encrypted</span>
          </span>
          <span id="chev-sec-r" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-sec-r">
          <div style="padding:0 16px 16px;">
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">
              If the sender enabled password protection, enter the same passphrase here before connecting.
            </p>
            <input type="password" id="recv-password" placeholder="Enter passphrase"
              style="width:100%;padding:10px 12px;" autocomplete="current-password"/>
          </div>
        </div>
      </div>

      <!-- Code input -->
      <div class="glass-card" style="padding:22px;margin-bottom:14px;">
        <div class="label" style="margin-bottom:14px;text-align:center;">Enter the sender's code</div>
        <input type="text" id="code-input" class="code-input-field" maxlength="6"
          placeholder="‚óè ‚óè ‚óè ‚óè ‚óè ‚óè"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');checkCodeReady()"
          onkeydown="if(event.key==='Enter')connectToSender()"/>
        <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:10px;">6 letters and numbers</p>
      </div>

      <button id="btn-connect" onclick="connectToSender()" disabled class="btn-primary"
        style="width:100%;padding:15px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
        üîó Connect &amp; Receive
      </button>
    </div><!-- /r-step-1 -->

    <!-- RECEIVE STEP 2 -->
    <div id="r-step-2" style="display:none;">
      <div id="recv-progress-area"></div>
    </div>
  </div><!-- /screen-receive -->

</main>

<!-- TOAST -->
<div id="toast" style="display:none;position:fixed;z-index:9999;bottom:24px;left:50%;transform:translateX(-50%);
  background:rgba(10,12,28,0.9);border:1px solid rgba(255,255,255,0.1);
  backdrop-filter:blur(20px);padding:11px 16px;border-radius:14px;
  align-items:center;gap:10px;min-width:200px;max-width:400px;white-space:nowrap;">
  <span id="toast-icon-el" style="font-size:16px;"></span>
  <span id="toast-msg" style="font-size:13px;font-weight:500;"></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js" crossorigin="anonymous"></script>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEBUG LOGGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _t0 = performance.now();
function dbg(sec,msg,d){const ts=((performance.now()-_t0)/1e3).toFixed(3);d!==undefined?console.log(`[GS:${sec}] +${ts}s`,msg,d):console.log(`[GS:${sec}] +${ts}s`,msg);}
function dbgWarn(sec,msg,d){const ts=((performance.now()-_t0)/1e3).toFixed(3);console.warn(`[GS:${sec}] ‚ö† +${ts}s`,msg,d||'');}
function dbgErr(sec,msg,e){const ts=((performance.now()-_t0)/1e3).toFixed(3);console.error(`[GS:${sec}] ‚úñ +${ts}s`,msg,e||'');}
dbg('BOOT','‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GhostShare v5 init ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHUNK_SIZE  = 64 * 1024;          // 64 KB per chunk
const HIGH_WATER  = 8  * 1024 * 1024;   // 8 MB backpressure ceiling
const LOW_WATER   = 1  * 1024 * 1024;   // 1 MB backpressure floor

const FREE_TURN_SERVERS = [
  { urls:'turn:openrelay.metered.ca:80' },
  { urls:'turn:openrelay.metered.ca:443' },
  { urls:'turns:openrelay.metered.ca:443' },
  { urls:'turn:openrelay.metered.ca:80?transport=tcp' },
];

const STUN_SERVERS = [
  { urls:'stun:stun.l.google.com:19302'   },
  { urls:'stun:stun1.l.google.com:19302'  },
  { urls:'stun:stun.cloudflare.com:3478'  },
  { urls:'stun:stun.mozilla.com'          },
  { urls:'stun:stun.stunprotocol.org:3478'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ
//  MODULE: AES_CRYPTO
//  ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ
//
//  AES-256-GCM encryption for individual 64 KB chunks.
//
//  KEY DERIVATION:
//    PBKDF2(password, salt, 210_000 iterations, SHA-256) ‚Üí 256-bit key
//    - 210,000 iterations matches OWASP 2024 recommendation for PBKDF2-SHA256
//    - Salt: 16 random bytes generated fresh each sender session
//    - Salt travels in the META control message (public, not secret)
//
//  PER-CHUNK ENCRYPTION:
//    For each chunk: generate 12-byte random IV, run AES-GCM encrypt
//    Wire format:  [12 bytes IV][N bytes ciphertext+tag]
//    The 16-byte GCM authentication tag is appended by SubtleCrypto
//    automatically, so ciphertext is (chunk + 16) bytes longer than
//    the plaintext. This is transparent to the rest of the code.
//
//  WHY PER-CHUNK IVs?
//    Reusing an IV with AES-GCM on the same key is catastrophic.
//    Because each chunk uses a fresh random IV the keys can be
//    derived once and safely reused across all chunks.
//
//  HASH INTEGRITY:
//    Merkle hashes are computed over the PLAINTEXT (post-decrypt) so
//    integrity is verified on the actual file content, not the cipher.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AES_CRYPTO = (() => {
  const ALG = 'AES-GCM';
  const IV_LEN = 12;   // 96-bit IV: GCM standard, maximally efficient
  const KDF_ITER = 210_000;

  /** Derive a 256-bit AES-GCM key from a password + salt via PBKDF2 */
  async function deriveKey(password, saltBytes) {
    const enc = new TextEncoder();
    const raw = await crypto.subtle.importKey(
      'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name:'PBKDF2', salt:saltBytes, iterations:KDF_ITER, hash:'SHA-256' },
      raw,
      { name:ALG, length:256 },
      false,
      ['encrypt','decrypt']
    );
  }

  /**
   * Encrypt one ArrayBuffer chunk.
   * Returns ArrayBuffer: [12-byte IV][encrypted+tag]
   */
  async function encryptChunk(key, buffer) {
    const iv         = crypto.getRandomValues(new Uint8Array(IV_LEN));
    const ciphertext = await crypto.subtle.encrypt({ name:ALG, iv }, key, buffer);
    const out = new Uint8Array(IV_LEN + ciphertext.byteLength);
    out.set(iv, 0);
    out.set(new Uint8Array(ciphertext), IV_LEN);
    return out.buffer;
  }

  /**
   * Decrypt one ArrayBuffer chunk.
   * Input: [12-byte IV][ciphertext+tag]
   * Returns plaintext ArrayBuffer.
   */
  async function decryptChunk(key, buffer) {
    const iv         = new Uint8Array(buffer, 0, IV_LEN);
    const ciphertext = buffer.slice(IV_LEN);
    return crypto.subtle.decrypt({ name:ALG, iv }, key, ciphertext);
  }

  /** Generate a random 16-byte salt and return as hex string */
  function genSalt() {
    const b = new Uint8Array(16);
    crypto.getRandomValues(b);
    return bufToHex(b);
  }

  return { deriveKey, encryptChunk, decryptChunk, genSalt };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ
//  MODULE: LINK_PAIR
//  ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ
//
//  Persistent device pairing for zero-click transfers.
//
//  HOW IT WORKS:
//    1. User generates an 8-char token and stores it in localStorage.
//    2. Both devices store the same token.
//    3. On page load, the app tries to register PeerJS ID `GSLNK${token}`
//       as the "host". If that ID is already taken, it becomes the "guest"
//       and connects to the host. There is no server ‚Äî PeerJS broker only
//       relays the SDP handshake.
//    4. Once paired, any sender session that starts broadcasts its code
//       over the link channel via { type:'auto-connect', code:'...' }.
//    5. The partner's page auto-navigates to Receive and connects using
//       that code without the user touching anything.
//
//  TOKENS:
//    - 8-character alphanumeric, stored in localStorage under 'gs_link_v5'
//    - The PeerJS peer ID is `GSLNK` + token (13 chars total, no special chars)
//    - Tokens are permanent ‚Äî the link survives page refreshes and restarts
//
//  RECONNECTION:
//    If the partner drops, we retry becoming host (or guest) every ~8 seconds.
//    This handles network blips and tab restarts gracefully.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LINK_PAIR = (() => {
  const LS_KEY      = 'gs_link_v5';
  const PEER_PREFIX = 'GSLNK';        // 5 chars + 8-char token = 13 char peer ID
  let _token  = null;
  let _peer   = null;
  let _conn   = null;
  let _retryT = null;

  // ‚îÄ‚îÄ Public API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function init() {
    _token = localStorage.getItem(LS_KEY);
    _renderUI();
    if (_token) _start();
  }

  function generate() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const b = new Uint8Array(8);
    crypto.getRandomValues(b);
    _token = Array.from(b).map(x => chars[x % chars.length]).join('');
    localStorage.setItem(LS_KEY, _token);
    _renderUI();
    _start();
    showToast('Link token created ‚Äî share it with your partner!','üîó','cyan');
  }

  function saveToken(raw) {
    const t = (raw || '').trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (t.length !== 8) { showToast('Token must be 8 characters','‚ö†Ô∏è','red'); return; }
    _token = t;
    localStorage.setItem(LS_KEY, _token);
    if (_peer) { try { _peer.destroy(); } catch(e){} _peer = null; }
    _renderUI();
    _start();
    showToast('Token saved ‚Äî searching for partner...','üîó','cyan');
  }

  function clear() {
    _cleanup();
    _token = null;
    localStorage.removeItem(LS_KEY);
    _renderUI();
    _updateBadge(false);
    showToast('Link token removed','üóëÔ∏è','violet');
  }

  function isOnline() {
    return !!(_conn && _conn.open);
  }

  /**
   * Called by the sender after peer.on('open') fires.
   * Broadcasts the 6-char code to the linked partner so they
   * can auto-connect without the user doing anything.
   */
  function broadcast(code) {
    if (!isOnline()) return;
    try {
      _conn.send(JSON.stringify({ type:'auto-connect', code }));
      dbg('LINK',`Broadcast auto-connect code="${code}"`);
      showToast('Sending to paired device automatically ‚ö°','üîó','cyan');
    } catch(e) { dbgErr('LINK','broadcast failed:',e); }
  }

  // ‚îÄ‚îÄ Private helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function _peerId() { return `${PEER_PREFIX}${_token}`; }

  function _start() {
    if (!_token) return;
    clearTimeout(_retryT);
    // Try to register as host; if taken, become guest
    _peer = new Peer(_peerId(), { debug:0 });
    _peer.on('open', () => {
      dbg('LINK',`Host registered: ${_peerId()}`);
      _peer.on('connection', c => {
        c.on('open', () => _onPartnerConn(c));
      });
    });
    _peer.on('error', e => {
      if (e.type === 'unavailable-id') {
        // Another device is already host ‚Üí become guest
        dbg('LINK','ID taken ‚Üí becoming guest');
        try { _peer.destroy(); } catch(er){}
        _peer = null;
        _becomeGuest();
      } else if (e.type === 'server-error' || e.type === 'network') {
        // PeerJS server unreachable ‚Äî retry silently
        _retryT = setTimeout(() => _start(), 12000);
      }
    });
  }

  function _becomeGuest() {
    if (!_token) return;
    _peer = new Peer({ debug:0 });
    _peer.on('open', () => {
      const c = _peer.connect(_peerId(), { reliable:true });
      c.on('open',  () => _onPartnerConn(c));
      c.on('error', () => {
        // Host offline ‚Äî retry becoming host in 8s
        _retryT = setTimeout(() => {
          _cleanup();
          _start();
        }, 8000);
      });
    });
    _peer.on('error', () => {
      _retryT = setTimeout(() => { _cleanup(); _start(); }, 12000);
    });
  }

  function _onPartnerConn(c) {
    _conn = c;
    dbg('LINK','Partner connected!');
    _updateBadge(true);
    showToast('Paired device is online!','üîó','cyan');
    _renderUI(); // update status dot

    c.on('data', raw => {
      if (typeof raw !== 'string') return;
      let msg;
      try { msg = JSON.parse(raw); } catch(e) { return; }

      if (msg.type === 'auto-connect') {
        /**
         * Partner is sending files. Navigate to Receive and
         * auto-connect using the broadcasted code.
         * setTimeout(0) to let the DOM settle before manipulating it.
         */
        dbg('LINK',`Auto-connect received, code="${msg.code}"`);
        showToast('Partner is sending ‚Äî auto-connecting... ‚ö°','‚ö°','cyan');
        setTimeout(() => {
          initReceive();
          const inp = $('code-input');
          if (inp) { inp.value = msg.code; checkCodeReady(); }
          setTimeout(() => connectToSender(), 400);
        }, 100);
      }
    });

    c.on('close', () => {
      dbg('LINK','Partner disconnected');
      _conn = null;
      _updateBadge(false);
      _renderUI();
      // Attempt to reclaim host role or reconnect as guest
      _retryT = setTimeout(() => { _cleanup(); _start(); }, 6000);
    });
  }

  function _cleanup() {
    clearTimeout(_retryT);
    if (_conn) { try { _conn.close(); } catch(e){} _conn = null; }
    if (_peer) { try { _peer.destroy(); } catch(e){} _peer = null; }
  }

  function _updateBadge(online) {
    const badge = $('link-badge');
    if (badge) badge.style.display = online ? 'flex' : 'none';
    // Also update the header indicator for the link panel
    const hb = $('link-header-badge');
    if (hb) hb.style.display = (_token) ? 'inline-flex' : 'none';
    // Update status dot inside rendered UI
    const dot = $('link-status-dot');
    const lbl = $('link-status-lbl');
    if (dot) dot.style.background = online ? '#22c55e' : '#f59e0b';
    if (lbl) {
      lbl.textContent = online ? 'Partner online' : 'Searching...';
      lbl.style.color = online ? '#22c55e' : 'var(--text-muted)';
    }
    // Enable/disable the quick-send drop zone
    const qdz = $('link-quick-send');
    if (qdz) qdz.style.opacity = online ? '1' : '0.4';
    if (qdz) qdz.style.pointerEvents = online ? 'auto' : 'none';
  }

  function _renderUI() {
    const el = $('link-pair-section');
    if (!el) return;

    if (!_token) {
      el.innerHTML = `
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px;line-height:1.6;">
          Pair two devices once with a shared 8-char token.
          Transfers auto-initiate ‚Äî no code sharing ever again.
        </p>
        <button onclick="LINK_PAIR.generate()" class="btn-primary" style="width:100%;padding:10px;font-size:13px;margin-bottom:12px;">
          ‚ú® Create Link Token
        </button>
        <div class="label" style="margin-bottom:6px;">Or enter a partner's token:</div>
        <div style="display:flex;gap:8px;">
          <input type="text" id="link-token-input" placeholder="ABCD1234"
            style="flex:1;padding:8px 12px;text-transform:uppercase;letter-spacing:0.12em;font-size:14px;"
            maxlength="8" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"/>
          <button onclick="LINK_PAIR.saveToken($('link-token-input').value)" class="btn-ghost" style="padding:8px 14px;font-size:12px;">
            Save
          </button>
        </div>`;
    } else {
      const online = isOnline();
      el.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div id="link-status-dot" style="width:9px;height:9px;border-radius:50%;background:${online?'#22c55e':'#f59e0b'};flex-shrink:0;transition:background 0.3s;"></div>
            <span id="link-status-lbl" style="font-size:12px;font-weight:600;color:${online?'#22c55e':'var(--text-muted)'};">
              ${online ? 'Partner online' : 'Searching...'}
            </span>
          </div>
          <button onclick="LINK_PAIR.clear()" class="btn-danger" style="padding:5px 10px;font-size:11px;">Unlink</button>
        </div>

        <!-- Token display + copy -->
        <div style="display:flex;align-items:center;gap:12px;background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.18);border-radius:12px;padding:13px;margin-bottom:12px;">
          <div class="link-token-display">${_token}</div>
          <button onclick="navigator.clipboard?.writeText('${_token}').then(()=>showToast('Token copied!','‚úÖ','green'))"
            class="btn-ghost" style="padding:5px 9px;font-size:11px;">üìã</button>
          <div style="flex:1;"></div>
          <div id="link-qr" style="width:60px;height:60px;overflow:hidden;border-radius:8px;"></div>
        </div>

        <!-- Quick-send drop zone (enabled only when partner online) -->
        <div id="link-quick-send"
          style="opacity:${online?1:0.4};pointer-events:${online?'auto':'none'};"
          class="drop-zone-link" style="padding:18px;text-align:center;"
          onclick="linkQuickSend()" ondragover="onDragOver(event,true)"
          ondragleave="onDragLeave(event,true)" ondrop="onDrop(event,true)">
          <div style="font-size:24px;margin-bottom:6px;">‚ö°</div>
          <div style="font-size:13px;font-weight:600;margin-bottom:4px;">Quick Send to Partner</div>
          <div style="font-size:11px;color:var(--text-muted);">Drop file or click ‚Äî zero-click on their end</div>
        </div>`;

      // Small QR code for the token
      setTimeout(() => {
        const qrEl = $('link-qr');
        if (qrEl && typeof QRCode !== 'undefined') {
          try {
            new QRCode(qrEl, { text:_token, width:60, height:60,
              colorDark:'#06B6D4', colorLight:'#030610',
              correctLevel:QRCode.CorrectLevel.L });
          } catch(e) {}
        }
      }, 80);
    }
  }

  // Expose the update badge function so external code can call it on reconnect
  return { init, generate, saveToken, clear, isOnline, broadcast, _renderUI, _updateBadge };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INDEXEDDB RESUME MODULE (unchanged from v4, same schema)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IDB = (() => {
  let db = null;
  const DB_NAME = 'ghostshare-v5';  // bumped version to avoid schema conflicts

  async function init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = e => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains('transfers'))
          d.createObjectStore('transfers', { keyPath:'transferId' });
        if (!d.objectStoreNames.contains('chunks'))
          d.createObjectStore('chunks');
      };
      req.onsuccess  = e => { db = e.target.result; resolve(db); };
      req.onerror    = ()  => reject(req.error);
    });
  }

  function saveChunk(transferId, idx, buffer) {
    if (!db) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('chunks','readwrite');
      tx.objectStore('chunks').put(buffer, `${transferId}:${idx}`);
      tx.oncomplete = resolve;
      tx.onerror    = () => reject(tx.error);
    });
  }

  function saveMeta(meta) {
    if (!db) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('transfers','readwrite');
      tx.objectStore('transfers').put({ ...meta, timestamp:Date.now() });
      tx.oncomplete = resolve;
      tx.onerror    = () => reject(tx.error);
    });
  }

  async function getLatestMeta() {
    if (!db) return null;
    return new Promise(resolve => {
      const tx  = db.transaction('transfers','readonly');
      const req = tx.objectStore('transfers').openCursor(null,'prev');
      req.onsuccess = e => resolve(e.target.result?.value || null);
      req.onerror   = () => resolve(null);
    });
  }

  async function loadChunks(transferId, totalChunks) {
    if (!db) return [];
    const chunks = new Array(totalChunks).fill(null);
    return new Promise(resolve => {
      const tx    = db.transaction('chunks','readonly');
      const range = IDBKeyRange.bound(`${transferId}:0`,`${transferId}:\uffff`);
      const req   = tx.objectStore('chunks').openCursor(range);
      req.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          const idx = parseInt(cursor.key.split(':')[1], 10);
          if (!isNaN(idx) && idx < totalChunks) chunks[idx] = cursor.value;
          cursor.continue();
        } else { resolve(chunks); }
      };
      req.onerror = () => resolve([]);
    });
  }

  function clearTransfer(transferId) {
    if (!db) return;
    const tx1 = db.transaction('transfers','readwrite');
    tx1.objectStore('transfers').delete(transferId);
    const tx2  = db.transaction('chunks','readwrite');
    const store = tx2.objectStore('chunks');
    const range = IDBKeyRange.bound(`${transferId}:0`,`${transferId}:\uffff`);
    const req   = store.openCursor(range);
    req.onsuccess = e => { const c = e.target.result; if(c){c.delete();c.continue();} };
  }

  return { init, saveChunk, saveMeta, getLatestMeta, loadChunks, clearTransfer };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isGlobal        = false;
let peer            = null;
let isSender        = false;

// Sender state
let connections     = [];          // [{ id, conn, fromChunk, sentBytes, status, cardEl }]
let selectedFiles   = [];
let transferBlob    = null;        // { blob, name }
let totalBytes      = 0;
let xferStart       = 0;
let globalIsPaused  = false;
let pauseResolve    = null;
let senderChunkHashes = [];
let transferComplete  = false;     // suppresses disconnect toast after success

// Receiver state
let recvConn        = null;
let inMeta          = null;
let inChunks        = [];
let recvChunkHashes = [];
let recvBytes       = 0;
let recvFromChunk   = 0;
let recvIsPaused    = false;

/**
 * RECEIVE QUEUE:
 * Data arrives on the WebRTC DataChannel synchronously and
 * conn.on('data') is called immediately. Because chunk decryption
 * is async (AES-GCM), we cannot await it inline. Instead, every
 * incoming item is pushed to recvQueue and a sequential async
 * processor drains it one item at a time. This guarantees:
 *  - In-order processing even though decrypt is async
 *  - No dropped chunks due to unhandled promise rejection
 *  - Backpressure stays correct (inChunks indexed sequentially)
 */
const recvQueue       = [];
let   recvProcessing  = false;

// Speed tracking
let speedWindow     = [];
let speedHistory    = [];
let lastPerfTime    = 0;
let lastPerfBytes   = 0;
let elapsedTimer    = null;
let myCode          = null;

// ‚îÄ‚îÄ Security state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * encEnabled:    user toggled the password-protect switch
 * encPassword:   the passphrase entered by the sender
 * senderAesKey:  CryptoKey derived before the first chunk is sent
 * senderSaltHex: 32-char hex of the 16-byte PBKDF2 salt; travels in META
 * recvAesKey:    CryptoKey derived by receiver when META arrives
 * autoDestruct:  destroy peer+conn the moment verify ACK is received
 */
let encEnabled      = false;
let encPassword     = '';
let senderAesKey    = null;
let senderSaltHex   = '';
let recvAesKey      = null;
let autoDestruct    = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const b = new Uint8Array(6);
  crypto.getRandomValues(b);
  return Array.from(b).map(x => chars[x % chars.length]).join('');
}

function bufToHex(buf) {
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function hexToBytes(hex) {
  const arr = new Uint8Array(hex.length / 2);
  for (let i = 0; i < hex.length; i += 2) arr[i/2] = parseInt(hex.slice(i,i+2),16);
  return arr;
}

/** Merkle root: SHA-256 of concatenated per-chunk SHA-256 hashes */
async function computeMerkleHash(hashes) {
  if (!hashes.length) return 'empty';
  const combined = new Uint8Array(hashes.length * 32);
  hashes.forEach((h,i) => combined.set(h, i*32));
  return bufToHex(await crypto.subtle.digest('SHA-256', combined));
}

function makeTransferId(name, size) {
  return `${name.replace(/[^a-zA-Z0-9]/g,'_')}-${size}`;
}

function fmtBytes(b) {
  if (!b) return '0 B';
  const u = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(b)/Math.log(1024));
  return `${(b/Math.pow(1024,i)).toFixed(i>0?1:0)} ${u[i]}`;
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function fileEmoji(name) {
  const ext = (name.split('.').pop()||'').toLowerCase();
  return ({pdf:'üìÑ',doc:'üìù',docx:'üìù',txt:'üìù',md:'üìù',
           jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',webp:'üñº',
           mp4:'üé¨',mov:'üé¨',mkv:'üé¨',avi:'üé¨',webm:'üé¨',
           mp3:'üéµ',wav:'üéµ',flac:'üéµ',aac:'üéµ',
           zip:'üì¶',tar:'üì¶',gz:'üì¶',rar:'üì¶','7z':'üì¶',
           js:'üíª',ts:'üíª',py:'üíª',html:'üíª',json:'üíª',
           xlsx:'üìä',csv:'üìä',exe:'‚öô',dmg:'‚öô'}[ext]||'üìÑ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DOM HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function $(id) { return document.getElementById(id); }
function show(id) { const e=$(id); if(e) e.style.display=''; }
function hide(id) { const e=$(id); if(e) e.style.display='none'; }
function showFlex(id) { const e=$(id); if(e) e.style.display='flex'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const t = $(id); if(t) t.classList.add('active');
}
function goHome() {
  cleanup();
  showScreen('screen-landing');
  hide('conn-badge');
  // Re-render link UI to restore quick-send zone etc.
  LINK_PAIR._renderUI();
  LINK_PAIR._updateBadge(LINK_PAIR.isOnline());
}
function initSend() {
  isSender = true;
  showScreen('screen-send');
  resetSendUI();
}
function initReceive() {
  isSender = false;
  showScreen('screen-receive');
  resetReceiveUI();
  checkForResume();
}
function resetSendUI() {
  show('s-step-1'); hide('s-step-2'); hide('s-step-3');
  setStepDots(['sdot-1','sdot-2','sdot-3'],0);
  const btn = $('btn-start'); if(btn) btn.disabled = true;
  hide('files-panel');
  const fl = $('files-list'); if(fl) fl.innerHTML = '';
  selectedFiles = [];
  connections   = [];
  transferComplete = false;
}
function resetReceiveUI() {
  show('r-step-1'); hide('r-step-2');
  setStepDots(['rdot-1','rdot-2'],0);
  const inp = $('code-input'); if(inp) { inp.value=''; checkCodeReady(); }
  recvQueue.length = 0;
  recvProcessing   = false;
  transferComplete = false;
}
function setStepDots(ids,activeIdx) {
  ids.forEach((id,i)=>{ const e=$(id); if(e) e.classList.toggle('active',i===activeIdx); });
}
function showSendStep(n) {
  hide('s-step-1'); hide('s-step-2'); hide('s-step-3');
  show(`s-step-${n}`);
  setStepDots(['sdot-1','sdot-2','sdot-3'],n-1);
}
function showReceiveStep(n) {
  hide('r-step-1'); hide('r-step-2');
  show(`r-step-${n}`);
  setStepDots(['rdot-1','rdot-2'],n-1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMode() {
  isGlobal = !isGlobal;
  $('mode-local').classList.toggle('active', !isGlobal);
  $('mode-global').classList.toggle('active',  isGlobal);
  showToast(isGlobal ? 'üåê Global mode ‚Äî TURN relay enabled' : 'üì∂ Local mode ‚Äî STUN only',
            isGlobal ? 'üåê' : 'üì∂', 'violet');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SECURITY UI HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onEncToggle() {
  encEnabled = !!$('enc-toggle')?.checked;
  const wrap = $('enc-password-wrap');
  if (wrap) wrap.style.display = encEnabled ? 'block' : 'none';
  if (!encEnabled) { encPassword = ''; senderAesKey = null; }
  _updateSecBadges();
  dbg('SEC',`Encryption ${encEnabled?'enabled':'disabled'}`);
}

function onAutoDestructToggle() {
  autoDestruct = !!$('autodestruct-toggle')?.checked;
  const hint = $('autodestruct-hint');
  if (hint) hint.style.display = autoDestruct ? 'block' : 'none';
  _updateSecBadges();
  dbg('SEC',`Auto-destruct ${autoDestruct?'armed':'disarmed'}`);
}

function validateEncPassword() {
  const pwd = $('enc-password')?.value || '';
  encPassword = pwd;
  const el = $('enc-strength');
  if (!el) return;
  const len = pwd.length;
  let txt = '', color = '';
  if (len === 0)      { txt='';                      color=''; }
  else if (len < 8)   { txt='‚ö† Weak ‚Äî too short';   color='#ef4444'; }
  else if (len < 12)  { txt='‚óë Fair';                color='#f59e0b'; }
  else if (len < 20)  { txt='‚óï Good';                color='#22c55e'; }
  else                { txt='‚óè Strong';              color='#a78bfa'; }
  el.textContent = txt; el.style.color = color;
}

function _updateSecBadges() {
  // Update the mini-badges visible in the closed security panel header
  const el = $('sec-s-badges');
  if (!el) return;
  let html = '';
  if (encEnabled)    html += `<span class="enc-badge">üîë AES-256</span>`;
  if (autoDestruct)  html += `<span class="destruct-badge">üí• Destruct</span>`;
  el.innerHTML = html;

  // Update the badges shown under the code in step 2
  const ab = $('active-sec-badges');
  if (!ab) return;
  let abHtml = '';
  if (encEnabled)    abHtml += `<span class="enc-badge">üîë AES-256-GCM Encrypted</span>`;
  if (autoDestruct)  abHtml += `<span class="destruct-badge">üí• Auto-Destruct Armed</span>`;
  ab.innerHTML = abHtml;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NETWORK CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleConf(side) {
  const panel = $(`conf-${side}`);
  const chev  = $(`chev-${side}`);
  if (!panel) return;
  const open = panel.classList.toggle('open');
  if (chev) chev.style.transform = open ? 'rotate(180deg)' : '';
}

function buildIceConfig(side) {
  const iceServers = [...STUN_SERVERS];
  if (isGlobal) iceServers.push(...FREE_TURN_SERVERS);
  const url  = ($(`turn-url-${side}`)?.value  || '').trim();
  const user = ($(`turn-user-${side}`)?.value || '').trim();
  const pass = ($(`turn-pass-${side}`)?.value || '').trim();
  if (url) iceServers.push({ urls:url, username:user||undefined, credential:pass||undefined });
  return { iceServers, iceCandidatePoolSize:10 };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function pickFiles() {
  if ('showOpenFilePicker' in window) {
    try {
      const h = await window.showOpenFilePicker({ multiple:true });
      selectedFiles = await Promise.all(h.map(x => x.getFile()));
      renderFileList(selectedFiles);
    } catch(e) { if (e.name !== 'AbortError') $('file-fallback').click(); }
  } else {
    $('file-fallback').click();
  }
}
function onFileInput(fl) { selectedFiles = Array.from(fl); renderFileList(selectedFiles); }
function onDragOver(e, isLink=false)  { e.preventDefault(); $(isLink?'link-quick-send':'drop-zone')?.classList.add('drag-active'); }
function onDragLeave(e, isLink=false) { $(isLink?'link-quick-send':'drop-zone')?.classList.remove('drag-active'); }
function onDrop(e, isLink=false) {
  e.preventDefault();
  $(isLink?'link-quick-send':'drop-zone')?.classList.remove('drag-active');
  selectedFiles = Array.from(e.dataTransfer.files);
  if (isLink) { linkQuickSend(); return; }
  if (selectedFiles.length) renderFileList(selectedFiles);
}

function renderFileList(files) {
  if (!files.length) return;
  const total = files.reduce((s,f) => s+f.size, 0);
  const cl = $('files-count-lbl'), sl = $('files-size-lbl'),
        ll = $('files-list'),     pl = $('files-panel'), btn = $('btn-start');
  if (cl)  cl.textContent = `${files.length} file${files.length>1?'s':''}`;
  if (sl)  sl.textContent = fmtBytes(total);
  if (ll)  ll.innerHTML   = files.map(f=>`
    <div style="display:flex;align-items:center;gap:8px;font-size:12px;padding:3px 0;">
      <span>${fileEmoji(f.name)}</span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.65);">${escHtml(f.name)}</span>
      <span class="mono" style="color:var(--text-muted);">${fmtBytes(f.size)}</span>
    </div>`).join('');
  if (pl)  pl.style.display = 'block';
  if (btn) btn.disabled = false;
}

// Link Pair quick-send: drop a file from the landing page
async function linkQuickSend() {
  if (!LINK_PAIR.isOnline()) { showToast('Partner offline','‚ö†Ô∏è','red'); return; }
  if (!selectedFiles.length) { pickFiles(); return; }
  // Navigate to send flow with files pre-selected, then start session
  initSend();
  await new Promise(r => setTimeout(r, 50));
  renderFileList(selectedFiles);
  // Auto-start session
  startSenderSession();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILD BLOB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buildBlob(files) {
  if (files.length === 1) return { blob:files[0], name:files[0].name };
  if (typeof JSZip === 'undefined') throw new Error('JSZip not loaded');
  const zip = new JSZip();
  for (const f of files) zip.file(f.name, f, { binary:true });
  const blob = await zip.generateAsync(
    { type:'blob', compression:'DEFLATE', compressionOptions:{ level:3 } },
    m => { if(m.percent%25<2) dbg('ZIP',`${m.percent.toFixed(0)}%`); }
  );
  return { blob, name:`ghost-share-${Date.now()}.zip` };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE DISPLAY + QR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function displayCode(code) {
  myCode = code;
  const el = $('code-display');
  if (!el) return;
  el.innerHTML = code.split('').map(ch =>
    `<div class="code-box">${ch}</div>`
  ).join('');
  genQR('qr-sender', code, '#7B5CF6');
  _updateSecBadges();
}
function copyCode() {
  if (!myCode) return;
  navigator.clipboard?.writeText(myCode).then(()=>showToast('Code copied!','‚úÖ','green'))
    .catch(()=>showToast('Code: '+myCode,'üìã','violet'));
}
function genQR(cid, text, color) {
  const el = $(cid); if(!el||typeof QRCode==='undefined') return;
  el.innerHTML = '';
  try { new QRCode(el,{text,width:160,height:160,colorDark:color||'#7B5CF6',colorLight:'#030610',correctLevel:QRCode.CorrectLevel.M}); }
  catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESUME DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkForResume() {
  try {
    const meta = await IDB.getLatestMeta();
    if (!meta) return;
    if ((Date.now() - meta.timestamp) / 60000 > 60) { IDB.clearTransfer(meta.transferId); return; }
    const pct = Math.round((meta.receivedCount / meta.totalChunks) * 100);
    const banner = $('resume-banner'), info = $('resume-info');
    if (!banner || !info) return;
    info.innerHTML = `<b style="color:rgba(255,255,255,0.7);">${escHtml(meta.name)}</b> ‚Äî ${fmtBytes(meta.size)} ‚Äî ${pct}% received`;
    banner.style.display = 'block';
    banner._resumeMeta   = meta;
  } catch(e) { dbgWarn('RESUME','checkForResume:',e); }
}
function clearResume() {
  const b = $('resume-banner');
  if (b?._resumeMeta) IDB.clearTransfer(b._resumeMeta.transferId);
  hide('resume-banner');
  showToast('Resume data cleared','üóëÔ∏è','violet');
}
function checkCodeReady() {
  const v = ($('code-input')?.value||'').trim();
  const btn = $('btn-connect'); if(btn) btn.disabled = v.length !== 6;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS ‚Äî SENDER
//  (multi-receiver broadcast, identical to v4 plus enc + destruct)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startSenderSession() {
  if (!selectedFiles.length) { showToast('Select files first','‚ö†Ô∏è','red'); return; }

  // Validate encryption password if enabled
  if (encEnabled) {
    encPassword = $('enc-password')?.value || '';
    if (encPassword.length < 1) {
      showToast('Enter a passphrase to enable encryption','‚ö†Ô∏è','red'); return;
    }
  }

  const btn = $('btn-start');
  if (btn) { btn.disabled=true; btn.textContent='Preparing...'; }

  showToast('Preparing files...','üì¶','violet');
  try { transferBlob = await buildBlob(selectedFiles); }
  catch(e) {
    dbgErr('BLOB','buildBlob failed:',e);
    showToast('Failed to prepare files','‚ùå','red');
    if(btn) { btn.disabled=false; btn.innerHTML='üöÄ Generate Code &amp; Start Session'; }
    return;
  }

  totalBytes = transferBlob.blob.size;

  // ‚îÄ‚îÄ Derive AES key if encryption is on ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (encEnabled && encPassword) {
    senderSaltHex = AES_CRYPTO.genSalt();
    showToast('Deriving encryption key (PBKDF2)...','üîë','violet');
    try {
      senderAesKey = await AES_CRYPTO.deriveKey(encPassword, hexToBytes(senderSaltHex));
      dbg('SEC',`AES key derived, salt=${senderSaltHex.substring(0,8)}...`);
    } catch(e) {
      dbgErr('SEC','Key derivation failed:',e);
      showToast('Key derivation failed','‚ùå','red');
      if(btn) { btn.disabled=false; btn.innerHTML='üöÄ Generate Code &amp; Start Session'; }
      return;
    }
  } else {
    senderAesKey = null; senderSaltHex = '';
  }

  // Pre-compute sender Merkle hashes in the background
  senderChunkHashes = [];
  computeSenderHashes(transferBlob.blob);

  const code   = genCode();
  const iceCfg = buildIceConfig('s');
  dbg('PEER',`Creating sender peer id="${code}"`);

  peer = new Peer(code, { config:iceCfg, debug:0 });

  peer.on('open', id => {
    dbg('PEER',`Sender open id="${id}"`);
    displayCode(id);
    showSendStep(2);
    showToast(`Code: ${id} ‚Äî share it!`,'üì°','violet');

    // Auto-broadcast to linked partner for zero-click receive
    LINK_PAIR.broadcast(id);
  });

  peer.on('connection', c => {
    const shortId = (c.peer||'').slice(-4).toUpperCase() || `R${connections.length+1}`;
    dbg('PEER',`New receiver: ${shortId}`);
    const connObj = { id:shortId, conn:c, fromChunk:0, sentBytes:0, status:'waiting', cardEl:null, _resolveHello:null };
    connections.push(connObj);
    c.serialization = 'raw';

    c.on('open',  ()  => { showFlex('conn-badge'); updateReceiverCount(); addReceiverCard(connObj); startConnectionLoop(connObj); });
    c.on('data',  raw => { if(typeof raw==='string'){try{handleSenderCtrlMsg(connObj,JSON.parse(raw));}catch(e){}} });
    c.on('error', e   => { dbgErr('CONN',`${shortId} error:`,e); connObj.status='error'; updateReceiverCard(connObj); });
    c.on('close', ()  => { dbgWarn('CONN',`${shortId} closed`); connObj.status='error'; updateReceiverCard(connObj); updateReceiverCount(); });
  });

  peer.on('error', e => {
    dbgErr('PEER','Sender error:',e);
    if (e.type==='unavailable-id') { peer.destroy(); peer=null; startSenderSession(); }
    else { showToast(`Peer error: ${e.type}`,'‚ùå','red'); if(btn){btn.disabled=false;btn.innerHTML='üöÄ Generate Code &amp; Start Session';} }
  });
}

/** Background pre-compute of chunk hashes over plaintext blob */
async function computeSenderHashes(blob) {
  const n = Math.ceil(blob.size / CHUNK_SIZE);
  senderChunkHashes = new Array(n);
  for (let i = 0; i < n; i++) {
    const start = i * CHUNK_SIZE;
    const buf   = await blob.slice(start, Math.min(start+CHUNK_SIZE, blob.size)).arrayBuffer();
    senderChunkHashes[i] = new Uint8Array(await crypto.subtle.digest('SHA-256', buf));
  }
  dbg('HASH',`All ${n} chunk hashes computed`);
}

function handleSenderCtrlMsg(connObj, msg) {
  dbg('CTRL',`Sender got msg type="${msg.type}" from ${connObj.id}`);

  if (msg.type === 'hello') {
    connObj.fromChunk = msg.resumeFrom || 0;
    if (connObj._resolveHello) { connObj._resolveHello(); connObj._resolveHello=null; }
  }

  if (msg.type === 'verify') {
    const ok = msg.ok;
    connObj.status = ok ? 'done' : 'error';
    updateReceiverCard(connObj);
    showToast(ok?`‚úì ${connObj.id} verified`:`‚ö† ${connObj.id} hash mismatch`,ok?'‚úÖ':'‚ö†Ô∏è',ok?'green':'red');

    // Update UI
    const vs = $('verify-status');
    if (vs) vs.innerHTML = ok
      ? `<div class="hash-ok" style="text-align:center;font-size:13px;font-weight:600;color:#22c55e;">‚úÖ Receiver confirmed every byte is intact</div>`
      : `<div class="hash-fail" style="text-align:center;font-size:13px;font-weight:600;color:#ef4444;">‚ö† Integrity check failed ‚Äî ask receiver to retry</div>`;

    // All receivers done?
    const allDone = connections.every(c => c.status==='done'||c.status==='error');
    if (allDone) {
      transferComplete = true;
      finishUI(false);

      // ‚îÄ‚îÄ AUTO-DESTRUCT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      //  Revoke peer ID + destroy connection immediately after
      //  at least one successful verify ACK.
      if (autoDestruct && ok) {
        dbg('DESTRUCT','Auto-destruct triggered!');
        showToast('üí• Auto-destruct ‚Äî session destroyed','üí•','red');
        // Brief visual flash then destroy
        const ring = $('ring-wrap');
        if (ring) ring.classList.add('destruct-anim');
        setTimeout(() => {
          connections.forEach(c => { try{c.conn.close();}catch(e){} });
          if (peer) { try{peer.destroy();}catch(e){} peer=null; }
          hide('conn-badge');
          const st = $('xfer-status');
          if (st) { st.textContent='üí• Session destroyed'; st.style.color='#ef4444'; }
        }, 600);
      }
    }
  }

  if (msg.type==='pause')  { globalIsPaused=true;  renderGlobalPauseState(true); showToast(`${connObj.id} paused`,'‚è∏','amber'); }
  if (msg.type==='resume') { doGlobalResume(); }
}

// ‚îÄ‚îÄ Per-receiver send loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startConnectionLoop(connObj) {
  connObj.status = 'waiting';
  updateReceiverCard(connObj);

  // Wait for hello (carries resumeFrom)
  await Promise.race([
    new Promise(r => { connObj._resolveHello = r; }),
    new Promise(r => setTimeout(r, 3000)),
  ]);

  const { blob, name } = transferBlob;
  const totalChunks    = Math.ceil(totalBytes / CHUNK_SIZE);
  const startChunk     = connObj.fromChunk || 0;

  // META ‚Äî tell receiver name, size, chunk count, encryption params
  connObj.conn.send(JSON.stringify({
    type:       'meta',
    name,
    size:       totalBytes,
    mime:       blob.type || 'application/octet-stream',
    chunks:     totalChunks,
    fromChunk:  startChunk,
    transferId: makeTransferId(name, totalBytes),
    // Encryption fields (empty strings when not encrypting)
    encrypted:  !!senderAesKey,
    salt:       senderSaltHex,  // 32-char hex; '' if no encryption
  }));
  dbg('XFER',`${connObj.id} META sent (chunk ${startChunk}, enc=${!!senderAesKey})`);

  connObj.status    = 'active';
  connObj.sentBytes = startChunk * CHUNK_SIZE;
  updateReceiverCard(connObj);
  showSendStep(3);
  renderSenderProgressUI(name);
  xferStart = performance.now();

  const rawDC = connObj.conn._dc || connObj.conn.dataChannel;
  if (rawDC) rawDC.bufferedAmountLowThreshold = LOW_WATER;

  for (let i = startChunk; i < totalChunks; i++) {
    // Pause gate
    if (globalIsPaused) {
      await new Promise(r => { pauseResolve = r; });
    }

    // Backpressure gate
    const dc = connObj.conn._dc || connObj.conn.dataChannel;
    if (dc && dc.bufferedAmount > HIGH_WATER) {
      await new Promise(r => {
        if (!dc) return r();
        const h = () => { dc.removeEventListener('bufferedamountlow',h); r(); };
        dc.addEventListener('bufferedamountlow',h);
        setTimeout(()=>{dc.removeEventListener('bufferedamountlow',h);r();},10000);
      });
    }

    // Read plaintext chunk
    const start  = i * CHUNK_SIZE;
    const end    = Math.min(start + CHUNK_SIZE, totalBytes);
    let   buffer = await blob.slice(start, end).arrayBuffer();

    // ‚îÄ‚îÄ ENCRYPT (if enabled) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  Encryption happens here, after hashing (hashes computed
    //  separately in computeSenderHashes over plaintext). This
    //  means Merkle verification always checks the raw file.
    if (senderAesKey) {
      buffer = await AES_CRYPTO.encryptChunk(senderAesKey, buffer);
    }

    try { connObj.conn.send(buffer); }
    catch(e) { dbgErr('XFER',`${connObj.id} send error chunk ${i}:`,e); connObj.status='error'; updateReceiverCard(connObj); return; }

    connObj.sentBytes = end;
    updateReceiverCard(connObj);

    const aggBytes = connections.reduce((s,c) => s+c.sentBytes, 0) / connections.length;
    tickSpeed(aggBytes);
    if (i % 64 === 0 || i === totalChunks-1) dbg('XFER',`${connObj.id} ${i+1}/${totalChunks}`);
  }

  // DONE
  const hashes   = await waitForHashes(totalChunks);
  const fileHash = await computeMerkleHash(hashes);
  connObj.conn.send(JSON.stringify({ type:'done', hash:fileHash }));
  connObj.status = 'waiting-verify';
  updateReceiverCard(connObj);
  dbg('XFER',`${connObj.id} DONE, hash=${fileHash.substring(0,16)}...`);
}

async function waitForHashes(n) {
  const dl = Date.now() + 30000;
  while (senderChunkHashes.filter(Boolean).length < n && Date.now() < dl)
    await new Promise(r=>setTimeout(r,100));
  return senderChunkHashes.slice(0,n);
}

// ‚îÄ‚îÄ Sender Pause/Resume ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pauseAll() {
  globalIsPaused = true; renderGlobalPauseState(true);
  connections.forEach(c => { try{c.conn.send(JSON.stringify({type:'pause'}));}catch(e){} });
}
function resumeAll() {
  doGlobalResume();
  connections.forEach(c => { try{c.conn.send(JSON.stringify({type:'resume'}));}catch(e){} });
}
function doGlobalResume() {
  globalIsPaused = false;
  if (pauseResolve) { pauseResolve(); pauseResolve=null; }
  renderGlobalPauseState(false);
}
function renderGlobalPauseState(paused) {
  const btn = $('global-pause-btn'); if(!btn) return;
  btn.className   = paused ? 'btn-resume' : 'btn-pause';
  btn.textContent = paused ? '‚ñ∂ Resume All' : '‚è∏ Pause All';
  btn.onclick     = paused ? resumeAll : pauseAll;
}

// ‚îÄ‚îÄ Receiver cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateReceiverCount() {
  const badge = $('receiver-count-badge'), n = connections.length;
  if (badge) badge.textContent = `${n} connected`;
  const wi = $('waiting-indicator'), rl = $('receivers-list');
  if (wi) wi.style.display = n>0?'none':'block';
  if (rl) rl.style.display = n>0?'block':'none';
}
function addReceiverCard(co) {
  const rl = $('receivers-list'); if(!rl) return;
  const div = document.createElement('div');
  div.id = `rcard-${co.id}`; div.className='receiver-card';
  rl.appendChild(div); co.cardEl=div; updateReceiverCard(co);
}
function updateReceiverCard(co) {
  const card = co.cardEl; if(!card) return;
  const pct  = totalBytes>0?Math.round((co.sentBytes/totalBytes)*100):0;
  const statusColor = {waiting:'var(--text-muted)',active:'#7B5CF6',paused:'#f59e0b',done:'#22c55e',error:'#ef4444','waiting-verify':'#06B6D4'}[co.status]||'#fff';
  const statusLabel = {waiting:'Waiting',active:`${pct}%`,paused:'Paused',done:'‚úì Done',error:'‚úó Error','waiting-verify':'Verifying...'}[co.status]||co.status;
  card.className = `receiver-card ${co.status==='active'?'active-xfer':co.status==='done'?'done-xfer':''}`;
  card.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:8px;height:8px;border-radius:50%;background:${statusColor};flex-shrink:0;"></div>
      <span class="mono" style="font-size:12px;font-weight:600;">Receiver ${co.id}</span>
      <div style="flex:1;"></div>
      <span style="font-size:12px;font-weight:700;color:${statusColor};">${statusLabel}</span>
      <span class="mono" style="font-size:10px;color:var(--text-muted);">${fmtBytes(co.sentBytes)} / ${fmtBytes(totalBytes)}</span>
    </div>
    <div class="mini-bar-track"><div class="mini-bar-fill" style="width:${pct}%;${co.status==='done'?'background:linear-gradient(90deg,#22c55e,#16a34a)':''}"></div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS ‚Äî RECEIVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectToSender() {
  const code = ($('code-input')?.value||'').trim().toUpperCase();
  if (code.length!==6) { showToast('Enter a 6-character code','‚ö†Ô∏è','red'); return; }
  const btn = $('btn-connect'); if(btn){btn.disabled=true;btn.textContent='Connecting...';}
  peer = new Peer({ config:buildIceConfig('r'), debug:0 });
  peer.on('open', () => {
    recvConn = peer.connect(code, { reliable:true, serialization:'raw' });
    recvConn.on('open', async () => {
      dbg('PEER','Connected to sender');
      showFlex('conn-badge');
      const lbl = $('conn-label'); if(lbl){lbl.textContent='Connected';lbl.style.color='#06B6D4';}
      showReceiveStep(2);
      renderReceiveWaiting();
      recvConn.on('data', raw => { recvQueue.push(raw); if(!recvProcessing) _drainRecvQueue(); });
      // Announce ourselves + resume offset
      const banner = $('resume-banner');
      const rm = banner?._resumeMeta;
      recvFromChunk = rm ? rm.receivedCount : 0;
      recvConn._resumeMeta = rm || null;
      recvConn.send(JSON.stringify({ type:'hello', resumeFrom:recvFromChunk }));
    });
    recvConn.on('error', e => { dbgErr('CONN','recv error:',e); showToast('Connection failed ‚Äî check code','‚ùå','red'); if(btn){btn.disabled=false;btn.textContent='üîó Connect & Receive';} });
    recvConn.on('close', () => {
      if (inMeta && recvBytes < totalBytes && !transferComplete) {
        IDB.saveMeta({ transferId:inMeta.transferId, name:inMeta.name, size:inMeta.size,
          mime:inMeta.mime, totalChunks:inMeta.chunks, receivedCount:inChunks.filter(Boolean).length });
        showToast('Connection dropped ‚Äî re-enter code to resume','üì°','amber');
      } else if (!transferComplete) { onDisconnect(); }
    });
  });
  peer.on('error', e => {
    dbgErr('PEER','recv peer error:',e);
    showToast(e.type==='peer-unavailable'?`Code not found ‚Äî check and retry`:`Error: ${e.type}`,'‚ùå','red');
    if(btn){btn.disabled=false;btn.textContent='üîó Connect & Receive';}
  });
}

function renderReceiveWaiting() {
  const el = $('recv-progress-area'); if(!el) return;
  el.innerHTML=`
    <div class="glass-card" style="padding:28px;text-align:center;">
      <div class="pulse-wrap" style="width:56px;height:56px;margin:0 auto 16px;position:relative;">
        <div class="pulse-ring-el" style="background:rgba(6,182,212,0.15);inset:0;position:absolute;border-radius:50%;"></div>
        <div class="pulse-core" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
          background:rgba(6,182,212,0.2);border:1px solid rgba(6,182,212,0.3);position:relative;z-index:1;font-size:16px;">üì°</div>
      </div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px;">Connected ‚Äî waiting for file...</div>
      <div style="font-size:12px;color:var(--text-muted);">Sender will start the transfer momentarily</div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECEIVE DATA QUEUE
//
//  Sequential async processing of the incoming data stream.
//  This is required because AES-GCM decryption is async, and
//  WebRTC delivers chunks to conn.on('data') synchronously.
//  Without a queue, awaiting decrypt would cause processing of
//  chunk N+1 to begin before chunk N is stored, corrupting the
//  inChunks array index.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function _drainRecvQueue() {
  recvProcessing = true;
  while (recvQueue.length > 0) {
    const item = recvQueue.shift();
    await _processOneRecvItem(item);
  }
  recvProcessing = false;
}

async function _processOneRecvItem(data) {
  // ‚îÄ‚îÄ Control messages (JSON strings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (typeof data === 'string') {
    let msg;
    try { msg = JSON.parse(data); } catch(e) { return; }

    if (msg.type === 'meta') {
      dbg('RECV','‚ïê‚ïê‚ïê META ‚ïê‚ïê‚ïê', msg);
      inMeta     = { ...msg, transferId: msg.transferId || makeTransferId(msg.name, msg.size) };
      totalBytes = msg.size;
      recvBytes  = 0;
      recvChunkHashes = [];
      speedWindow=[]; speedHistory=[]; lastPerfTime=xferStart=performance.now(); lastPerfBytes=0;

      // ‚îÄ‚îÄ Derive decryption key from META's salt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      //  IMPORTANT: this must happen before any binary chunks
      //  arrive. Since SCTP is ordered and we await this, the
      //  queue ensures the next item (first chunk) waits.
      if (msg.encrypted && msg.salt) {
        const pwd = $('recv-password')?.value || '';
        if (!pwd) {
          showToast('‚ö† File is encrypted ‚Äî enter the passphrase!','üîë','red');
          // Open the security panel automatically
          const p = $('conf-sec-r'); if(p&&!p.classList.contains('open')) toggleConf('sec-r');
        }
        try {
          recvAesKey = await AES_CRYPTO.deriveKey(pwd, hexToBytes(msg.salt));
          dbg('SEC','Receiver AES key derived');
        } catch(e) { dbgErr('SEC','Receiver key derivation failed:',e); recvAesKey=null; }
      } else {
        recvAesKey = null;
      }

      // Pre-allocate inChunks array
      inChunks = new Array(msg.chunks).fill(null);

      // If resuming: restore persisted chunks from IDB
      const rm = recvConn?._resumeMeta;
      if (rm && msg.fromChunk > 0) {
        dbg('RESUME',`Loading ${msg.fromChunk} chunks from IDB...`);
        showToast(`Resuming from ${Math.round(msg.fromChunk/msg.chunks*100)}%...`,'‚è©','cyan');
        const stored = await IDB.loadChunks(inMeta.transferId, msg.chunks);
        for (let i = 0; i < msg.fromChunk; i++) {
          if (stored[i]) { inChunks[i]=stored[i]; recvBytes+=stored[i].byteLength; }
        }
        dbg('RESUME',`Restored ${inChunks.filter(Boolean).length} chunks`);
      }

      await IDB.saveMeta({ transferId:inMeta.transferId, name:msg.name, size:msg.size,
        mime:msg.mime, totalChunks:msg.chunks, receivedCount:msg.fromChunk||0 });

      renderReceiverProgressUI('recv-progress-area', msg.name);
      updateRing(recvBytes/totalBytes);
    }

    if (msg.type === 'done') {
      dbg('RECV','‚ïê‚ïê‚ïê DONE ‚ïê‚ïê‚ïê');
      assembleAndDownload(msg.hash);
    }

    if (msg.type === 'pause') {
      const st=$('xfer-status'); if(st){st.textContent='‚è∏ Sender paused';st.style.color='#f59e0b';}
    }
    if (msg.type === 'resume') {
      const st=$('xfer-status'); if(st){st.textContent='Receiving...';st.style.color='var(--text-muted)';}
    }
    return;
  }

  // ‚îÄ‚îÄ Binary chunk ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (data instanceof ArrayBuffer || data instanceof Uint8Array) {
    let buf = data instanceof Uint8Array ? data.buffer : data;

    // ‚îÄ‚îÄ DECRYPT (if key was derived from META) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  Decryption happens here on the received bytes, BEFORE hashing.
    //  The Merkle hash is over the plaintext, so we decrypt first,
    //  then hash the plaintext to match what the sender computed.
    if (recvAesKey) {
      try {
        buf = await AES_CRYPTO.decryptChunk(recvAesKey, buf);
      } catch(e) {
        dbgErr('RECV','Decrypt failed ‚Äî wrong password?', e);
        showToast('Decryption failed ‚Äî wrong passphrase?','‚ùå','red');
        return;
      }
    }

    // Find next empty slot (SCTP delivers in order, so sequential)
    const idx = inChunks.findIndex(c => c===null);
    if (idx === -1) { dbgWarn('RECV','Extra chunk ignored'); return; }

    inChunks[idx] = buf;
    recvBytes += buf.byteLength;

    // Hash plaintext chunk asynchronously
    const ci = idx;
    crypto.subtle.digest('SHA-256', buf).then(h => { recvChunkHashes[ci] = new Uint8Array(h); });

    // Persist to IDB (fire-and-forget)
    if (inMeta) {
      IDB.saveChunk(inMeta.transferId, idx, buf).catch(()=>{});
      if (idx % 64 === 0)
        IDB.saveMeta({ ...inMeta, receivedCount:idx+1, totalChunks:inMeta.chunks }).catch(()=>{});
    }

    if (idx % 64 === 0) dbg('RECV',`Chunk #${idx} | ${fmtBytes(recvBytes)}/${fmtBytes(totalBytes)}`);
    tickSpeed(recvBytes);
    updateRing(recvBytes/totalBytes);
  }
}

async function assembleAndDownload(expectedHash) {
  dbg('RECV',`assembleAndDownload expectedHash=${expectedHash?.substring(0,16)}`);

  // Wait for all async chunk hashes
  const totalChunks = inChunks.length;
  const deadline    = Date.now() + 5000;
  while (recvChunkHashes.filter(Boolean).length < totalChunks && Date.now() < deadline)
    await new Promise(r=>setTimeout(r,50));

  const hashEl = $('hash-status');
  if (hashEl) { hashEl.style.display='block'; hashEl.className='hash-wait'; hashEl.innerHTML='<span style="color:#f59e0b;font-weight:600;">üîê Verifying SHA-256 integrity...</span>'; }

  let hashOk=false, actualHash='';
  try {
    const valid = recvChunkHashes.slice(0,totalChunks).filter(Boolean);
    actualHash  = await computeMerkleHash(valid);
    hashOk      = (actualHash===expectedHash && valid.length===totalChunks);
  } catch(e) { dbgErr('RECV','Hash error:',e); }

  // Trigger download
  const blob = new Blob(inChunks.filter(Boolean), { type:inMeta?.mime||'application/octet-stream' });
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement('a'),{href:url,download:inMeta?.name||'download'});
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),5000);

  if (hashEl) {
    hashEl.className = hashOk ? 'hash-ok' : 'hash-fail';
    hashEl.innerHTML = hashOk
      ? `<span style="color:#22c55e;font-weight:600;">‚úì SHA-256 verified ‚Äî file intact</span><br/>
         <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.3);">${actualHash.substring(0,32)}...</span>`
      : `<span style="color:#ef4444;font-weight:600;">‚úó Hash mismatch ‚Äî data may be corrupt</span>`;
  }

  if (recvConn) recvConn.send(JSON.stringify({ type:'verify', ok:hashOk, hash:actualHash }));
  if (hashOk && inMeta) IDB.clearTransfer(inMeta.transferId);

  showToast(hashOk?`‚úì ${inMeta?.name} downloaded`:'‚ö† Download done ‚Äî hash mismatch',
            hashOk?'‚úÖ':'‚ö†Ô∏è', hashOk?'green':'red');

  transferComplete = true;
  finishUI(hashOk);
  inChunks=[]; recvChunkHashes=[];
}

// Receiver pause/resume
function recvPause()  {
  recvIsPaused=true;
  if(recvConn) recvConn.send(JSON.stringify({type:'pause'}));
  const btn=$('pause-btn'); if(btn){btn.className='btn-resume';btn.textContent='‚ñ∂ Resume';btn.onclick=recvResume;}
  const st=$('xfer-status'); if(st){st.textContent='‚è∏ Paused';st.style.color='#f59e0b';}
}
function recvResume() {
  recvIsPaused=false;
  if(recvConn) recvConn.send(JSON.stringify({type:'resume'}));
  const btn=$('pause-btn'); if(btn){btn.className='btn-pause';btn.textContent='‚è∏ Pause';btn.onclick=recvPause;}
  const st=$('xfer-status'); if(st){st.textContent='Receiving...';st.style.color='var(--text-muted)';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS UI ‚Äî SENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSenderProgressUI(filename) {
  const el=$('sender-progress-area'); if(!el||el.dataset.rendered) return;
  el.dataset.rendered='1';
  const circ=(2*Math.PI*44).toFixed(2);
  el.innerHTML=`
    <div class="glass-card" style="padding:18px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:100px;height:100px;">
          <svg width="100" height="100" viewBox="0 0 104 104">
            <defs>
              <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#7B5CF6"/>
                <stop offset="100%" stop-color="#2563eb"/>
              </linearGradient>
            </defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:19px;font-weight:800;">0%</span>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.7);margin-bottom:5px;">${escHtml(filename)}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
            <div class="conn-dot" style="width:7px;height:7px;border-radius:50%;background:#22c55e;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">Sending...</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:5px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:26px;font-weight:700;color:var(--violet);line-height:1;">0.00</span>
            <span style="font-size:12px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:3px;">0 B / ${fmtBytes(totalBytes)}</div>
        </div>
      </div>
      <div class="label" style="margin-bottom:7px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:38px;"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>
      <div style="margin-top:14px;text-align:center;">
        <button id="global-pause-btn" class="btn-pause" style="padding:9px 24px;font-size:12px;" onclick="pauseAll()">‚è∏ Pause All</button>
      </div>
    </div>
    <!-- Per-receiver cards -->
    <div class="glass-card" style="padding:14px;margin-bottom:14px;">
      <div class="label" style="margin-bottom:10px;">Receivers</div>
      <div id="sender-receivers-list"></div>
    </div>
    <div id="verify-status" style="margin-bottom:12px;"></div>`;

  setTimeout(()=>{
    const srl=$('sender-receivers-list'); if(!srl) return;
    connections.forEach(c=>{
      const d=document.createElement('div'); d.id=`rcard-${c.id}`; d.className='receiver-card';
      srl.appendChild(d); c.cardEl=d; updateReceiverCard(c);
    });
  },50);
  startElapsedTimer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS UI ‚Äî RECEIVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReceiverProgressUI(containerId, filename) {
  const el=$(containerId); if(!el) return;
  const circ=(2*Math.PI*44).toFixed(2);

  // Encryption indicator shown in progress UI
  const encHint = inMeta?.encrypted
    ? `<span class="enc-badge" style="margin-left:8px;">üîë AES-256-GCM</span>` : '';

  el.innerHTML=`
    <div class="glass-card" style="padding:18px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:100px;height:100px;">
          <svg width="100" height="100" viewBox="0 0 104 104">
            <defs>
              <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#06B6D4"/>
                <stop offset="100%" stop-color="#7B5CF6"/>
              </linearGradient>
            </defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:19px;font-weight:800;">0%</span>
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.7);margin-bottom:5px;">
            ${escHtml(filename)}${encHint}
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
            <div class="conn-dot" style="width:7px;height:7px;border-radius:50%;background:#06B6D4;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">Receiving...</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:5px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:26px;font-weight:700;color:var(--cyan);line-height:1;">0.00</span>
            <span style="font-size:12px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:3px;">0 B / ${fmtBytes(totalBytes)}</div>
        </div>
      </div>
      <div class="label" style="margin-bottom:7px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:38px;"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>
      <div style="margin-top:14px;text-align:center;">
        <button id="pause-btn" class="btn-pause" style="padding:9px 24px;font-size:12px;" onclick="recvPause()">‚è∏ Pause</button>
      </div>
    </div>
    <div id="hash-status" class="hash-wait" style="display:none;margin-bottom:12px;">
      <span style="color:#f59e0b;font-weight:600;">üîê Awaiting hash...</span>
    </div>`;

  startElapsedTimer();
  if (recvBytes > 0 && totalBytes > 0) updateRing(recvBytes/totalBytes);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPEED & PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickSpeed(bytes) {
  const now=performance.now(), dt=(now-lastPerfTime)/1000;
  if(dt<0.15) return;
  const rate=(bytes-lastPerfBytes)/dt; if(rate<0) return;
  speedWindow.push(rate); if(speedWindow.length>10) speedWindow.shift();
  speedHistory.push(rate); if(speedHistory.length>28) speedHistory.shift();
  lastPerfTime=now; lastPerfBytes=bytes;
  paintSpeed(bytes);
}

function paintSpeed(bytes) {
  const avg=speedWindow.reduce((a,b)=>a+b,0)/(speedWindow.length||1);
  const mbps=avg/(1024*1024);
  const sv=$('speed-val'); if(sv) sv.textContent=mbps.toFixed(2);
  const bl=$('bytes-lbl'); if(bl) bl.textContent=`${fmtBytes(bytes)} / ${fmtBytes(totalBytes)}`;
  const eta=$('eta-lbl');
  if(eta&&avg>0){const rem=totalBytes-bytes;const s=rem/avg;eta.textContent=s<60?`~${s.toFixed(0)}s remaining`:`~${(s/60).toFixed(1)}m remaining`;}
  const barsEl=$('speed-bars'); if(!barsEl) return;
  const arr=speedHistory, maxSpd=Math.max(...arr,1), pad=28-arr.length;
  barsEl.innerHTML=[...Array(pad).fill(0),...arr].map(s=>{
    const f=s/maxSpd,h=Math.max(3,f*36),r=Math.round(73+f*95),g=Math.round(40+f*20),op=(0.3+f*0.7).toFixed(2);
    return `<div class="speed-bar" style="flex:1;height:${h.toFixed(1)}px;background:rgb(${r},${g},246);opacity:${op};"></div>`;
  }).join('');
}

function updateRing(pct) {
  const ring=$('ring-fill'),pctEl=$('ring-pct'); if(!ring) return;
  const circ=2*Math.PI*44;
  ring.style.strokeDashoffset=(circ*(1-pct)).toFixed(2);
  const avg=speedWindow.length?speedWindow.reduce((a,b)=>a+b,0)/speedWindow.length:0;
  const glow=Math.min(3+(avg/(1024*1024))*1.2,30);
  const wrap=$('ring-wrap'); if(wrap) wrap.style.filter=`drop-shadow(0 0 ${glow.toFixed(1)}px rgba(123,92,246,${Math.min(0.4+(avg/(1024*1024))*0.04,0.95).toFixed(2)}))`;
  if(pctEl) pctEl.textContent=`${Math.round(pct*100)}%`;
}

function finishUI(hashOk) {
  clearInterval(elapsedTimer); updateRing(1);
  const s=$('xfer-status'); if(s){s.textContent=isSender?'‚úì Sent':'‚úì Downloaded';s.style.color='#22c55e';}
  const hashEl=$('hash-status'); if(hashEl&&!isSender) hashEl.style.display='block';
  [$('pause-btn'),$('global-pause-btn')].forEach(b=>{if(b){b.disabled=true;b.style.opacity='0.4';}});
}

function startElapsedTimer() {
  clearInterval(elapsedTimer);
  elapsedTimer=setInterval(()=>{ const el=$('elapsed-lbl'); if(el) el.textContent=`${((performance.now()-xferStart)/1000).toFixed(1)}s elapsed`; },500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLEANUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cleanup() {
  clearInterval(elapsedTimer);
  globalIsPaused=false; recvIsPaused=false;
  if(pauseResolve){pauseResolve();pauseResolve=null;}
  recvQueue.length=0; recvProcessing=false;
  connections.forEach(c=>{try{c.conn.close();}catch(e){}});
  connections=[];
  if(recvConn){try{recvConn.close();}catch(e){}recvConn=null;}
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  selectedFiles=[]; inChunks=[]; recvChunkHashes=[]; senderChunkHashes=[];
  speedWindow=[]; speedHistory=[];
  totalBytes=recvBytes=0; inMeta=null; transferBlob=null; myCode=null;
  senderAesKey=null; recvAesKey=null; transferComplete=false;
}

function onDisconnect() {
  clearInterval(elapsedTimer); hide('conn-badge');
  showToast('Connection dropped','üì°','red');
  const s=$('xfer-status'); if(s){s.textContent='‚ö† Disconnected';s.style.color='#ef4444';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _toastTimer=null;
function showToast(msg,icon,color) {
  const toast=$('toast'),ie=$('toast-icon-el'),me=$('toast-msg'); if(!toast) return;
  if(ie) ie.textContent=icon||'‚Ñπ'; if(me) me.textContent=msg;
  toast.style.display='flex';
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>{toast.style.display='none';},4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function boot() {
  dbg('BOOT','boot()');

  // Init IndexedDB
  try { await IDB.init(); dbg('IDB','Ready'); }
  catch(e) { dbgWarn('IDB','Unavailable:',e.message); }

  // Init Link Pair (reads localStorage token and starts background peer)
  LINK_PAIR.init();

  // Dependency check
  const deps = {
    WebRTC:   typeof RTCPeerConnection!=='undefined',
    PeerJS:   typeof Peer!=='undefined',
    JSZip:    typeof JSZip!=='undefined',
    Crypto:   typeof crypto?.subtle!=='undefined',
    IDB:      typeof indexedDB!=='undefined',
  };
  for(const [n,ok] of Object.entries(deps)) dbg('DEPS',`${ok?'‚úî':'‚úò'} ${n}`);
  if (!deps.WebRTC) showToast('WebRTC not supported in this browser','‚ùå','red');
  if (!deps.PeerJS)  showToast('PeerJS failed to load ‚Äî check internet','‚ùå','red');
  if (!deps.Crypto)  showToast('Web Crypto API unavailable','‚ö†Ô∏è','red');

  showToast('GhostShare v5 ready üëª','üëª','violet');
  dbg('BOOT','‚úÖ Ready');
}

if (document.readyState==='loading') {
  document.addEventListener('DOMContentLoaded',boot);
} else { boot(); }
</script>
</body>
</html>
