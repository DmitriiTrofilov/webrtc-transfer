<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GhostShare ‚Äî P2P File Transfer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --violet: #7B5CF6;
      --violet-dim: rgba(123,92,246,0.15);
      --cyan: #06B6D4;
      --cyan-dim: rgba(6,182,212,0.15);
      --green: #22c55e;
      --red: #ef4444;
      --bg: #030610;
      --surface: rgba(255,255,255,0.028);
      --border: rgba(255,255,255,0.07);
      --border-glow: rgba(123,92,246,0.35);
      --text-muted: rgba(255,255,255,0.38);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html{scroll-behavior:smooth;}
    body{
      font-family:'Outfit',sans-serif;
      background-color:var(--bg);
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
    }
    body::before{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        radial-gradient(ellipse 60% 50% at 15% 40%, rgba(123,92,246,0.12) 0%, transparent 70%),
        radial-gradient(ellipse 50% 60% at 85% 20%, rgba(6,182,212,0.08) 0%, transparent 65%),
        radial-gradient(ellipse 40% 40% at 50% 90%, rgba(123,92,246,0.06) 0%, transparent 60%);
    }
    body::after{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),
        linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
      background-size:48px 48px;
      mask-image:radial-gradient(ellipse at center,black 30%,transparent 80%);
    }

    /* ‚îÄ‚îÄ GLASS ‚îÄ‚îÄ */
    .glass{background:var(--surface);border:1px solid var(--border);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);}
    .glass-card{
      background:rgba(255,255,255,0.035);border:1px solid var(--border);
      backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
      border-radius:16px;transition:border-color 0.3s;
    }
    .glass-card:hover{border-color:var(--border-glow);}

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-primary{
      background:linear-gradient(135deg,#6d40f5 0%,#2563eb 100%);
      border:1px solid rgba(109,64,245,0.5);border-radius:12px;
      font-weight:600;cursor:pointer;position:relative;overflow:hidden;color:#fff;
      transition:transform 0.2s,box-shadow 0.3s;
    }
    .btn-primary::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);
      transition:left 0.45s ease;
    }
    .btn-primary:hover::before{left:100%;}
    .btn-primary:hover{box-shadow:0 0 28px rgba(109,64,245,0.55),0 4px 20px rgba(0,0,0,0.4);transform:translateY(-1px);}
    .btn-primary:active{transform:translateY(0);}
    .btn-primary:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none;}

    .btn-ghost{
      background:rgba(255,255,255,0.045);border:1px solid var(--border);
      border-radius:10px;cursor:pointer;color:#fff;
      transition:background 0.2s,border-color 0.2s;
    }
    .btn-ghost:hover{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.14);}

    .btn-pause{
      background:rgba(234,179,8,0.12);border:1px solid rgba(234,179,8,0.3);
      border-radius:10px;cursor:pointer;color:#eab308;font-weight:600;
      transition:background 0.2s;
    }
    .btn-pause:hover{background:rgba(234,179,8,0.2);}
    .btn-resume{
      background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);
      border-radius:10px;cursor:pointer;color:#22c55e;font-weight:600;
      transition:background 0.2s;
    }
    .btn-resume:hover{background:rgba(34,197,94,0.2);}

    /* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
    .mono{font-family:'JetBrains Mono',monospace;}
    .label{font-size:11px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);}

    /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
    textarea,input[type="text"],input[type="url"]{
      font-family:'JetBrains Mono',monospace;font-size:11px;
      background:rgba(0,0,0,0.4);border:1px solid var(--border);
      color:rgba(255,255,255,0.8);outline:none;border-radius:10px;
      transition:border-color 0.25s,box-shadow 0.25s;resize:none;
    }
    textarea:focus,input:focus{
      border-color:rgba(123,92,246,0.5);
      box-shadow:0 0 0 3px rgba(123,92,246,0.1);
    }
    textarea::placeholder,input::placeholder{color:rgba(255,255,255,0.2);}

    /* ‚îÄ‚îÄ CODE DISPLAY BOXES (sender) ‚îÄ‚îÄ */
    .code-boxes{display:flex;gap:8px;justify-content:center;margin:8px 0;}
    .code-box{
      width:52px;height:64px;
      display:flex;align-items:center;justify-content:center;
      font-family:'JetBrains Mono',monospace;
      font-size:28px;font-weight:700;
      background:rgba(123,92,246,0.1);
      border:1.5px solid rgba(123,92,246,0.35);
      border-radius:14px;color:#fff;
      animation:codeGlow 2.5s ease-in-out infinite alternate;
      transition:all 0.3s;
    }
    @keyframes codeGlow{
      from{box-shadow:0 0 8px rgba(123,92,246,0.2);border-color:rgba(123,92,246,0.35);}
      to{box-shadow:0 0 22px rgba(123,92,246,0.55),inset 0 0 8px rgba(123,92,246,0.08);border-color:rgba(123,92,246,0.7);}
    }
    /* ‚îÄ‚îÄ CODE INPUT (receiver) ‚îÄ‚îÄ */
    .code-input-field{
      font-family:'JetBrains Mono',monospace;
      font-size:36px;font-weight:700;
      letter-spacing:0.35em;text-align:center;
      text-transform:uppercase;
      padding:18px 24px;
      background:rgba(0,0,0,0.5);
      border:1.5px solid var(--border);
      border-radius:16px;width:100%;color:#fff;
      outline:none;transition:border-color 0.25s,box-shadow 0.25s;
    }
    .code-input-field:focus{
      border-color:rgba(123,92,246,0.6);
      box-shadow:0 0 0 4px rgba(123,92,246,0.12),0 0 30px rgba(123,92,246,0.15);
    }
    .code-input-field::placeholder{color:rgba(255,255,255,0.12);letter-spacing:0.4em;}

    /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
    .screen{display:none;position:relative;z-index:1;}
    .screen.active{display:block;animation:fadeUp 0.4s cubic-bezier(0.16,1,0.3,1);}
    @keyframes fadeUp{
      from{opacity:0;transform:translateY(14px);}
      to{opacity:1;transform:translateY(0);}
    }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes logoPulse{
      0%,100%{box-shadow:0 0 0 0 rgba(123,92,246,0.5);}
      50%{box-shadow:0 0 0 10px rgba(123,92,246,0);}
    }
    .logo-icon{animation:logoPulse 3s ease-in-out infinite;}

    @keyframes connectedPulse{
      0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.6);}
      50%{box-shadow:0 0 0 5px rgba(34,197,94,0);}
    }
    .conn-dot{animation:connectedPulse 2s ease-in-out infinite;}

    @keyframes activePulseRing{
      0%{transform:scale(0.85);opacity:0.8;}
      100%{transform:scale(1.5);opacity:0;}
    }
    @keyframes activePulseDot{
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.12);}
    }
    .pulse-wrap{position:relative;display:flex;align-items:center;justify-content:center;}
    .pulse-ring-el{
      position:absolute;inset:0;border-radius:50%;
      animation:activePulseRing 1.8s cubic-bezier(0.215,0.61,0.355,1) infinite;
    }
    .pulse-core{animation:activePulseDot 2.2s ease-in-out infinite;}

    @keyframes floatY{
      0%,100%{transform:translateY(0) rotate(-2deg);}
      50%{transform:translateY(-8px) rotate(2deg);}
    }
    .float-icon{animation:floatY 4s ease-in-out infinite;}

    @keyframes barPulse{0%,100%{opacity:.8}50%{opacity:1}}
    .speed-bar{animation:barPulse 1.1s ease-in-out infinite;border-radius:3px 3px 0 0;}

    @keyframes shimmer{
      0%{background-position:-200% 0;}
      100%{background-position:200% 0;}
    }
    .shimmer-text{
      background:linear-gradient(90deg,#a78bfa,#38bdf8,#a78bfa);
      background-size:200% auto;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      animation:shimmer 3s linear infinite;
    }

    /* ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ */
    .progress-ring-track{fill:none;stroke:rgba(255,255,255,0.04);stroke-width:7;}
    .progress-ring-fill{
      fill:none;stroke-width:7;stroke:url(#ringGradient);stroke-linecap:round;
      transform:rotate(-90deg);transform-origin:50% 50%;
      transition:stroke-dashoffset 0.35s ease;
    }

    /* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
    .drop-zone{border:2px dashed rgba(123,92,246,0.3);transition:all 0.3s;cursor:pointer;}
    .drop-zone:hover,.drop-zone.drag-active{border-color:rgba(123,92,246,0.7);background:rgba(123,92,246,0.04);}

    /* ‚îÄ‚îÄ STEP DOTS ‚îÄ‚îÄ */
    .step-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.12);transition:all 0.3s;}
    .step-dot.active{background:var(--violet);box-shadow:0 0 8px rgba(123,92,246,0.7);}

    /* ‚îÄ‚îÄ CONFIG PANEL ‚îÄ‚îÄ */
    .config-content{overflow:hidden;max-height:0;transition:max-height 0.4s cubic-bezier(0.16,1,0.3,1);}
    .config-content.open{max-height:600px;}

    /* ‚îÄ‚îÄ HASH STATUS ‚îÄ‚îÄ */
    .hash-ok{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);border-radius:10px;padding:10px 14px;}
    .hash-fail{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:10px;padding:10px 14px;}
    .hash-wait{background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);border-radius:10px;padding:10px 14px;}

    /* ‚îÄ‚îÄ PAUSE OVERLAY ‚îÄ‚îÄ */
    @keyframes pausedPulse{0%,100%{opacity:0.7;}50%{opacity:1;}}
    .paused-label{animation:pausedPulse 1.5s ease-in-out infinite;}

    /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:rgba(123,92,246,0.4);border-radius:2px;}

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    @keyframes toastIn{
      from{opacity:0;transform:translate(-50%,20px);}
      to{opacity:1;transform:translate(-50%,0);}
    }
    #toast.visible{animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1);}

    /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
    .badge-violet{background:var(--violet-dim);border:1px solid rgba(123,92,246,0.25);}
    .badge-cyan{background:var(--cyan-dim);border:1px solid rgba(6,182,212,0.25);}
    .badge-green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);}
  </style>
</head>
<body>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-5 py-3"
  style="background:rgba(3,6,16,0.75);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);">
  <div class="flex items-center gap-3">
    <div class="logo-icon w-8 h-8 rounded-xl flex items-center justify-center"
      style="background:linear-gradient(135deg,#7B5CF6,#2563eb);font-size:16px;">üëª</div>
    <span style="font-weight:800;font-size:15px;letter-spacing:-0.02em;">
      Ghost<span style="color:var(--violet);">Share</span>
    </span>
    <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.2);">v3.0</span>
  </div>
  <div id="conn-badge" style="display:none;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;
    background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);">
    <div class="conn-dot w-2 h-2 rounded-full" style="background:#22c55e;"></div>
    <span style="font-size:12px;font-weight:600;color:#22c55e;" id="conn-label">Connected</span>
  </div>
</header>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main style="padding-top:80px;padding-bottom:64px;padding-left:16px;padding-right:16px;max-width:640px;margin:0 auto;">

  <!-- ‚ïê‚ïê‚ïê‚ïê LANDING ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-landing" class="screen active">
    <div class="text-center" style="padding:48px 0 32px;">
      <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full mb-8"
        style="background:rgba(255,255,255,0.04);border:1px solid var(--border);">
        <span style="width:6px;height:6px;border-radius:50%;background:var(--violet);display:inline-block;box-shadow:0 0 8px var(--violet);"></span>
        <span style="font-size:12px;color:var(--text-muted);">6-char code ¬∑ Zero server ¬∑ Pure P2P</span>
      </div>
      <h1 style="font-size:52px;font-weight:900;letter-spacing:-0.04em;line-height:1.05;margin-bottom:16px;">
        Ghost<span class="shimmer-text">Share</span>
      </h1>
      <p style="color:var(--text-muted);font-size:16px;line-height:1.6;max-width:360px;margin:0 auto 12px;">
        Share a 6-character code. No accounts, no uploads, no limits.
      </p>
      <p style="font-family:'JetBrains Mono';font-size:13px;color:var(--violet);margin-bottom:40px;opacity:0.8;">
        A1B2C3 ‚Üí instant encrypted transfer
      </p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:40px;">
        <button onclick="initSend()" class="glass-card text-left" style="padding:28px;cursor:pointer;">
          <div style="width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;
            margin-bottom:20px;background:rgba(123,92,246,0.15);border:1px solid rgba(123,92,246,0.2);font-size:22px;">üì§</div>
          <div style="font-size:17px;font-weight:700;margin-bottom:4px;">Send Files</div>
          <div style="font-size:13px;color:var(--text-muted);line-height:1.5;">Get a code, share it, done</div>
        </button>
        <button onclick="initReceive()" class="glass-card text-left" style="padding:28px;cursor:pointer;">
          <div style="width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;
            margin-bottom:20px;background:rgba(6,182,212,0.12);border:1px solid rgba(6,182,212,0.2);font-size:22px;">üì•</div>
          <div style="font-size:17px;font-weight:700;margin-bottom:4px;">Receive Files</div>
          <div style="font-size:13px;color:var(--text-muted);line-height:1.5;">Enter a 6-char code, download</div>
        </button>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
        <span class="badge-violet" style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üîí DTLS Encrypted</span>
        <span class="badge-violet" style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">‚àû Unlimited Size</span>
        <span class="badge-cyan"   style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üì° Firewall Bypass</span>
        <span class="badge-cyan"   style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">‚ö° Max Throughput</span>
        <span class="badge-green"  style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">üîê SHA-256 Verified</span>
        <span class="badge-green"  style="padding:6px 12px;border-radius:999px;font-size:11px;font-weight:500;">‚è∏ Pause / Resume</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê SEND ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-send" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">‚Üê Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Send Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Share a 6-char code</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="sdot-1"></div>
        <div class="step-dot" id="sdot-2"></div>
        <div class="step-dot" id="sdot-3"></div>
      </div>
    </div>

    <!-- SEND STEP 1: file select -->
    <div id="s-step-1">
      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:16px;">
        <button onclick="toggleConf('s')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üì° Network Config <span style="font-size:11px;color:var(--text-muted);">STUN / TURN</span>
          </span>
          <span id="chev-s" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-s">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">Built-in STUN Servers</div>
            <div class="mono glass" style="font-size:10px;line-height:1.8;color:rgba(123,92,246,0.8);padding:12px;border-radius:10px;margin-bottom:16px;">
              stun.l.google.com:19302<br/>stun1.l.google.com:19302<br/>stun.cloudflare.com:3478<br/>stun.mozilla.com<br/>stun.stunprotocol.org:3478<br/>stun.nextcloud.com:443
            </div>
            <div class="label" style="margin-bottom:8px;">TURN Relay (for firewalls)</div>
            <input type="url" id="turn-url-s" placeholder="turn:openrelay.metered.ca:80" style="width:100%;padding:10px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-s" placeholder="username" style="flex:1;padding:10px 12px;"/>
              <input type="text" id="turn-pass-s" placeholder="password" style="flex:1;padding:10px 12px;"/>
            </div>
            <p class="mono" style="font-size:10px;color:var(--text-muted);margin-top:8px;">Free: openrelay.metered.ca ¬∑ relay.expressturn.com:3478</p>
          </div>
        </div>
      </div>

      <!-- Drop Zone -->
      <div id="drop-zone" class="drop-zone glass-card"
        style="padding:40px;text-align:center;border-radius:20px;margin-bottom:16px;"
        onclick="pickFiles()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="float-icon" style="display:inline-block;margin-bottom:16px;font-size:40px;">üìÑ</div>
        <div style="font-size:16px;font-weight:600;margin-bottom:6px;">Drop files or click to browse</div>
        <div style="font-size:13px;color:var(--text-muted);">Any type ¬∑ Any size ¬∑ Multi-file auto-zipped</div>
        <input type="file" id="file-fallback" multiple style="display:none;" onchange="onFileInput(this.files)"/>
      </div>

      <!-- File list -->
      <div id="files-panel" style="display:none;" class="glass-card">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 16px 0;">
          <div style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;">
            üì¶ <span id="files-count-lbl">0 files</span>
          </div>
          <span class="mono" id="files-size-lbl" style="font-size:11px;color:var(--text-muted);"></span>
        </div>
        <div id="files-list" style="padding:12px 16px 16px;max-height:140px;overflow-y:auto;"></div>
      </div>

      <div style="margin-top:16px;">
        <button id="btn-start" onclick="startSenderSession()" disabled class="btn-primary"
          style="width:100%;padding:16px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
          üöÄ Generate Code &amp; Start Session
        </button>
      </div>
    </div>

    <!-- SEND STEP 2: show code, wait for receiver -->
    <div id="s-step-2" style="display:none;">
      <div class="glass-card" style="padding:28px;text-align:center;margin-bottom:16px;">
        <div class="label" style="margin-bottom:16px;">üì∂ Share this code with the receiver</div>
        <div class="code-boxes" id="code-display"></div>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:16px;">
          <button onclick="copyCode()" class="btn-ghost" style="padding:8px 16px;font-size:12px;">üìã Copy Code</button>
          <span class="mono" style="font-size:11px;color:var(--text-muted);">Expires when you leave</span>
        </div>
      </div>

      <div class="glass-card" style="padding:20px;margin-bottom:16px;text-align:center;">
        <div class="label" style="margin-bottom:12px;">üî≤ QR Code (scan on mobile)</div>
        <div id="qr-sender" style="display:flex;justify-content:center;"></div>
        <p style="font-size:10px;color:var(--text-muted);margin-top:10px;">Receiver scans ‚Üí opens app ‚Üí enters code automatically</p>
      </div>

      <div class="glass-card" style="padding:32px;text-align:center;">
        <div class="pulse-wrap" style="width:64px;height:64px;margin:0 auto 20px;position:relative;">
          <div class="pulse-ring-el" style="background:rgba(123,92,246,0.15);inset:0;position:absolute;border-radius:50%;"></div>
          <div class="pulse-core" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
            background:rgba(123,92,246,0.2);border:1px solid rgba(123,92,246,0.3);position:relative;z-index:1;font-size:18px;">üì∂</div>
        </div>
        <div style="font-size:15px;font-weight:600;margin-bottom:6px;">Waiting for receiver...</div>
        <div style="font-size:13px;color:var(--text-muted);">They enter the code ‚Üí connection establishes automatically</div>
      </div>
    </div>

    <!-- SEND STEP 3: transfer progress -->
    <div id="s-step-3" style="display:none;">
      <div id="sender-progress-area"></div>
    </div>
  </div><!-- /screen-send -->

  <!-- ‚ïê‚ïê‚ïê‚ïê RECEIVE ‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-receive" class="screen">
    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:24px;">
      <button onclick="goHome()" class="btn-ghost" style="padding:8px 14px;">‚Üê Back</button>
      <div>
        <div style="font-size:17px;font-weight:700;">Receive Files</div>
        <div style="font-size:11px;color:var(--text-muted);">Enter the sender's 6-char code</div>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:6px;">
        <div class="step-dot active" id="rdot-1"></div>
        <div class="step-dot" id="rdot-2"></div>
      </div>
    </div>

    <!-- RECEIVE STEP 1: code input -->
    <div id="r-step-1">
      <!-- Network Config -->
      <div class="glass-card" style="padding:0;overflow:hidden;margin-bottom:16px;">
        <button onclick="toggleConf('r')" style="width:100%;display:flex;align-items:center;justify-content:space-between;
          padding:14px 16px;cursor:pointer;background:transparent;border:none;color:#fff;">
          <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.65);">
            üì° Network Config <span style="font-size:11px;color:var(--text-muted);">optional TURN relay</span>
          </span>
          <span id="chev-r" style="transition:transform 0.3s;font-size:12px;color:var(--text-muted);">‚ñº</span>
        </button>
        <div class="config-content" id="conf-r">
          <div style="padding:0 16px 16px;">
            <div class="label" style="margin-bottom:8px;">TURN Relay</div>
            <input type="url" id="turn-url-r" placeholder="turn:openrelay.metered.ca:80" style="width:100%;padding:10px 12px;margin-bottom:8px;"/>
            <div style="display:flex;gap:8px;">
              <input type="text" id="turn-user-r" placeholder="username" style="flex:1;padding:10px 12px;"/>
              <input type="text" id="turn-pass-r" placeholder="password" style="flex:1;padding:10px 12px;"/>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-card" style="padding:24px;margin-bottom:16px;">
        <div class="label" style="margin-bottom:16px;text-align:center;">Enter the sender's code</div>
        <input type="text" id="code-input" class="code-input-field" maxlength="6"
          placeholder="‚óè ‚óè ‚óè ‚óè ‚óè ‚óè"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');checkCodeReady()"
          onkeydown="if(event.key==='Enter')connectToSender()"/>
        <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:12px;">6 letters and numbers, no spaces</p>
      </div>

      <button id="btn-connect" onclick="connectToSender()" disabled class="btn-primary"
        style="width:100%;padding:16px 24px;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
        üîó Connect &amp; Receive
      </button>
    </div>

    <!-- RECEIVE STEP 2: transfer progress -->
    <div id="r-step-2" style="display:none;">
      <div id="recv-progress-area"></div>
    </div>
  </div><!-- /screen-receive -->

</main>

<!-- TOAST -->
<div id="toast" style="display:none;position:fixed;z-index:9999;bottom:24px;left:50%;transform:translateX(-50%);
  background:rgba(10,12,28,0.9);border:1px solid rgba(255,255,255,0.1);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  padding:12px 18px;border-radius:14px;
  align-items:center;gap:10px;min-width:220px;max-width:400px;white-space:nowrap;">
  <span id="toast-icon-el" style="font-size:16px;"></span>
  <span id="toast-msg" style="font-size:13px;font-weight:500;"></span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"
  onerror="console.warn('[GS] QRCode CDN failed')"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"
  onerror="console.warn('[GS] JSZip CDN failed')"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js" crossorigin="anonymous"
  onerror="console.warn('[GS] PeerJS CDN failed')"></script>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEBUG LOGGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _t0 = performance.now();
function dbg(sec,msg,data){
  const ts=((performance.now()-_t0)/1000).toFixed(3);
  data!==undefined
    ?console.log(`[GS:${sec}] +${ts}s`,msg,data)
    :console.log(`[GS:${sec}] +${ts}s`,msg);
}
function dbgWarn(sec,msg,data){const ts=((performance.now()-_t0)/1000).toFixed(3);console.warn(`[GS:${sec}] ‚ö† +${ts}s`,msg,data||'');}
function dbgErr(sec,msg,e){const ts=((performance.now()-_t0)/1000).toFixed(3);console.error(`[GS:${sec}] ‚úñ +${ts}s`,msg,e||'');}

dbg('BOOT','‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GhostShare v3 initializing ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
/**
 * CHUNK_SIZE: Files are split into 64KB pieces.
 * - Below WebRTC DataChannel browser limits (~64‚Äì256KB depending on browser)
 * - Small enough for low RAM usage; reading one chunk at a time = O(1) memory
 */
const CHUNK_SIZE = 64 * 1024; // 64 KB

/**
 * BACKPRESSURE thresholds:
 *  HIGH_WATER_MARK: pause sending when DC buffer exceeds 8MB
 *  LOW_WATER_MARK:  resume when buffer drains to 1MB
 *
 * Larger window = more pipeline fill = higher throughput on fast links.
 * If browser crashes, reduce HIGH_WATER_MARK.
 */
const HIGH_WATER = 8 * 1024 * 1024;   // 8 MB ‚Äî aggressive for maximum speed
const LOW_WATER  = 1 * 1024 * 1024;   // 1 MB

/**
 * STUN_SERVERS: Help discover public IP/ports via ICE.
 * 6 servers from 4 providers for maximum reliability.
 */
const STUN_SERVERS = [
  { urls:'stun:stun.l.google.com:19302' },
  { urls:'stun:stun1.l.google.com:19302' },
  { urls:'stun:stun.cloudflare.com:3478' },
  { urls:'stun:stun.mozilla.com' },
  { urls:'stun:stun.stunprotocol.org:3478' },
  { urls:'stun:stun.nextcloud.com:443' },
];

dbg('CONFIG',`CHUNK_SIZE=${CHUNK_SIZE/1024}KB HIGH_WATER=${HIGH_WATER/1024/1024}MB LOW_WATER=${LOW_WATER/1024}KB`);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer        = null;   // PeerJS Peer
let conn        = null;   // PeerJS DataConnection
let isSender    = false;

// File state
let selectedFiles = [];
let transferBlob  = null; // final blob to send (single or zip)
let totalBytes    = 0;
let sentBytes     = 0;
let recvBytes     = 0;
let xferStart     = 0;

// Speed measurement
let lastPerfTime  = 0;
let lastPerfBytes = 0;
let speedWindow   = [];  // rolling samples (bytes/s)
let speedHistory  = [];  // for bar chart

// Receive state
let inMeta        = null;   // {name,size,mime,chunks}
let inChunks      = [];     // ArrayBuffer[] accumulated

// Pause state
let isPaused      = false;
let pauseResolve  = null;

// Hash state (Merkle)
let senderChunkHashes = [];
let recvChunkHashes   = [];

// Timers
let elapsedTimer  = null;

// PeerJS peer code
let myCode        = null;

dbg('STATE','All state variables initialized');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Generate a 6-character code using an alphabet that avoids
 * ambiguous chars (0/O, 1/I) for easy verbal/visual sharing.
 */
function genCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // 32 chars ‚Üí 32^6 ‚âà 1B combos
  const bytes=new Uint8Array(6);
  crypto.getRandomValues(bytes);
  return Array.from(bytes).map(b=>chars[b%chars.length]).join('');
}

function bufToHex(buf){
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/**
 * MERKLE HASH:
 * Compute a file fingerprint by:
 *   1. Hashing each 64KB chunk individually (SHA-256)
 *   2. Concatenating all chunk hashes
 *   3. SHA-256 of that concatenation = the file's Merkle root
 *
 * WHY NOT SHA-256 OF THE WHOLE FILE?
 *   For large files (>1GB), loading the entire file into RAM for
 *   crypto.subtle.digest() would crash the tab. Merkle hashing
 *   uses O(1) memory: only one chunk is in RAM at a time.
 *
 * WHY IS THIS STILL SECURE?
 *   If any byte changes in any chunk, that chunk's hash changes,
 *   which changes the final Merkle root. A collision is as hard
 *   as breaking SHA-256.
 */
async function computeMerkleHash(chunkHashList){
  if(!chunkHashList.length) return 'empty';
  const combined=new Uint8Array(chunkHashList.length*32);
  chunkHashList.forEach((h,i)=>combined.set(h,i*32));
  const final=await crypto.subtle.digest('SHA-256',combined);
  return bufToHex(final);
}

function fmtBytes(b){
  if(!b||b===0) return '0 B';
  const u=['B','KB','MB','GB','TB'];
  const i=Math.floor(Math.log(b)/Math.log(1024));
  return `${(b/Math.pow(1024,i)).toFixed(i>0?1:0)} ${u[i]}`;
}

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function fileEmoji(name){
  const ext=(name.split('.').pop()||'').toLowerCase();
  return ({pdf:'üìÑ',doc:'üìù',docx:'üìù',txt:'üìù',md:'üìù',
           jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',webp:'üñº',svg:'üñº',
           mp4:'üé¨',mov:'üé¨',mkv:'üé¨',avi:'üé¨',webm:'üé¨',
           mp3:'üéµ',wav:'üéµ',flac:'üéµ',aac:'üéµ',
           zip:'üì¶',tar:'üì¶',gz:'üì¶',rar:'üì¶','7z':'üì¶',
           js:'üíª',ts:'üíª',py:'üíª',html:'üíª',css:'üíª',json:'üíª',
           xlsx:'üìä',csv:'üìä',exe:'‚öô',dmg:'‚öô'}[ext]||'üìÑ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DOM HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function $(id){
  const el=document.getElementById(id);
  if(!el) dbgWarn('DOM',`getElementById("${id}") is null`);
  return el;
}
function show(id){const e=$(id);if(e){e.style.display='';}}
function hide(id){const e=$(id);if(e){e.style.display='none';}}
function showFlex(id){const e=$(id);if(e){e.style.display='flex';}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const t=$(id);
  if(t) t.classList.add('active');
}
function goHome(){
  dbg('NAV','goHome()');
  cleanup();
  showScreen('screen-landing');
  hide('conn-badge');
}
function initSend(){
  dbg('NAV','initSend()');
  isSender=true;
  showScreen('screen-send');
  resetSendUI();
}
function initReceive(){
  dbg('NAV','initReceive()');
  isSender=false;
  showScreen('screen-receive');
  resetReceiveUI();
}
function resetSendUI(){
  show('s-step-1');hide('s-step-2');hide('s-step-3');
  setStepDots(['sdot-1','sdot-2','sdot-3'],0);
  const btn=$('btn-start');if(btn) btn.disabled=true;
  hide('files-panel');
  const fl=$('files-list');if(fl) fl.innerHTML='';
  selectedFiles=[];
}
function resetReceiveUI(){
  show('r-step-1');hide('r-step-2');
  setStepDots(['rdot-1','rdot-2'],0);
  const inp=$('code-input');if(inp){inp.value='';checkCodeReady();}
}
function setStepDots(ids,activeIdx){
  ids.forEach((id,i)=>{
    const el=$(id);if(!el) return;
    el.classList.toggle('active',i===activeIdx);
  });
}
function showSendStep(n){
  hide('s-step-1');hide('s-step-2');hide('s-step-3');
  show(`s-step-${n}`);
  setStepDots(['sdot-1','sdot-2','sdot-3'],n-1);
}
function showReceiveStep(n){
  hide('r-step-1');hide('r-step-2');
  show(`r-step-${n}`);
  setStepDots(['rdot-1','rdot-2'],n-1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NETWORK CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleConf(side){
  const panel=$(`conf-${side}`);
  const chev=$(`chev-${side}`);
  if(!panel) return;
  const open=panel.classList.toggle('open');
  if(chev) chev.style.transform=open?'rotate(180deg)':'';
}

function buildIceConfig(side){
  const iceServers=[...STUN_SERVERS];
  const url=($(`turn-url-${side}`)?.value||'').trim();
  const user=($(`turn-user-${side}`)?.value||'').trim();
  const pass=($(`turn-pass-${side}`)?.value||'').trim();
  if(url){
    dbg('ICE',`User TURN: ${url}`);
    iceServers.push({urls:url,username:user||undefined,credential:pass||undefined});
  }
  return {iceServers,iceCandidatePoolSize:10};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function pickFiles(){
  dbg('FILES','pickFiles()');
  if('showOpenFilePicker' in window){
    try{
      const handles=await window.showOpenFilePicker({multiple:true});
      selectedFiles=await Promise.all(handles.map(h=>h.getFile()));
      dbg('FILES',`FSA: ${selectedFiles.length} files`);
      renderFileList(selectedFiles);
    }catch(e){
      if(e.name!=='AbortError'){
        dbgWarn('FILES','FSA threw, fallback:',e.message);
        $('file-fallback').click();
      }
    }
  }else{
    $('file-fallback').click();
  }
}
function onFileInput(fileList){
  selectedFiles=Array.from(fileList);
  dbg('FILES',`<input>: ${selectedFiles.length} files`);
  renderFileList(selectedFiles);
}
function onDragOver(e){e.preventDefault();$('drop-zone')?.classList.add('drag-active');}
function onDragLeave(e){$('drop-zone')?.classList.remove('drag-active');}
function onDrop(e){
  e.preventDefault();
  $('drop-zone')?.classList.remove('drag-active');
  selectedFiles=Array.from(e.dataTransfer.files);
  if(selectedFiles.length) renderFileList(selectedFiles);
}
function renderFileList(files){
  if(!files.length) return;
  const total=files.reduce((s,f)=>s+f.size,0);
  const cl=$('files-count-lbl'),sl=$('files-size-lbl'),ll=$('files-list'),pl=$('files-panel'),btn=$('btn-start');
  if(cl) cl.textContent=`${files.length} file${files.length>1?'s':''}`;
  if(sl) sl.textContent=fmtBytes(total);
  if(ll) ll.innerHTML=files.map(f=>`
    <div style="display:flex;align-items:center;gap:8px;font-size:12px;padding:3px 0;">
      <span>${fileEmoji(f.name)}</span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,0.65);">${escHtml(f.name)}</span>
      <span class="mono" style="color:var(--text-muted);">${fmtBytes(f.size)}</span>
    </div>`).join('');
  if(pl) pl.style.display='block';
  if(btn) btn.disabled=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE DISPLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function displayCode(code){
  dbg('UI',`displayCode("${code}")`);
  myCode=code;
  const el=$('code-display');
  if(!el) return;
  el.innerHTML=code.split('').map(ch=>
    `<div class="code-box">${ch}</div>`
  ).join('');

  // Generate QR with the receiver URL (if we can) or just the code
  const qrText=code; // just the code; receiver types it in
  genQR('qr-sender',qrText,'#7B5CF6');
}
function copyCode(){
  if(!myCode) return;
  navigator.clipboard?.writeText(myCode).then(()=>showToast('Code copied!','‚úÖ','green'))
    .catch(()=>{showToast('Code: '+myCode,'üìã','violet');});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE INPUT CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkCodeReady(){
  const v=($('code-input')?.value||'').trim();
  const btn=$('btn-connect');
  if(btn) btn.disabled=v.length!==6;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS ‚Äî SENDER
//
//  HOW THE SHORT-CODE SYSTEM WORKS:
//
//  1. Sender generates a random 6-char code (e.g. "A1B2C3").
//  2. Sender creates a PeerJS Peer with THIS CODE as its peer ID.
//     PeerJS connects to a free public signaling server (peerjs.com)
//     which registers the peer ID and relays SDP/ICE automatically.
//  3. The entire SDP/ICE exchange happens silently through PeerJS.
//     NO manual copy-paste needed!
//  4. Receiver creates a PeerJS Peer and calls peer.connect("A1B2C3").
//  5. PeerJS broker routes the offer/answer, connection opens.
//  6. After connection: we grab the raw DataChannel for transfers.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startSenderSession(){
  dbg('PEER','startSenderSession()');
  if(!selectedFiles.length){showToast('Select files first','‚ö†Ô∏è','red');return;}

  const btn=$('btn-start');
  if(btn){btn.disabled=true;btn.textContent='Connecting...';}

  // Build blob (zip if multiple files)
  showToast('Preparing files...','üì¶','violet');
  try{
    transferBlob=await buildBlob(selectedFiles);
  }catch(e){
    dbgErr('BLOB','buildBlob failed:',e);
    showToast('Failed to prepare files','‚ùå','red');
    if(btn){btn.disabled=false;btn.innerHTML='üöÄ Generate Code &amp; Start Session';}
    return;
  }

  totalBytes=transferBlob.size;
  dbg('PEER',`blob ready: ${fmtBytes(totalBytes)}`);

  const code=genCode();
  const iceCfg=buildIceConfig('s');
  dbg('PEER',`Creating peer with code="${code}"`);

  peer=new Peer(code,{
    config:iceCfg,
    debug:0,
  });

  peer.on('open',id=>{
    dbg('PEER',`Sender peer open, ID="${id}"`);
    displayCode(id);
    showSendStep(2);
    showToast(`Code: ${id} ‚Äî share it!`,'üì°','violet');
  });

  peer.on('connection',c=>{
    dbg('PEER','Receiver connected!');
    conn=c;
    /**
     * Serialization is negotiated by the INITIATOR (receiver).
     * When receiver calls peer.connect(code, {serialization:'raw'}),
     * PeerJS sends metadata telling the host to also use raw mode.
     * We set it here as a safety measure in case the metadata arrives
     * before or after the 'connection' event.
     */
    conn.serialization='raw';

    conn.on('open',()=>{
      dbg('PEER','DataConnection open ‚Äî starting transfer');
      showFlex('conn-badge');
      $('conn-badge').style.background='rgba(34,197,94,0.1)';
      $('conn-badge').style.border='1px solid rgba(34,197,94,0.25)';

      showSendStep(3);
      setupSenderDC();
      beginTransfer();
    });

    conn.on('error',e=>dbgErr('CONN','conn error:',e));

    conn.on('close',()=>{
      dbgWarn('CONN','Connection closed');
      onDisconnect();
    });
  });

  peer.on('error',e=>{
    dbgErr('PEER','Peer error:',e);
    if(e.type==='unavailable-id'){
      dbg('PEER','ID taken, generating new code');
      peer.destroy();
      peer=null;
      startSenderSession(); // retry with new code
    }else if(e.type==='server-error'||e.type==='network'){
      showToast('PeerJS server unreachable ‚Äî check internet','‚ùå','red');
      if(btn){btn.disabled=false;btn.innerHTML='üöÄ Generate Code &amp; Start Session';}
    }else{
      showToast(`Peer error: ${e.type}`,'‚ùå','red');
    }
  });
}

function setupSenderDC(){
  /**
   * We listen for control messages coming BACK from the receiver
   * (VERIFY confirmation, pause/resume requests) via conn.on('data').
   * The conn.on('data') handler fires for strings received on the DC.
   */
  conn.on('data',data=>{
    if(typeof data==='string'){
      try{
        const msg=JSON.parse(data);
        handleSenderMessage(msg);
      }catch(e){dbgWarn('RECV','Bad JSON from receiver',e);}
    }
  });
}

function handleSenderMessage(msg){
  dbg('CTRL',`Sender got msg type="${msg.type}"`);
  if(msg.type==='verify'){
    const ok=msg.ok;
    const hashEl=$('hash-status');
    const verifyEl=$('verify-status');
    if(hashEl){
      hashEl.className=ok?'hash-ok':'hash-fail';
      hashEl.innerHTML=ok
        ?'<span style="color:#22c55e;font-weight:600;">‚úì Receiver verified file integrity (SHA-256 match)</span>'
        :'<span style="color:#ef4444;font-weight:600;">‚úó Hash mismatch ‚Äî receiver may have corrupt file!</span>';
    }
    if(verifyEl){
      verifyEl.innerHTML=ok
        ?'<div style="font-size:13px;color:#22c55e;font-weight:600;text-align:center;padding:12px;">‚úÖ Transfer confirmed ‚Äî receiver got every byte</div>'
        :'<div style="font-size:13px;color:#ef4444;font-weight:600;text-align:center;padding:12px;">‚ö† Integrity check failed ‚Äî ask receiver to retry</div>';
    }
    showToast(ok?'Transfer verified ‚úì':'Hash mismatch!',ok?'‚úÖ':'‚ùå',ok?'green':'red');
  }else if(msg.type==='pause'){
    dbg('CTRL','Remote pause request');
    isPaused=true;
    updatePauseUI(true,'remote');
  }else if(msg.type==='resume'){
    dbg('CTRL','Remote resume request');
    doResume();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS ‚Äî RECEIVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectToSender(){
  const code=($('code-input')?.value||'').trim().toUpperCase();
  dbg('PEER',`connectToSender() code="${code}"`);
  if(code.length!==6){showToast('Enter a 6-character code','‚ö†Ô∏è','red');return;}

  const btn=$('btn-connect');
  if(btn){btn.disabled=true;btn.textContent='Connecting...';}

  const iceCfg=buildIceConfig('r');

  peer=new Peer({
    config:iceCfg,
    debug:0,
  });

  peer.on('open',myId=>{
    dbg('PEER',`Receiver peer open, myId="${myId}" ‚Äî connecting to "${code}"`);
    conn=peer.connect(code,{
      reliable:true,
      serialization:'raw', // pass data through without PeerJS wrapping
    });

    conn.on('open',()=>{
      dbg('PEER','Connected to sender!');
      showFlex('conn-badge');
      $('conn-badge').style.background='rgba(6,182,212,0.1)';
      $('conn-badge').style.border='1px solid rgba(6,182,212,0.3)';
      const labelEl=$('conn-label');
      if(labelEl){labelEl.textContent='Connected';labelEl.style.color='#06B6D4';}

      showReceiveStep(2);
      renderReceiveWaiting();
      setupReceiverDC();
    });

    conn.on('error',e=>{
      dbgErr('CONN','Receive conn error:',e);
      showToast('Connection failed ‚Äî check code and try again','‚ùå','red');
      if(btn){btn.disabled=false;btn.textContent='üîó Connect & Receive';}
    });

    conn.on('close',()=>{
      dbgWarn('CONN','Receiver connection closed');
      onDisconnect();
    });
  });

  peer.on('error',e=>{
    dbgErr('PEER','Receiver peer error:',e);
    if(e.type==='peer-unavailable'){
      showToast(`Code "${code}" not found ‚Äî check code and try again`,'‚ùå','red');
    }else if(e.type==='server-error'||e.type==='network'){
      showToast('PeerJS server unreachable ‚Äî check internet','‚ùå','red');
    }else{
      showToast(`Error: ${e.type}`,'‚ùå','red');
    }
    if(btn){btn.disabled=false;btn.textContent='üîó Connect & Receive';}
  });
}

function setupReceiverDC(){
  conn.on('data',data=>handleIncoming(data));
  dbg('RECV','Receiver DC handler attached');
}

function renderReceiveWaiting(){
  const el=$('recv-progress-area');
  if(el) el.innerHTML=`
    <div class="glass-card" style="padding:32px;text-align:center;">
      <div class="pulse-wrap" style="width:64px;height:64px;margin:0 auto 20px;position:relative;">
        <div class="pulse-ring-el" style="background:rgba(6,182,212,0.15);inset:0;position:absolute;border-radius:50%;"></div>
        <div class="pulse-core" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
          background:rgba(6,182,212,0.2);border:1px solid rgba(6,182,212,0.3);position:relative;z-index:1;font-size:18px;">üì°</div>
      </div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px;">Connected ‚Äî waiting for file...</div>
      <div style="font-size:13px;color:var(--text-muted);">Sender will start the transfer momentarily</div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILD BLOB (zip multiple files)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buildBlob(files){
  if(files.length===1){
    dbg('BLOB','Single file ‚Äî no zip needed');
    return {blob:files[0],name:files[0].name};
  }
  dbg('BLOB',`${files.length} files ‚Üí JSZip`);
  if(typeof JSZip==='undefined') throw new Error('JSZip not loaded');
  const zip=new JSZip();
  for(const f of files) zip.file(f.name,f,{binary:true});
  const blob=await zip.generateAsync(
    {type:'blob',compression:'DEFLATE',compressionOptions:{level:3}},
    meta=>{if(meta.percent%25<2) dbg('ZIP',`${meta.percent.toFixed(0)}%`);}
  );
  return {blob,name:`ghost-share-${Date.now()}.zip`};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRANSFER ENGINE ‚Äî SENDING
//
//  CHUNKING EXPLAINED:
//
//  A file (or zip blob) is split into 64KB slices.
//  For each slice:
//    1. HASH PHASE: blob.slice(offset, end) creates a lazy view.
//       slice.arrayBuffer() reads exactly those bytes into RAM.
//       We feed the buffer to SHA-256 to build the Merkle hash.
//    2. SEND PHASE: dc.send(buffer) queues raw binary into the
//       DTLS-encrypted DataChannel. WebRTC SCTP guarantees delivery
//       and ordering ‚Äî no manual retransmit needed.
//    3. BACKPRESSURE: if dc.bufferedAmount > 8MB, we stop sending
//       and wait for the 'bufferedamountlow' event (fires at 1MB).
//       This prevents browser OOM on large files and maximizes
//       throughput by keeping the send buffer perfectly saturated.
//    4. PAUSE: if user pressed Pause, we await a Promise that
//       resolves when Resume is clicked.
//
//  After all chunks: send {type:'done', hash:merkleRoot} to receiver.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function beginTransfer(){
  dbg('XFER','‚ïê‚ïê‚ïê‚ïê beginTransfer() START ‚ïê‚ïê‚ïê‚ïê');
  let blobResult;
  if(transferBlob){
    // Already built in startSenderSession
    blobResult=transferBlob;
  }else{
    blobResult=await buildBlob(selectedFiles);
  }
  const {blob,name}=typeof blobResult==='object'&&blobResult.blob
    ? blobResult
    : {blob:blobResult,name:selectedFiles[0]?.name||'file'};

  totalBytes=blob.size;
  sentBytes=0;
  xferStart=performance.now();
  lastPerfTime=xferStart;
  lastPerfBytes=0;
  speedWindow=[];
  speedHistory=[];
  senderChunkHashes=[];
  isPaused=false;

  const totalChunks=Math.ceil(totalBytes/CHUNK_SIZE);
  dbg('XFER',`"${name}" ${fmtBytes(totalBytes)} ${totalChunks} chunks`);

  // ‚îÄ‚îÄ SEND META ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // The META message tells the receiver: filename, total size, MIME,
  // chunk count. Receiver uses this to init its progress UI.
  // We do NOT include the hash here ‚Äî it's computed during sending
  // and sent in the DONE message. This way hashing is free (piggybacks
  // on the chunk reads already needed for sending).
  const meta={type:'meta',name,size:totalBytes,mime:blob.type||'application/octet-stream',chunks:totalChunks};
  dbg('XFER','Sending META:',meta);
  conn.send(JSON.stringify(meta));

  renderProgressUI('sender-progress-area',name,true);

  // Set backpressure threshold on the underlying RTCDataChannel.
  // PeerJS stores it as conn._dc (private but stable across 1.x versions).
  // bufferedAmountLowThreshold: fires 'bufferedamountlow' event when
  // the send buffer drains from HIGH_WATER down to this level.
  const rawDC=conn._dc||conn.dataChannel;
  if(rawDC){
    rawDC.bufferedAmountLowThreshold=LOW_WATER;
    dbg('XFER',`bufferedAmountLowThreshold=${fmtBytes(LOW_WATER)}`);
  }

  // ‚îÄ‚îÄ CHUNK LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let offset=0;
  let chunkIdx=0;

  while(offset<totalBytes){

    // ‚îÄ‚îÄ PAUSE GATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(isPaused){
      dbg('XFER',`PAUSED at chunk ${chunkIdx}, offset ${fmtBytes(offset)}`);
      await new Promise(resolve=>{pauseResolve=resolve;});
      dbg('XFER','RESUMED');
    }

    // ‚îÄ‚îÄ BACKPRESSURE GATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // dc.bufferedAmount = bytes sitting in the OS TCP send buffer.
    // If this grows past HIGH_WATER (8MB), we'd risk OOM on the
    // browser tab. We pause and wait for 'bufferedamountlow' (1MB).
    const dc=conn._dc||conn.dataChannel;
    if(dc&&dc.bufferedAmount>HIGH_WATER){
      dbgWarn('XFER',`BACKPRESSURE: ${fmtBytes(dc.bufferedAmount)} ‚Üí waiting`);
      await new Promise(resolve=>{
        if(!dc) return resolve();
        const handler=()=>{dc.removeEventListener('bufferedamountlow',handler);resolve();};
        dc.addEventListener('bufferedamountlow',handler);
        // Safety timeout 10s ‚Äî in case event never fires
        setTimeout(()=>{dc.removeEventListener('bufferedamountlow',handler);resolve();},10000);
      });
      dbg('XFER',`BACKPRESSURE: resumed, buffered=${fmtBytes(dc?.bufferedAmount||0)}`);
    }

    // ‚îÄ‚îÄ READ CHUNK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const end=Math.min(offset+CHUNK_SIZE,totalBytes);
    const slice=blob.slice(offset,end);
    const buffer=await slice.arrayBuffer(); // reads exactly those bytes

    // ‚îÄ‚îÄ HASH CHUNK (concurrent with network I/O) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // conn.send() is synchronous ‚Äî it queues data immediately.
    // crypto.subtle.digest() is async but runs in the SAME microtask
    // queue, so hash computation overlaps with the kernel sending data.
    conn.send(buffer); // send raw ArrayBuffer ‚Üí DTLS encrypts it
    const chunkHash=await crypto.subtle.digest('SHA-256',buffer);
    senderChunkHashes.push(new Uint8Array(chunkHash));

    offset+=buffer.byteLength;
    sentBytes=offset;
    chunkIdx++;

    if(chunkIdx%64===0||offset>=totalBytes){
      dbg('XFER',`Chunk ${chunkIdx}/${totalChunks} | ${fmtBytes(sentBytes)}/${fmtBytes(totalBytes)}`);
    }

    tickSpeed(sentBytes);
    updateRing(sentBytes/totalBytes);
  }

  // ‚îÄ‚îÄ COMPUTE FINAL MERKLE HASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  dbg('XFER','Computing Merkle root...');
  const fileHash=await computeMerkleHash(senderChunkHashes);
  dbg('XFER',`Merkle root: ${fileHash.substring(0,16)}...`);

  // ‚îÄ‚îÄ DONE MESSAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Includes the Merkle hash so receiver can verify integrity.
  conn.send(JSON.stringify({type:'done',hash:fileHash}));
  dbg('XFER','DONE signal sent');

  showToast('Transfer complete ‚Äî awaiting verification','‚åõ','violet');
  finishUI(false);
  dbg('XFER','‚ïê‚ïê‚ïê‚ïê beginTransfer() DONE ‚ïê‚ïê‚ïê‚ïê');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRANSFER ENGINE ‚Äî RECEIVING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleIncoming(data){
  if(typeof data==='string'){
    let msg;
    try{msg=JSON.parse(data);}
    catch(e){dbgWarn('RECV','Bad JSON:',e);return;}

    if(msg.type==='meta'){
      dbg('RECV','‚ïê‚ïê‚ïê‚ïê META ‚ïê‚ïê‚ïê‚ïê',msg);
      inMeta=msg;
      inChunks=[];
      recvChunkHashes=[];
      recvBytes=0;
      totalBytes=msg.size;
      xferStart=performance.now();
      lastPerfTime=xferStart;
      lastPerfBytes=0;
      speedWindow=[];
      speedHistory=[];
      isPaused=false;
      renderProgressUI('recv-progress-area',msg.name,false);
    }

    if(msg.type==='done'){
      dbg('RECV','‚ïê‚ïê‚ïê‚ïê DONE ‚ïê‚ïê‚ïê‚ïê hash=',msg.hash?.substring(0,16));
      assembleAndDownload(msg.hash);
    }

    if(msg.type==='pause'){
      dbg('RECV','Sender paused');
      const statusEl=$('xfer-status');
      if(statusEl){statusEl.textContent='‚è∏ Sender paused';statusEl.style.color='#eab308';}
    }

    if(msg.type==='resume'){
      dbg('RECV','Sender resumed');
      const statusEl=$('xfer-status');
      if(statusEl){statusEl.textContent='Receiving...';statusEl.style.color='var(--text-muted)';}
    }

  }else if(data instanceof ArrayBuffer||data instanceof Uint8Array){
    const buf=data instanceof Uint8Array?data.buffer:data;
    inChunks.push(buf);
    recvBytes+=buf.byteLength;
    // Hash chunk for Merkle verification ‚Äî stored by chunk index
    // to guarantee ordering even if Promise callbacks interleave
    const chunkIdx=inChunks.length-1;
    crypto.subtle.digest('SHA-256',buf).then(h=>{
      recvChunkHashes[chunkIdx]=new Uint8Array(h);
    });

    if(inChunks.length%64===0){
      dbg('RECV',`Chunk #${inChunks.length} | ${fmtBytes(recvBytes)}/${fmtBytes(totalBytes)}`);
    }
    tickSpeed(recvBytes);
    updateRing(recvBytes/totalBytes);
  }else{
    dbgWarn('RECV',`Unknown data type: ${typeof data}`);
  }
}

async function assembleAndDownload(expectedHash){
  dbg('RECV',`assembleAndDownload() expectedHash=${expectedHash?.substring(0,16)}`);

  // ‚îÄ‚îÄ WAIT FOR ALL CHUNK HASHES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Chunk hash computations are async; wait until all inChunks.length
  // hashes are in the array. Poll briefly up to 5s.
  const totalChunks=inChunks.length;
  const waitMs=Math.min(5000, totalChunks*2); // ~2ms per chunk
  const deadline=Date.now()+waitMs;
  while(recvChunkHashes.filter(Boolean).length<totalChunks && Date.now()<deadline){
    await new Promise(r=>setTimeout(r,50));
  }
  const ready=recvChunkHashes.filter(Boolean).length;
  dbg('RECV',`Chunk hashes ready: ${ready}/${totalChunks}`);

  const hashEl=$('hash-status');
  if(hashEl){
    hashEl.style.display='block';
    hashEl.className='hash-wait';
    hashEl.innerHTML='<span style="color:#eab308;font-weight:600;">üîê Verifying SHA-256 integrity...</span>';
  }

  let hashOk=false;
  let actualHash='';
  try{
    // Use only the hashes we have (ordered by chunk index)
    const validHashes=recvChunkHashes.slice(0,totalChunks).filter(Boolean);
    actualHash=await computeMerkleHash(validHashes);
    hashOk=(actualHash===expectedHash&&validHashes.length===totalChunks);
    dbg('RECV',`Hash: expected=${expectedHash?.substring(0,16)} actual=${actualHash.substring(0,16)} ok=${hashOk}`);
  }catch(e){
    dbgErr('RECV','Hash verification error:',e);
  }

  // ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const blob=new Blob(inChunks,{type:inMeta?.mime||'application/octet-stream'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=inMeta?.name||'download';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),5000);
  dbg('RECV',`Download triggered: "${inMeta?.name}" ${fmtBytes(blob.size)}`);

  // ‚îÄ‚îÄ UPDATE UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(hashEl){
    hashEl.className=hashOk?'hash-ok':'hash-fail';
    hashEl.innerHTML=hashOk
      ?`<span style="color:#22c55e;font-weight:600;">‚úì SHA-256 verified ‚Äî file is intact</span><br/>
        <span class="mono" style="font-size:10px;color:rgba(255,255,255,0.3);">${actualHash.substring(0,32)}...</span>`
      :`<span style="color:#ef4444;font-weight:600;">‚úó Hash mismatch ‚Äî data may be corrupt</span><br/>
        <span style="font-size:11px;color:var(--text-muted);">Expected: ${expectedHash?.substring(0,16)}... Got: ${actualHash.substring(0,16)}...</span>`;
  }

  // ‚îÄ‚îÄ SEND VERIFY ACK TO SENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(conn){
    conn.send(JSON.stringify({type:'verify',ok:hashOk,hash:actualHash}));
    dbg('RECV',`Sent VERIFY ack ok=${hashOk}`);
  }

  showToast(hashOk?`‚úì ${inMeta?.name} downloaded & verified`:'‚ö† Download done ‚Äî hash mismatch!',
    hashOk?'‚úÖ':'‚ö†Ô∏è', hashOk?'green':'red');

  finishUI(hashOk);
  inChunks=[];
  recvChunkHashes=[];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAUSE / RESUME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pauseTransfer(){
  if(isPaused) return;
  dbg('PAUSE','Pausing transfer');
  isPaused=true;
  updatePauseUI(true,'local');
  if(conn) conn.send(JSON.stringify({type:'pause'}));
}
function resumeTransfer(){
  dbg('PAUSE','Resuming transfer');
  doResume();
  if(conn) conn.send(JSON.stringify({type:'resume'}));
}
function doResume(){
  isPaused=false;
  if(pauseResolve){pauseResolve();pauseResolve=null;}
  updatePauseUI(false,'local');
}
function updatePauseUI(paused,source){
  const btn=$('pause-btn');
  const statusEl=$('xfer-status');
  if(btn){
    btn.className=paused?'btn-resume':'btn-pause';
    btn.textContent=paused?'‚ñ∂ Resume':'‚è∏ Pause';
    btn.onclick=paused?resumeTransfer:pauseTransfer;
  }
  if(statusEl){
    statusEl.textContent=paused?(source==='remote'?'‚è∏ Paused by receiver':'‚è∏ Paused'):'Transferring...';
    statusEl.style.color=paused?'#eab308':'var(--text-muted)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProgressUI(containerId,filename,showPauseBtn){
  dbg('UI',`renderProgressUI("${containerId}", "${filename}")`);
  const el=$(containerId);
  if(!el){dbgErr('UI',`Container "${containerId}" missing`);return;}
  const circ=(2*Math.PI*44).toFixed(2);

  el.innerHTML=`
    <div class="glass-card" style="padding:20px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
        <!-- Progress Ring -->
        <div id="ring-wrap" style="position:relative;flex-shrink:0;width:104px;height:104px;">
          <svg width="104" height="104" viewBox="0 0 104 104">
            <defs>
              <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%"   stop-color="#7B5CF6"/>
                <stop offset="100%" stop-color="#2563eb"/>
              </linearGradient>
            </defs>
            <circle class="progress-ring-track" cx="52" cy="52" r="44"/>
            <circle id="ring-fill" class="progress-ring-fill" cx="52" cy="52" r="44"
              stroke-dasharray="${circ}" stroke-dashoffset="${circ}"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
            <span id="ring-pct" style="font-size:20px;font-weight:800;letter-spacing:-0.03em;">0%</span>
          </div>
        </div>
        <!-- Stats -->
        <div style="flex:1;min-width:0;">
          <div id="xfer-filename" style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;
            white-space:nowrap;color:rgba(255,255,255,0.75);margin-bottom:6px;">${escHtml(filename)}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div class="conn-dot" style="width:8px;height:8px;border-radius:50%;background:#22c55e;flex-shrink:0;"></div>
            <span id="xfer-status" style="font-size:12px;color:var(--text-muted);">
              ${showPauseBtn?'Transferring...':'Receiving...'}
            </span>
          </div>
          <div style="display:flex;align-items:baseline;gap:6px;">
            <span id="speed-val" style="font-family:'JetBrains Mono';font-size:28px;font-weight:700;color:var(--violet);line-height:1;">0.00</span>
            <span style="font-size:13px;color:var(--text-muted);">MB/s</span>
          </div>
          <div id="bytes-lbl" class="mono" style="font-size:11px;color:var(--text-muted);margin-top:4px;">
            0 B / ${fmtBytes(totalBytes)}
          </div>
        </div>
      </div>

      <!-- Speed bars -->
      <div class="label" style="margin-bottom:8px;">Live Throughput</div>
      <div id="speed-bars" style="display:flex;align-items:flex-end;gap:2px;height:40px;"></div>

      <!-- ETA + elapsed -->
      <div style="display:flex;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--text-muted);">
        <span id="eta-lbl">Calculating...</span>
        <span id="elapsed-lbl">0.0s elapsed</span>
      </div>

      ${showPauseBtn?`
      <!-- Pause/Resume button -->
      <div style="margin-top:16px;text-align:center;">
        <button id="pause-btn" class="btn-pause" style="padding:10px 28px;font-size:13px;"
          onclick="pauseTransfer()">‚è∏ Pause</button>
      </div>`:''}
    </div>

    <!-- Hash status -->
    <div id="hash-status" class="hash-wait" style="margin-bottom:12px;display:none;">
      <span style="color:#eab308;font-weight:600;">üîê Awaiting hash verification...</span>
    </div>

    <!-- Verify status (sender only) -->
    <div id="verify-status" style="margin-bottom:12px;"></div>
  `;

  startElapsedTimer();
  dbg('UI','Progress UI rendered');
}

function startElapsedTimer(){
  clearInterval(elapsedTimer);
  elapsedTimer=setInterval(()=>{
    const el=$('elapsed-lbl');
    if(el) el.textContent=`${((performance.now()-xferStart)/1000).toFixed(1)}s elapsed`;
  },500);
}

function tickSpeed(bytes){
  const now=performance.now();
  const dt=(now-lastPerfTime)/1000;
  if(dt<0.15) return; // throttle
  const rate=(bytes-lastPerfBytes)/dt;
  if(rate<0) return;
  speedWindow.push(rate);
  if(speedWindow.length>10) speedWindow.shift();
  speedHistory.push(rate);
  if(speedHistory.length>28) speedHistory.shift();
  lastPerfTime=now;
  lastPerfBytes=bytes;
  paintSpeed();
}

function paintSpeed(){
  const avg=speedWindow.reduce((a,b)=>a+b,0)/speedWindow.length;
  const mbps=avg/(1024*1024);
  const sv=$('speed-val');if(sv) sv.textContent=mbps.toFixed(2);
  const bytesNow=isSender?sentBytes:recvBytes;
  const bl=$('bytes-lbl');
  if(bl) bl.textContent=`${fmtBytes(bytesNow)} / ${fmtBytes(totalBytes)}`;
  const eta=$('eta-lbl');
  if(eta&&avg>0){
    const rem=totalBytes-bytesNow;
    const secs=rem/avg;
    eta.textContent=secs<60?`~${secs.toFixed(0)}s remaining`:`~${(secs/60).toFixed(1)}m remaining`;
  }
  // Bar chart
  const barsEl=$('speed-bars');
  if(!barsEl) return;
  const arr=speedHistory;
  const maxSpd=Math.max(...arr,1);
  const pad=28-arr.length;
  barsEl.innerHTML=[...Array(pad).fill(0),...arr].map(s=>{
    const f=s/maxSpd;
    const h=Math.max(3,f*38);
    const r=Math.round(73+f*95);
    const g=Math.round(40+f*20);
    const op=(0.3+f*0.7).toFixed(2);
    return `<div class="speed-bar" style="flex:1;height:${h.toFixed(1)}px;background:rgb(${r},${g},246);opacity:${op};"></div>`;
  }).join('');
}

function updateRing(pct){
  const ring=$('ring-fill');
  const pctEl=$('ring-pct');
  if(!ring) return;
  const circ=2*Math.PI*44;
  ring.style.strokeDashoffset=(circ*(1-pct)).toFixed(2);
  const avg=speedWindow.length?speedWindow.reduce((a,b)=>a+b,0)/speedWindow.length:0;
  const mbps=avg/(1024*1024);
  const glowPx=Math.min(3+mbps*1.2,30);
  const glowOp=Math.min(0.4+mbps*0.04,0.95).toFixed(2);
  const wrap=$('ring-wrap');
  if(wrap) wrap.style.filter=`drop-shadow(0 0 ${glowPx.toFixed(1)}px rgba(123,92,246,${glowOp}))`;
  if(pctEl) pctEl.textContent=`${Math.round(pct*100)}%`;
}

function finishUI(hashOk){
  dbg('UI','finishUI()');
  clearInterval(elapsedTimer);
  updateRing(1);
  const s=$('xfer-status');
  if(s){
    s.textContent=isSender?'‚úì Sent':'‚úì Downloaded';
    s.style.color='#22c55e';
  }
  // Show hash status panel
  const hashEl=$('hash-status');
  if(hashEl&&!isSender) hashEl.style.display='block';

  // Disable pause button
  const pbtn=$('pause-btn');
  if(pbtn){pbtn.disabled=true;pbtn.style.opacity='0.4';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QR CODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genQR(containerId,text,color){
  const el=$(containerId);
  if(!el) return;
  el.innerHTML='';
  if(typeof QRCode==='undefined'){
    el.innerHTML='<p style="font-size:11px;color:var(--text-muted);padding:20px;">QR lib failed ‚Äî use copy above</p>';
    return;
  }
  try{
    new QRCode(el,{text,width:180,height:180,colorDark:color||'#7B5CF6',colorLight:'#030610',correctLevel:QRCode.CorrectLevel.M});
  }catch(e){
    el.innerHTML='<p style="font-size:11px;color:var(--text-muted);padding:20px;">QR failed ‚Äî use copy above</p>';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLEANUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cleanup(){
  dbg('CLEANUP','cleanup()');
  clearInterval(elapsedTimer);
  isPaused=false;
  if(pauseResolve){pauseResolve();pauseResolve=null;}
  if(conn){try{conn.close();}catch(e){} conn=null;}
  if(peer){try{peer.destroy();}catch(e){} peer=null;}
  selectedFiles=[];inChunks=[];recvChunkHashes=[];senderChunkHashes=[];
  speedWindow=[];speedHistory=[];
  totalBytes=sentBytes=recvBytes=0;
  inMeta=null;transferBlob=null;myCode=null;
  dbg('CLEANUP','State reset');
}

function onDisconnect(){
  dbgWarn('PEER','onDisconnect()');
  clearInterval(elapsedTimer);
  hide('conn-badge');
  showToast('Connection dropped ‚Äî refresh to retry','üì°','red');
  const s=$('xfer-status');
  if(s){s.textContent='‚ö† Disconnected';s.style.color='#ef4444';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _toastTimer=null;
function showToast(msg,icon,color){
  const toast=$('toast');
  const iconEl=$('toast-icon-el');
  const msgEl=$('toast-msg');
  if(!toast) return;
  if(iconEl) iconEl.textContent=icon||'‚Ñπ';
  if(msgEl) msgEl.textContent=msg;
  toast.style.display='flex';
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>{toast.style.display='none';},4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEPENDENCY CHECK + BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkDependencies(){
  const deps={
    'WebRTC':typeof RTCPeerConnection!=='undefined',
    'PeerJS':typeof Peer!=='undefined',
    'QRCode.js':typeof QRCode!=='undefined',
    'JSZip':typeof JSZip!=='undefined',
    'Web Crypto':typeof crypto?.subtle!=='undefined',
  };
  for(const [n,ok] of Object.entries(deps)){
    dbg('DEPS',`${ok?'‚úî':'‚úò'} ${n}`);
  }
  if(!deps['WebRTC']){showToast('WebRTC not supported in this browser','‚ùå','red');}
  if(!deps['PeerJS']){showToast('PeerJS failed to load ‚Äî check internet','‚ùå','red');}
  if(!deps['Web Crypto']){showToast('Web Crypto API unavailable ‚Äî hash verification disabled','‚ö†Ô∏è','red');}
}

function boot(){
  dbg('BOOT','boot() called');
  checkDependencies();
  showToast('GhostShare v3 ready üëª','üëª','violet');
  dbg('BOOT','‚úÖ Initialized');
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',boot);
}else{
  boot();
}
</script>
</body>
</html>
